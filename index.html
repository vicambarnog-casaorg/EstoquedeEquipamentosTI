<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Sistema de Patrim√¥nio - Completo</title>

  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2lzdGVtYSBkZSBQYXRyaW1vbmkiLCJzaG9ydF9uYW1lIjoiUGF0cmltw6FuaW8iLCJ2ZXJzaW9uIjoiMS4wIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJpY29ucyI6W119">

  <style>
    :root{
      --primary:#667eea;
      --primary-dark:#5568d3;
      --danger:#dc3545;
      --muted:#888;
      --bg:#f3f6fb;
      --card:#ffffff;
      --success:#d4edda;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),#fff);
      padding:20px;
      min-height:100vh;
    }
    .app{
      max-width:1200px;margin:0 auto;background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 18px 40px rgba(23,30,60,0.08)
    }
    header{background:linear-gradient(90deg,var(--primary),#764ba2);color:#fff;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.12)}
    .btn-logout{background:rgba(255,255,255,0.12);color:#fff}
    .btn-sync{background:rgba(255,255,255,0.15);color:#fff}
    main{padding:20px;display:grid;grid-template-columns:380px 1fr;gap:18px}
    .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(18,24,40,0.04)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text], input[type=date], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fbfdff}
    textarea{min-height:80px;resize:vertical}
    .file-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .photo-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .photo-preview .item{position:relative;width:100px;height:80px;border-radius:6px;overflow:hidden;border:1px solid #e6eef8;background:#f7f9fc}
    .photo-preview img{width:100%;height:100%;object-fit:cover}
    .photo-remove{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #eef4fb;font-size:14px}
    th{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:#fff}
    .actions{display:flex;gap:8px}
    .btn-view{background:#28a745;color:#fff}
    .btn-edit{background:#ffc107;color:#111}
    .btn-del{background:var(--danger);color:#fff}
    .status{padding:8px;border-radius:8px;margin-bottom:12px}
    .hide{display:none !important}
    .sync-status{font-size:12px;background:rgba(255,255,255,0.1);padding:4px 8px;border-radius:4px}
    @media(max-width:980px){main{grid-template-columns:1fr;}}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1500}
    .modal .content{width:min(920px,96%);max-height:90vh;overflow:auto;padding:16px;border-radius:10px;background:#fff}
    .flex{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .camera-video{width:100%;max-height:360px;border-radius:8px;background:#000}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>üìã Sistema de Patrim√¥nio - Completo</h1>
      <div class="controls" id="headerControls">
        <div id="syncStatus" class="sync-status hide">üîÑ Sincronizando...</div>
        <div id="currentUserBox" class="muted small hide">Conectado como <strong id="currentUser"></strong></div>
        <button class="btn btn-sync" id="btnSyncUp" title="Enviar backup para nuvem">‚Üë Backup</button>
        <button class="btn btn-sync" id="btnSyncDown" title="Restaurar da nuvem">‚Üì Restaurar</button>
        <button class="btn btn-ghost" id="btnOpenLogin">Entrar</button>
        <button class="btn btn-logout hide" id="btnLogout">Sair</button>
      </div>
    </header>

    <main>
      <section class="card" id="leftPanel">
        <div id="authArea">
          <div id="loginBox">
            <h3>üîê Entrar</h3>
            <div id="loginError" class="status hide" style="background:#fdecea;color:#611a15"></div>
            <form id="loginForm">
              <label>Usu√°rio</label>
              <input type="text" id="username" placeholder="usu√°rio" autocomplete="username" value="admin">
              <label>Senha</label>
              <input type="password" id="password" placeholder="senha" autocomplete="current-password" value="admin123">
              <div style="margin-top:10px;display:flex;gap:8px">
                <button class="btn" type="submit" style="background:var(--primary);color:#fff">Entrar</button>
                <button type="button" id="btnFillDemo" class="btn" style="background:#eef4ff">Demo</button>
              </div>
              <p class="small" style="margin-top:8px">usu√°rio padr√£o: admin | senha: admin123</p>
            </form>
          </div>
        </div>

        <hr style="margin:14px 0">

        <div id="formArea" class="hide">
          <h3 id="formTitle">‚ûï Adicionar item</h3>
          <div id="photoCounter" class="small" style="margin-bottom:8px">0/10 fotos</div>
          
          <div id="patrimonioForm">
            <div class="form-row">
              <div>
                <label for="numeroPatrimonio">N√∫mero de Patrim√¥nio *</label>
                <input id="numeroPatrimonio" type="text" required>
              </div>
              <div>
                <label for="equipamento">Equipamento *</label>
                <input id="equipamento" type="text" required>
              </div>
            </div>

            <div class="form-row" style="margin-top:10px">
              <div>
                <label for="setor">Setor *</label>
                <input id="setor" type="text" required>
              </div>
              <div>
                <label for="modelo">Modelo</label>
                <input id="modelo" type="text">
              </div>
            </div>

            <div style="margin-top:10px">
              <label for="configuracao">Configura√ß√£o</label>
              <textarea id="configuracao" rows="3"></textarea>
            </div>

            <div style="margin-top:12px">
              <label>Fotos (m√°x. 10 por item)</label>
              <div class="file-row">
                <input id="fileInput" type="file" accept="image/*" multiple>
                <button type="button" id="btnOpenCamera" class="btn" style="background:#17a2b8;color:#fff">üì∏ C√¢mera</button>
                <div id="uploadStatus" class="small muted">Nenhuma foto</div>
              </div>
              <div id="photoPreview" class="photo-preview"></div>
            </div>

            <div style="margin-top:20px;display:flex;gap:8px">
              <button class="btn" type="button" style="background:var(--primary);color:#fff" id="btnSave">üíæ Salvar</button>
              <button class="btn" type="button" id="btnCancel" style="background:#f3f3f3">‚ùå Cancelar</button>
              <button class="btn" type="button" id="btnNew" style="background:#eef4ff">‚ûï Novo item</button>
            </div>
          </div>
        </div>

        <!-- Camera Modal -->
        <div id="cameraModal" class="modal hide">
          <div class="content">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3>üì∏ C√¢mera</h3>
              <button id="btnCloseCamera" class="btn" style="background:#dc3545;color:#fff">‚úñ Fechar</button>
            </div>
            <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
            <div style="display:flex;gap:8px;margin-top:12px;justify-content:center">
              <button id="btnCapture" class="btn" style="background:#28a745;color:#fff;padding:12px 24px;font-size:16px">
                üì∑ Capturar Foto
              </button>
            </div>
          </div>
        </div>
      </section>

      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>üìã Itens cadastrados</h3>
            <div class="small muted">Total: <span id="totalCount">0</span> | <span id="totalFotos">0 fotos</span></div>
          </div>

          <div id="tableWrap" style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th>N¬∫ Patrim√¥nio</th>
                  <th>Equipamento</th>
                  <th>Setor</th>
                  <th>Fotos</th>
                  <th style="width:220px">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="patrimonioTable">
                <tr><td colspan="5" class="small muted">Nenhum item cadastrado</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>üì¶ Visualizar</h3>
          <div id="viewBox" class="small muted">Selecione um item para ver detalhes</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Hist√≥rico de Manuten√ß√£o -->
  <div id="modalHistory" class="modal hide">
    <div class="content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>üìú Hist√≥rico de Manuten√ß√£o</h3>
        <button id="closeHistory" class="btn">‚úñ Fechar</button>
      </div>
      <div style="margin-top:12px;padding:12px;background:#f8f9fa;border-radius:8px">
        <strong id="historyItemTitle"></strong>
      </div>
      <div id="historyContent" style="margin-top:16px;max-height:300px;overflow-y:auto"></div>

      <div style="margin-top:20px;padding-top:16px;border-top:2px solid #eee">
        <h4>‚ûï Adicionar manuten√ß√£o</h4>
        <form id="maintenanceForm">
          <label>Data *</label>
          <input type="date" id="maintenanceDate" required style="margin-bottom:12px">
          
          <label>Descri√ß√£o *</label>
          <textarea id="maintenanceDescription" required rows="3" placeholder="Descreva a manuten√ß√£o realizada..."></textarea>
          
          <div style="margin-top:16px;display:flex;gap:8px">
            <button class="btn" type="submit" style="background:var(--primary);color:#fff">‚ûï Adicionar</button>
            <button class="btn" type="button" id="clearHistoryForm" style="background:#f3f3f3">Limpar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Sincroniza√ß√£o -->
  <div id="modalSync" class="modal hide">
    <div class="content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>üîÑ Sincroniza√ß√£o</h3>
        <button id="closeSync" class="btn">‚úñ Fechar</button>
      </div>
      <div id="syncContent" style="margin-top:16px">
        <div id="syncInfo" style="padding:16px;background:#f8f9fa;border-radius:8px;margin-bottom:16px"></div>
        
        <div style="margin-top:20px">
          <h4>üì§ Enviar Backup</h4>
          <p class="small">Salva todos os itens na nuvem (Cloudinary)</p>
          <button id="btnDoBackup" class="btn" style="background:#28a745;color:#fff;margin-top:8px">
            ‚¨ÜÔ∏è Enviar Backup Agora
          </button>
        </div>
        
        <div style="margin-top:24px;padding-top:16px;border-top:2px solid #eee">
          <h4>üì• Restaurar Backup</h4>
          <p class="small">Cole a URL do backup para restaurar em outro dispositivo:</p>
          <div style="margin-top:12px">
            <input type="text" id="backupUrlInput" placeholder="https://res.cloudinary.com/..." 
                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;margin-bottom:12px">
            <button id="btnDoRestore" class="btn" style="background:#17a2b8;color:#fff">
              ‚¨áÔ∏è Restaurar da URL
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ================= CONFIGURA√á√ïES ================= */
    const CLOUD_NAME = 'dwanrvvob';
    const UPLOAD_PRESET_FOTOS = 'EETI_fotos';
    const UPLOAD_PRESET_BACKUP = 'EETI_backups';
    const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
    
    const users = { admin: 'admin123' };
    const MAX_PHOTOS_PER_ITEM = 10;

    /* ================= STORAGE SIMPLIFICADO ================= */
    const storage = {
      getItems() {
        const items = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('patrimonio:')) {
            try {
              const item = JSON.parse(localStorage.getItem(key));
              items.push(item);
            } catch (e) { console.error('Erro ao parsear item:', e); }
          }
        }
        return items;
      },
      
      saveItem(item) {
        localStorage.setItem(`patrimonio:${item.id}`, JSON.stringify(item));
      },
      
      deleteItem(id) {
        localStorage.removeItem(`patrimonio:${id}`);
      },
      
      getItem(id) {
        const data = localStorage.getItem(`patrimonio:${id}`);
        return data ? JSON.parse(data) : null;
      },
      
      clearAll() {
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('patrimonio:')) {
            keys.push(key);
          }
        }
        keys.forEach(key => localStorage.removeItem(key));
      },
      
      importItems(items) {
        items.forEach(item => {
          this.saveItem(item);
        });
      }
    };

    /* ================= ESTADO GLOBAL ================= */
    let currentUser = localStorage.getItem('currentUser') || null;
    let tempPhotos = [];
    let editingId = null;
    let cameraStream = null;
    let currentHistoryItemId = null;

    /* ================= INICIALIZA√á√ÉO ================= */
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
    });

    function initApp() {
      // Verificar login persistido
      if (currentUser) {
        showAppUI();
        loadData();
      } else {
        showLogin();
      }
      
      // Configurar event listeners
      setupEventListeners();
      updateStats();
    }

    /* ================= AUTENTICA√á√ÉO ================= */
    function showLogin() {
      document.getElementById('loginBox').classList.remove('hide');
      document.getElementById('formArea').classList.add('hide');
      document.getElementById('btnOpenLogin').classList.add('hide');
      document.getElementById('btnLogout').classList.add('hide');
      document.getElementById('currentUserBox').classList.add('hide');
    }
    
    function showAppUI() {
      document.getElementById('loginBox').classList.add('hide');
      document.getElementById('formArea').classList.remove('hide');
      document.getElementById('currentUser').textContent = currentUser;
      document.getElementById('currentUserBox').classList.remove('hide');
      document.getElementById('btnLogout').classList.remove('hide');
      document.getElementById('btnOpenLogin').classList.add('hide');
    }

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      
      if (users[user] && users[user] === pass) {
        currentUser = user;
        localStorage.setItem('currentUser', user);
        showAppUI();
        loadData();
      } else {
        document.getElementById('loginError').textContent = 'Usu√°rio ou senha incorretos';
        document.getElementById('loginError').classList.remove('hide');
        setTimeout(() => document.getElementById('loginError').classList.add('hide'), 3000);
      }
    });

    document.getElementById('btnFillDemo').addEventListener('click', function() {
      document.getElementById('username').value = 'admin';
      document.getElementById('password').value = 'admin123';
    });

    document.getElementById('btnLogout').addEventListener('click', function() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      showLogin();
    });

    document.getElementById('btnOpenLogin').addEventListener('click', function() {
      showLogin();
      window.scrollTo({top: 0, behavior: 'smooth'});
    });

    /* ================= C√ÇMERA - FUNCIONAL ================= */
    document.getElementById('btnOpenCamera').addEventListener('click', async function() {
      try {
        // Verificar permiss√µes
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('Seu navegador n√£o suporta acesso √† c√¢mera ou voc√™ n√£o est√° em HTTPS/localhost.');
          return;
        }
        
        // Solicitar acesso √† c√¢mera
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' },
          audio: false 
        });
        
        // Configurar v√≠deo
        const video = document.getElementById('cameraVideo');
        video.srcObject = cameraStream;
        document.getElementById('cameraModal').classList.remove('hide');
        
      } catch (error) {
        console.error('Erro ao acessar c√¢mera:', error);
        alert(`N√£o foi poss√≠vel acessar a c√¢mera: ${error.message}`);
      }
    });

    document.getElementById('btnCloseCamera').addEventListener('click', function() {
      stopCamera();
      document.getElementById('cameraModal').classList.add('hide');
    });

    document.getElementById('btnCapture').addEventListener('click', async function() {
      if (!cameraStream) return;
      
      try {
        const video = document.getElementById('cameraVideo');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Converter para blob
        canvas.toBlob(async function(blob) {
          if (tempPhotos.length >= MAX_PHOTOS_PER_ITEM) {
            alert(`Limite de ${MAX_PHOTOS_PER_ITEM} fotos atingido!`);
            return;
          }
          
          try {
            document.getElementById('uploadStatus').textContent = 'Enviando foto...';
            
            // Upload para Cloudinary
            const formData = new FormData();
            formData.append('file', blob);
            formData.append('upload_preset', UPLOAD_PRESET_FOTOS);
            formData.append('quality', '80');
            
            const response = await fetch(CLOUDINARY_URL, {
              method: 'POST',
              body: formData
            });
            
            const data = await response.json();
            
            if (data.secure_url) {
              // Adicionar foto
              tempPhotos.push(data.secure_url);
              renderPhotoPreview();
              document.getElementById('uploadStatus').textContent = 'Foto capturada!';
              
              // Feedback visual
              setTimeout(() => {
                document.getElementById('uploadStatus').textContent = `${tempPhotos.length} foto(s)`;
              }, 2000);
              
              // Fechar c√¢mera ap√≥s captura
              stopCamera();
              document.getElementById('cameraModal').classList.add('hide');
              
            } else {
              throw new Error('Upload falhou');
            }
            
          } catch (error) {
            console.error('Erro upload:', error);
            document.getElementById('uploadStatus').textContent = 'Erro ao enviar';
          }
        }, 'image/jpeg', 0.9);
        
      } catch (error) {
        console.error('Erro captura:', error);
        alert('Erro ao capturar foto');
      }
    });

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      document.getElementById('cameraVideo').srcObject = null;
    }

    /* ================= GEST√ÉO DE FOTOS ================= */
    document.getElementById('fileInput').addEventListener('change', async function(e) {
      const files = Array.from(e.target.files || []);
      
      for (const file of files) {
        if (tempPhotos.length >= MAX_PHOTOS_PER_ITEM) {
          alert(`Limite de ${MAX_PHOTOS_PER_ITEM} fotos atingido!`);
          break;
        }
        
        try {
          document.getElementById('uploadStatus').textContent = 'Enviando...';
          
          // Upload para Cloudinary
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', UPLOAD_PRESET_FOTOS);
          formData.append('quality', '80');
          
          const response = await fetch(CLOUDINARY_URL, {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          
          if (data.secure_url) {
            tempPhotos.push(data.secure_url);
            renderPhotoPreview();
            document.getElementById('uploadStatus').textContent = `${tempPhotos.length} foto(s)`;
          }
          
        } catch (error) {
          console.error('Erro upload:', error);
          document.getElementById('uploadStatus').textContent = 'Erro ao enviar';
        }
      }
      
      this.value = ''; // Limpar input
    });

    function renderPhotoPreview() {
      const container = document.getElementById('photoPreview');
      const counter = document.getElementById('photoCounter');
      
      container.innerHTML = '';
      counter.textContent = `${tempPhotos.length}/${MAX_PHOTOS_PER_ITEM} fotos`;
      
      if (tempPhotos.length === 0) {
        container.innerHTML = '<div class="small muted" style="width:100%">Nenhuma foto adicionada</div>';
        return;
      }
      
      tempPhotos.forEach((url, index) => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <img src="${url}" alt="Foto ${index + 1}">
          <button class="photo-remove" data-index="${index}" title="Remover">√ó</button>
        `;
        container.appendChild(div);
      });
      
      // Adicionar event listeners para remover fotos
      container.querySelectorAll('.photo-remove').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          tempPhotos.splice(index, 1);
          renderPhotoPreview();
        });
      });
    }

    /* ================= CRUD - COMPLETO ================= */
    document.getElementById('btnSave').addEventListener('click', async function() {
      if (!currentUser) {
        alert('Fa√ßa login para continuar');
        return;
      }
      
      // Validar campos obrigat√≥rios
      const numero = document.getElementById('numeroPatrimonio').value.trim();
      const equipamento = document.getElementById('equipamento').value.trim();
      const setor = document.getElementById('setor').value.trim();
      
      if (!numero) {
        alert('Preencha o n√∫mero de patrim√¥nio');
        document.getElementById('numeroPatrimonio').focus();
        return;
      }
      
      if (!equipamento) {
        alert('Preencha o equipamento');
        document.getElementById('equipamento').focus();
        return;
      }
      
      if (!setor) {
        alert('Preencha o setor');
        document.getElementById('setor').focus();
        return;
      }
      
      try {
        // Criar objeto do item
        const item = {
          id: editingId || 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          numeroPatrimonio: numero,
          equipamento: equipamento,
          setor: setor,
          modelo: document.getElementById('modelo').value.trim(),
          configuracao: document.getElementById('configuracao').value.trim(),
          photos: [...tempPhotos],
          history: [],
          createdBy: currentUser,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // Se for edi√ß√£o, preservar hist√≥rico
        if (editingId) {
          const existing = storage.getItem(editingId);
          if (existing && existing.history) {
            item.history = existing.history;
          }
        }
        
        // Salvar item
        storage.saveItem(item);
        
        // Feedback visual
        document.getElementById('uploadStatus').textContent = '‚úÖ Item salvo!';
        
        // Resetar formul√°rio
        resetForm();
        
        // Recarregar dados
        loadData();
        
        // Mostrar item salvo
        viewItem(item.id);
        
        // Auto-backup ap√≥s salvar
        setTimeout(() => {
          if (storage.getItems().length % 5 === 0) { // A cada 5 itens
            autoBackup();
          }
        }, 1000);
        
      } catch (error) {
        console.error('Erro ao salvar:', error);
        alert('Erro ao salvar item');
      }
    });

    document.getElementById('btnCancel').addEventListener('click', resetForm);
    document.getElementById('btnNew').addEventListener('click', resetForm);

    function resetForm() {
      document.getElementById('formTitle').textContent = '‚ûï Adicionar item';
      document.getElementById('numeroPatrimonio').value = '';
      document.getElementById('equipamento').value = '';
      document.getElementById('setor').value = '';
      document.getElementById('modelo').value = '';
      document.getElementById('configuracao').value = '';
      editingId = null;
      tempPhotos = [];
      renderPhotoPreview();
      document.getElementById('uploadStatus').textContent = 'Nenhuma foto';
    }

    /* ================= CARREGAR E EXIBIR DADOS ================= */
    function loadData() {
      const items = storage.getItems();
      const table = document.getElementById('patrimonioTable');
      const totalCount = document.getElementById('totalCount');
      
      table.innerHTML = '';
      totalCount.textContent = items.length;
      
      if (items.length === 0) {
        table.innerHTML = '<tr><td colspan="5" class="small muted">Nenhum item cadastrado</td></tr>';
        updateStats();
        return;
      }
      
      // Ordenar por data (mais recente primeiro)
      items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      items.forEach(item => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td><strong>${escapeHtml(item.numeroPatrimonio)}</strong></td>
          <td>${escapeHtml(item.equipamento)}</td>
          <td>${escapeHtml(item.setor)}</td>
          <td>${item.photos ? item.photos.length + ' üì∑' : '0'}</td>
          <td class="actions">
            <button class="btn btn-view" data-id="${item.id}" title="Visualizar">üëÅÔ∏è Ver</button>
            <button class="btn btn-edit" data-id="${item.id}" title="Editar">‚úèÔ∏è Editar</button>
            <button class="btn" data-id="${item.id}" title="Hist√≥rico">üìú Hist</button>
            <button class="btn btn-del" data-id="${item.id}" title="Excluir">üóëÔ∏è Excluir</button>
          </td>
        `;
        
        table.appendChild(row);
      });
      
      // Adicionar event listeners para os bot√µes
      table.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          viewItem(id);
        });
      });
      
      table.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          editItem(id);
        });
      });
      
      table.querySelectorAll('.btn:not(.btn-view):not(.btn-edit):not(.btn-del)').forEach(btn => {
        if (!btn.classList.contains('btn-del')) {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            openHistory(id);
          });
        }
      });
      
      table.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const item = storage.getItem(id);
          if (item && confirm(`Excluir "${item.equipamento}" (${item.numeroPatrimonio})?`)) {
            storage.deleteItem(id);
            loadData();
            document.getElementById('viewBox').innerHTML = '<div class="small muted">Item exclu√≠do</div>';
            updateStats();
          }
        });
      });
      
      updateStats();
    }

    function editItem(id) {
      const item = storage.getItem(id);
      if (!item) {
        alert('Item n√£o encontrado');
        return;
      }
      
      editingId = id;
      document.getElementById('formTitle').textContent = '‚úèÔ∏è Editar item';
      document.getElementById('numeroPatrimonio').value = item.numeroPatrimonio || '';
      document.getElementById('equipamento').value = item.equipamento || '';
      document.getElementById('setor').value = item.setor || '';
      document.getElementById('modelo').value = item.modelo || '';
      document.getElementById('configuracao').value = item.configuracao || '';
      tempPhotos = item.photos ? [...item.photos] : [];
      renderPhotoPreview();
      
      // Scroll para o formul√°rio
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function viewItem(id) {
      const item = storage.getItem(id);
      if (!item) {
        document.getElementById('viewBox').innerHTML = '<div class="small muted">Item n√£o encontrado</div>';
        return;
      }
      
      let html = `
        <div style="display:flex;gap:20px;align-items:flex-start">
          <div style="flex:1">
            <h4 style="margin-top:0;color:var(--primary)">${escapeHtml(item.equipamento)}</h4>
            <p><strong>N¬∫ Patrim√¥nio:</strong> ${escapeHtml(item.numeroPatrimonio)}</p>
            <p><strong>Setor:</strong> ${escapeHtml(item.setor)}</p>
            <p><strong>Modelo:</strong> ${escapeHtml(item.modelo || 'N√£o informado')}</p>
            <p><strong>Configura√ß√£o:</strong> ${escapeHtml(item.configuracao || 'N√£o informada')}</p>
            <p class="small muted">Cadastrado por ${escapeHtml(item.createdBy || 'admin')} em ${formatDate(item.createdAt)}</p>
          </div>
          <div style="width:280px">
            <strong>Fotos (${item.photos ? item.photos.length : 0})</strong>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
      `;
      
      if (item.photos && item.photos.length > 0) {
        item.photos.forEach((url, index) => {
          html += `
            <a href="${url}" target="_blank" style="display:block;width:80px;height:60px;border-radius:6px;overflow:hidden;position:relative">
              <img src="${url}" style="width:100%;height:100%;object-fit:cover">
              <div style="position:absolute;bottom:0;right:0;background:rgba(0,0,0,0.7);color:white;font-size:10px;padding:1px 4px">${index + 1}</div>
            </a>
          `;
        });
      } else {
        html += '<div class="small muted">Sem fotos</div>';
      }
      
      html += `
            </div>
          </div>
        </div>
        
        <div style="margin-top:20px;padding-top:16px;border-top:1px solid #eee">
          <h5>üìù Hist√≥rico de Manuten√ß√µes</h5>
      `;
      
      if (item.history && item.history.length > 0) {
        html += '<ul style="margin-top:8px">';
        item.history.slice(0, 5).forEach(entry => {
          html += `<li class="small">${formatDate(entry.date)} - ${escapeHtml(entry.description)}</li>`;
        });
        html += '</ul>';
        if (item.history.length > 5) {
          html += `<p class="small muted">+ ${item.history.length - 5} manuten√ß√µes anteriores</p>`;
        }
      } else {
        html += '<div class="small muted">Nenhuma manuten√ß√£o registrada</div>';
      }
      
      html += `</div>`;
      
      document.getElementById('viewBox').innerHTML = html;
    }

    /* ================= HIST√ìRICO DE MANUTEN√á√ÉO ================= */
    function openHistory(id) {
      const item = storage.getItem(id);
      if (!item) {
        alert('Item n√£o encontrado');
        return;
      }
      
      currentHistoryItemId = id;
      document.getElementById('historyItemTitle').textContent = 
        `${item.equipamento} (${item.numeroPatrimonio}) - ${item.setor}`;
      
      // Carregar hist√≥rico
      const historyContent = document.getElementById('historyContent');
      historyContent.innerHTML = '';
      
      if (item.history && item.history.length > 0) {
        // Ordenar por data (mais recente primeiro)
        const sortedHistory = [...item.history].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sortedHistory.forEach((entry, index) => {
          const div = document.createElement('div');
          div.style.cssText = `
            border-left: 4px solid var(--primary);
            padding: 12px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
          `;
          div.innerHTML = `
            <strong>${formatDate(entry.date)}</strong>
            <div class="small" style="margin-top:4px">${escapeHtml(entry.description)}</div>
            <div class="small muted" style="margin-top:4px">
              ${entry.addedBy ? `Registrado por: ${entry.addedBy}` : ''}
            </div>
          `;
          historyContent.appendChild(div);
        });
      } else {
        historyContent.innerHTML = '<div class="small muted" style="text-align:center;padding:20px">Nenhuma manuten√ß√£o registrada</div>';
      }
      
      // Configurar data atual
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('maintenanceDate').value = today;
      document.getElementById('maintenanceDescription').value = '';
      
      // Mostrar modal
      document.getElementById('modalHistory').classList.remove('hide');
    }

    document.getElementById('closeHistory').addEventListener('click', function() {
      document.getElementById('modalHistory').classList.add('hide');
      currentHistoryItemId = null;
    });

    document.getElementById('clearHistoryForm').addEventListener('click', function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('maintenanceDate').value = today;
      document.getElementById('maintenanceDescription').value = '';
    });

    document.getElementById('maintenanceForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!currentHistoryItemId) {
        alert('Nenhum item selecionado');
        return;
      }
      
      const date = document.getElementById('maintenanceDate').value;
      const description = document.getElementById('maintenanceDescription').value.trim();
      
      if (!date) {
        alert('Preencha a data');
        return;
      }
      
      if (!description) {
        alert('Preencha a descri√ß√£o');
        return;
      }
      
      // Obter item atual
      const item = storage.getItem(currentHistoryItemId);
      if (!item) {
        alert('Item n√£o encontrado');
        return;
      }
      
      // Adicionar manuten√ß√£o
      if (!item.history) {
        item.history = [];
      }
      
      item.history.unshift({
        date: date,
        description: description,
        addedBy: currentUser,
        timestamp: new Date().toISOString()
      });
      
      // Atualizar item
      item.updatedAt = new Date().toISOString();
      storage.saveItem(item);
      
      // Feedback
      alert('‚úÖ Manuten√ß√£o registrada com sucesso!');
      
      // Recarregar hist√≥rico
      openHistory(currentHistoryItemId);
      
      // Recarregar dados
      loadData();
    });

    /* ================= SINCRONIZA√á√ÉO CLOUDINARY ================= */
    async function uploadBackupToCloudinary(backupData) {
      try {
        // Converter para JSON
        const jsonStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        
        // Preparar form data
        const formData = new FormData();
        formData.append('file', blob, `backup_patrimonio_${Date.now()}.json`);
        formData.append('upload_preset', UPLOAD_PRESET_BACKUP);
        
        // Fazer upload
        const response = await fetch(CLOUDINARY_URL, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.secure_url) {
          // Salvar URL do √∫ltimo backup
          localStorage.setItem('last_backup_url', data.secure_url);
          localStorage.setItem('last_backup_time', new Date().toISOString());
          localStorage.setItem('last_backup_count', backupData.items.length.toString());
          
          return {
            success: true,
            url: data.secure_url,
            itemCount: backupData.items.length,
            photoCount: backupData.totalPhotos
          };
        } else {
          throw new Error(data.error?.message || 'Upload falhou');
        }
        
      } catch (error) {
        console.error('Erro backup:', error);
        return {
          success: false,
          error: error.message
        };
      }
    }

    async function downloadBackupFromCloudinary(url) {
      try {
        // Baixar backup
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const backupData = await response.json();
        
        // Validar estrutura
        if (!backupData.items || !Array.isArray(backupData.items)) {
          throw new Error('Formato de backup inv√°lido');
        }
        
        return {
          success: true,
          data: backupData
        };
        
      } catch (error) {
        console.error('Erro download:', error);
        return {
          success: false,
          error: error.message
        };
      }
    }

    async function createBackup() {
      const items = storage.getItems();
      
      if (items.length === 0) {
        showSyncInfo('‚ö† Nenhum item para fazer backup', 'warning');
        return;
      }
      
      showSyncInfo('üîÑ Criando backup...', 'info');
      
      const backupData = {
        app: 'Sistema de Patrim√¥nio',
        version: '2.0',
        timestamp: new Date().toISOString(),
        user: currentUser,
        totalItems: items.length,
        totalPhotos: items.reduce((sum, item) => sum + (item.photos?.length || 0), 0),
        items: items
      };
      
      const result = await uploadBackupToCloudinary(backupData);
      
      if (result.success) {
        showSyncInfo(`
          ‚úÖ <strong>Backup criado com sucesso!</strong><br>
          üì¶ ${result.itemCount} itens salvos<br>
          üì∑ ${result.photoCount} fotos inclu√≠das<br>
          ‚è∞ ${new Date().toLocaleString('pt-BR')}<br><br>
          <small>URL do backup:<br>
          <a href="${result.url}" target="_blank" style="word-break:break-all">${result.url.substring(0, 80)}...</a></small>
        `, 'success');
        
        // Copiar URL automaticamente
        try {
          await navigator.clipboard.writeText(result.url);
          showSyncInfo(`
            ‚úÖ <strong>Backup criado com sucesso!</strong><br>
            üìã URL copiada para a √°rea de transfer√™ncia!<br>
            üì¶ ${result.itemCount} itens<br>
            ‚è∞ ${new Date().toLocaleString('pt-BR')}
          `, 'success');
        } catch (e) {
          // Ignorar erro de clipboard
        }
        
      } else {
        showSyncInfo(`‚ùå <strong>Erro no backup:</strong><br>${result.error}`, 'error');
      }
    }

    async function restoreBackup(url) {
      if (!url) {
        showSyncInfo('‚ùå Informe a URL do backup', 'error');
        return;
      }
      
      showSyncInfo('üîÑ Baixando backup...', 'info');
      
      const result = await downloadBackupFromCloudinary(url);
      
      if (!result.success) {
        showSyncInfo(`‚ùå <strong>Erro ao baixar:</strong><br>${result.error}`, 'error');
        return;
      }
      
      const backupData = result.data;
      
      // Confirmar restaura√ß√£o
      if (!confirm(`Restaurar backup com ${backupData.items.length} itens?\n\nData: ${new Date(backupData.timestamp).toLocaleString('pt-BR')}\n\nIsso substituir√° todos os dados atuais.`)) {
        showSyncInfo('‚ùå Restaura√ß√£o cancelada', 'warning');
        return;
      }
      
      // Limpar dados atuais
      storage.clearAll();
      
      // Restaurar dados
      storage.importItems(backupData.items);
      
      // Recarregar interface
      loadData();
      
      showSyncInfo(`
        ‚úÖ <strong>Backup restaurado!</strong><br>
        üì¶ ${backupData.items.length} itens restaurados<br>
        üì∑ ${backupData.totalPhotos || 0} fotos recuperadas<br>
        üë§ Backup original: ${backupData.user || 'Desconhecido'}<br>
        ‚è∞ ${new Date(backupData.timestamp).toLocaleString('pt-BR')}
      `, 'success');
      
      // Fechar modal ap√≥s 5 segundos
      setTimeout(() => {
        document.getElementById('modalSync').classList.add('hide');
      }, 5000);
    }

    async function autoBackup() {
      const items = storage.getItems();
      if (items.length === 0) return;
      
      try {
        const backupData = {
          app: 'Sistema de Patrim√¥nio',
          timestamp: new Date().toISOString(),
          user: currentUser,
          totalItems: items.length,
          items: items
        };
        
        const result = await uploadBackupToCloudinary(backupData);
        if (result.success) {
          console.log('‚úÖ Backup autom√°tico realizado:', result.itemCount, 'itens');
        }
      } catch (error) {
        console.error('‚ùå Erro backup autom√°tico:', error);
      }
    }

    /* ================= INTERFACE DE SINCRONIZA√á√ÉO ================= */
    document.getElementById('btnSyncUp').addEventListener('click', function() {
      document.getElementById('modalSync').classList.remove('hide');
      showSyncInfo('Clique no bot√£o abaixo para criar um backup', 'info');
    });

    document.getElementById('btnDoBackup').addEventListener('click', createBackup);

    document.getElementById('btnDoRestore').addEventListener('click', function() {
      const url = document.getElementById('backupUrlInput').value.trim();
      restoreBackup(url);
    });

    document.getElementById('closeSync').addEventListener('click', function() {
      document.getElementById('modalSync').classList.add('hide');
    });

    function showSyncInfo(message, type = 'info') {
      const syncInfo = document.getElementById('syncInfo');
      const colors = {
        info: '#17a2b8',
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107'
      };
      
      syncInfo.innerHTML = message;
      syncInfo.style.borderLeft = `4px solid ${colors[type] || colors.info}`;
      syncInfo.style.background = type === 'success' ? '#d4edda' : 
                                 type === 'error' ? '#f8d7da' : 
                                 type === 'warning' ? '#fff3cd' : '#d1ecf1';
      syncInfo.style.color = type === 'success' ? '#155724' : 
                            type === 'error' ? '#721c24' : 
                            type === 'warning' ? '#856404' : '#0c5460';
    }

    /* ================= FUN√á√ïES AUXILIARES ================= */
    function setupEventListeners() {
      // Fechar modais ao clicar fora
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.classList.add('hide');
          }
        });
      });
      
      // Fechar modais com ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal').forEach(modal => {
            if (!modal.classList.contains('hide')) {
              modal.classList.add('hide');
            }
          });
        }
      });
    }

    function updateStats() {
      const items = storage.getItems();
      const totalFotos = items.reduce((sum, item) => sum + (item.photos?.length || 0), 0);
      
      document.getElementById('totalCount').textContent = items.length;
      document.getElementById('totalFotos').textContent = `${totalFotos} fotos`;
      
      // Atualizar status de sincroniza√ß√£o
      const lastBackupTime = localStorage.getItem('last_backup_time');
      if (lastBackupTime) {
        const timeStr = new Date(lastBackupTime).toLocaleString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('syncStatus').innerHTML = `üìä ${items.length} itens | üîÑ ${timeStr}`;
        document.getElementById('syncStatus').classList.remove('hide');
      } else if (items.length > 0) {
        document.getElementById('syncStatus').innerHTML = `üìä ${items.length} itens | ‚ö† Sem backup`;
        document.getElementById('syncStatus').classList.remove('hide');
      } else {
        document.getElementById('syncStatus').classList.add('hide');
      }
    }

    function formatDate(dateString) {
      try {
        const d = new Date(dateString);
        return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR').substring(0, 5);
      } catch {
        return dateString;
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /* ================= INICIALIZA√á√ÉO FINAL ================= */
    console.log('‚úÖ Sistema Patrim√¥nio carregado!');
    console.log('üìã Itens no storage:', storage.getItems().length);
    console.log('üë§ Usu√°rio atual:', currentUser);
  </script>
</body>
</html>
