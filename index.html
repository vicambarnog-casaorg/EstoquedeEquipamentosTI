<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Patrimônio TI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#111;color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
main{padding:20px}
.card{background:#fff;border-radius:10px;padding:16px;margin-bottom:16px}
.hidden{display:none}
input{padding:8px;width:100%;box-sizing:border-box}
button{padding:8px 12px;border:0;border-radius:6px;cursor:pointer}
.btn{background:#2563eb;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
img{max-width:70px;border-radius:6px;margin-right:4px}
</style>
</head>
<body>

<header>
  <div>Patrimônio TI</div>
  <div>
    <span id="userEmail"></span>
    <button id="logoutBtn" class="btn hidden">Sair</button>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h3>Login</h3>
    <input id="email" placeholder="Email">
    <br><br>
    <input id="password" type="password" placeholder="Senha">
    <br><br>
    <button class="btn" onclick="login()">Entrar</button>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="card">
      <h3>Novo Produto</h3>
      <input id="numero" placeholder="Número do patrimônio"><br><br>
      <input id="equipamento" placeholder="Equipamento"><br><br>
      <input id="setor" placeholder="Setor"><br><br>

      <input type="hidden"
        id="uploadcare"
        role="uploadcare-uploader"
        data-images-only="true"
        data-camera="true"
        data-multiple="true">

      <div id="preview" style="margin-top:10px"></div><br>

      <button class="btn" onclick="salvarProduto()">Salvar produto</button>
    </div>

    <div class="card">
      <h3>Produtos cadastrados</h3>
      <table>
        <thead>
          <tr><th>Nº</th><th>Equipamento</th><th>Setor</th><th>Fotos</th></tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Uploadcare -->
<script>
UPLOADCARE_PUBLIC_KEY = "a4d223bddcdb3028ec83";
</script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwCfiEB3JEUu_6rKR32C2E5whnb6-SgX0",
  authDomain: "sis-eetibkp.firebaseapp.com",
  projectId: "sis-eetibkp"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Uploadcare
let fotos = [];
const uploader = uploadcare.Widget("#uploadcare");

uploader.onUploadComplete(file=>{
  const otimizada =
    file.cdnUrl + "-/resize/800x800/-/quality/70/-/format/webp/";
  fotos.push(otimizada);
  const preview = document.getElementById("preview");
  if (preview) {
    preview.innerHTML += `<img src="${otimizada}">`;
  }
});

// Auth
window.login = async ()=>{
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  
  if (emailInput && passwordInput) {
    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
  }
};

// Configurar logout
const logoutBtn = document.getElementById("logoutBtn");
if (logoutBtn) {
  logoutBtn.onclick = () => signOut(auth);
}

onAuthStateChanged(auth,user=>{
  // Obter elementos dentro do callback
  const loginCard = document.getElementById("loginCard");
  const app = document.getElementById("app");
  const logoutBtn = document.getElementById("logoutBtn");
  const userEmail = document.getElementById("userEmail");
  
  if(user){
    if(loginCard) loginCard.classList.add("hidden");
    if(app) app.classList.remove("hidden");
    if(logoutBtn) logoutBtn.classList.remove("hidden");
    if(userEmail) userEmail.innerText = user.email;
    carregar();
  }else{
    if(loginCard) loginCard.classList.remove("hidden");
    if(app) app.classList.add("hidden");
    if(logoutBtn) logoutBtn.classList.add("hidden");
    if(userEmail) userEmail.innerText = "";
  }
});

// Firestore
async function salvarProduto(){
  const numero = document.getElementById("numero");
  const equipamento = document.getElementById("equipamento");
  const setor = document.getElementById("setor");
  const preview = document.getElementById("preview");
  
  if (numero && equipamento && setor) {
    await addDoc(collection(db,"produtos"),{
      numero: numero.value,
      equipamento: equipamento.value,
      setor: setor.value,
      fotos
    });
    
    // Limpar campos
    numero.value = "";
    equipamento.value = "";
    setor.value = "";
    fotos = [];
    if (preview) {
      preview.innerHTML = "";
    }
  }
}

function carregar(){
  onSnapshot(collection(db,"produtos"),snap=>{
    const lista = document.getElementById("lista");
    if (!lista) return;
    
    lista.innerHTML="";
    snap.forEach(d=>{
      const p=d.data();
      lista.innerHTML+=`
        <tr>
          <td>${p.numero || ''}</td>
          <td>${p.equipamento || ''}</td>
          <td>${p.setor || ''}</td>
          <td>${(p.fotos||[]).map(f=>`<img src="${f}">`).join("")}</td>
        </tr>`;
    });
  });
}
</script>

</body>
</html>
