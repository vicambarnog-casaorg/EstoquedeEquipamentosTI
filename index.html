<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#6366f1" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Patrimônio EETI • Sistema Completo (Firebase Auth)</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ======= Theme & Reset ======= */
    :root{
      --primary:#6366f1; --primary-dark:#4f46e5; --muted:#6b7280; --card-bg:#fff;
      --body-bg:#f3f4f6; --border:#e5e7eb; --radius:12px; --radius-sm:8px; --transition:all .3s ease;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,Segoe UI,Roboto,sans-serif;background:var(--body-bg);color:#111827;min-height:100vh;line-height:1.6}
    .hide{display:none!important}
    .app-container{max-width:1400px;margin:0 auto;padding:0 16px;min-height:100vh;display:flex;flex-direction:column}
    .app-header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:1rem 0;position:sticky;top:0;z-index:100;box-shadow:0 10px 25px -5px rgba(0,0,0,0.1);backdrop-filter:blur(8px)}
    .header-content{display:flex;align-items:center;justify-content:space-between;gap:1rem}
    .logo{display:flex;align-items:center;gap:12px;color:white;text-decoration:none}
    .logo-icon{font-size:1.75rem;background:rgba(255,255,255,0.12);width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .logo-title{font-size:1.25rem;font-weight:700}
    .logo-subtitle{font-size:.75rem;opacity:.9}
    .header-controls{display:flex;align-items:center;gap:12px}
    .btn{padding:8px 14px;border-radius:8px;border:none;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:8px}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:inherit}
    .btn-primary{background:var(--primary);color:white}
    .btn-danger{background:#ef4444;color:white}
    .btn-sm{padding:6px 10px;font-size:.85rem}
    .status-badge{padding:6px 10px;border-radius:999px;font-size:.85rem;background:rgba(255,255,255,0.08)}
    .main-content{flex:1;padding:24px 0;display:grid;grid-template-columns:1fr 2fr;gap:24px}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.06);border:1px solid var(--border)}
    .login-container{max-width:420px;margin:40px auto}
    .form-group{margin-bottom:14px}
    .form-label{display:block;margin-bottom:8px;font-weight:600;font-size:.9rem}
    .form-control{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);font-size:.95rem}
    .text-muted{color:var(--muted);font-size:.9rem}
    .table-container{overflow-x:auto;border-radius:8px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;min-width:600px}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
    .empty-state{text-align:center;padding:36px;color:var(--muted)}
    .toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px}
    .toast{padding:12px 16px;border-radius:8px;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,0.08);border-left:4px solid var(--primary)}
    @media(max-width:1024px){.main-content{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app-container">
    <div class="toast-container" id="toastContainer"></div>

    <header class="app-header">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon"><i class="fas fa-boxes-stacked"></i></div>
          <div>
            <div class="logo-title">Patrimônio EETI</div>
            <div class="logo-subtitle">Sistema de Gestão Completo</div>
          </div>
        </div>

        <div class="header-controls">
          <div id="onlineStatus" class="status-badge"><i class="fas fa-wifi"></i>&nbsp;<span id="onlineText">Conexão desconhecida</span></div>
          <button id="btnOpenLogin" class="btn btn-ghost btn-sm"><i class="fas fa-sign-in-alt"></i> Entrar</button>
          <button id="btnLogout" class="btn btn-danger btn-sm hide"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
      </div>
    </header>

    <main class="main-content">
      <!-- Left: Login / Form -->
      <section id="leftPanel">
        <!-- LOGIN -->
        <div id="loginCard" class="card login-container">
          <div style="text-align:center;margin-bottom:18px">
            <div style="font-size:40px;color:var(--primary)"><i class="fas fa-lock"></i></div>
            <h2>Acesso ao Sistema</h2>
            <p class="text-muted">Use um e-mail válido para efetuar login</p>
          </div>

          <div id="loginError" class="text-muted" style="color:#ef4444;display:none;margin-bottom:8px"></div>

          <form id="loginForm" autocomplete="on">
            <div class="form-group">
              <label class="form-label" for="emailInput">E-mail</label>
              <input id="emailInput" class="form-control" type="email" placeholder="seu@exemplo.com" required autocomplete="email" />
            </div>

            <div class="form-group">
              <label class="form-label" for="passwordInput">Senha</label>
              <input id="passwordInput" class="form-control" type="password" placeholder="Senha" required autocomplete="current-password" />
            </div>

            <div class="form-group">
              <button type="submit" class="btn btn-primary" style="width:100%"><i class="fas fa-sign-in-alt"></i> Entrar</button>
            </div>
          </form>

          <div style="margin-top:6px">
            <button id="btnCreateDemo" class="btn btn-ghost" style="width:100%">Criar conta de demonstração (admin@teste.com)</button>
          </div>

          <div style="margin-top:12px;text-align:center" class="text-muted">Versão de teste • Firebase Authentication</div>
        </div>

        <!-- FORM AREA (escondida até login) -->
        <div id="formArea" class="card hide">
          <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div style="display:flex;align-items:center;gap:8px"><i class="fas fa-plus" style="color:var(--primary)"></i><div style="font-weight:700">Novo Item</div></div>
            <div class="text-muted" id="photoCounter">0 fotos</div>
          </div>

          <div>
            <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div class="form-group">
                <label class="form-label">Nº Patrimônio *</label>
                <input id="numeroPatrimonio" class="form-control" />
              </div>
              <div class="form-group">
                <label class="form-label">Equipamento *</label>
                <input id="equipamento" class="form-control" />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Setor</label>
              <input id="setor" class="form-control" />
            </div>

            <div style="display:flex;gap:8px;margin-top:12px">
              <button id="btnSave" class="btn btn-primary">Salvar</button>
              <button id="btnCancel" class="btn btn-ghost">Cancelar</button>
            </div>
          </div>
        </div>

      </section>

      <!-- Right: table & details -->
      <section>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div style="display:flex;align-items:center;gap:8px"><i class="fas fa-list" style="color:var(--primary)"></i><div style="font-weight:700">Itens do Patrimônio</div></div>
            <div class="text-muted" id="filterCount">0 itens</div>
          </div>

          <div class="table-container">
            <table id="patrimonioTable">
              <thead>
                <tr><th>Nº Patrimônio</th><th>Equipamento</th><th>Setor</th><th style="width:150px">Ações</th></tr>
              </thead>
              <tbody id="tableBody">
                <tr><td colspan="4" class="empty-state">Faça login para visualizar os itens</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><i class="fas fa-eye" style="color:var(--primary)"></i><div style="font-weight:700">Detalhes do Item</div></div>
          <div id="viewBox" class="empty-state">
            <i class="fas fa-search"></i>
            <p>Selecione um item para visualizar</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    /*************************************************************************
     * CONFIGURAÇÃO FIREBASE - substitua pelos dados do seu projeto se quiser
     * (usei os dados similares aos que você tinha no arquivo original)
     *************************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyAwCfiEB3JEUu_6rKR32C2E5whnb6-SgX0",
      authDomain: "sis-eetibkp.firebaseapp.com",
      projectId: "sis-eetibkp",
      storageBucket: "sis-eetibkp.firebasestorage.app",
      messagingSenderId: "524123050144",
      appId: "1:524123050144:web:79fba6107cf073118679c5"
    };

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DEMO CREDENTIALS (Opção A)
    const DEMO_EMAIL = "admin@teste.com";
    const DEMO_PASS  = "123456";

    // Elementos da UI
    const loginCard = document.getElementById("loginCard");
    const loginForm = document.getElementById("loginForm");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginError = document.getElementById("loginError");
    const btnCreateDemo = document.getElementById("btnCreateDemo");
    const btnOpenLogin = document.getElementById("btnOpenLogin");
    const btnLogout = document.getElementById("btnLogout");
    const formArea = document.getElementById("formArea");
    const tableBody = document.getElementById("tableBody");
    const filterCount = document.getElementById("filterCount");
    const toastContainer = document.getElementById("toastContainer");
    const leftPanel = document.getElementById("leftPanel");
    const viewBox = document.getElementById("viewBox");
    const onlineText = document.getElementById("onlineText");

    // Controle de visibilidade inicial
    function showOnlyLogin() {
      loginCard.classList.remove("hide");
      formArea.classList.add("hide");
      btnLogout.classList.add("hide");
      btnOpenLogin.classList.remove("hide");
      tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Faça login para visualizar os itens</td></tr>';
      filterCount.textContent = "0 itens";
      viewBox.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>Selecione um item para visualizar</p></div>';
    }

    function showAppForUser(user) {
      loginCard.classList.add("hide");
      formArea.classList.remove("hide");
      btnLogout.classList.remove("hide");
      btnOpenLogin.classList.add("hide");
      showToast('success', `Logado como ${user.email}`);
      // após login, carregue items do Firestore (exemplo)
      loadItems();
    }

    // Toasts simples
    function showToast(type, text) {
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = text;
      if (type === "error") t.style.borderLeftColor = "#ef4444";
      if (type === "success") t.style.borderLeftColor = "#10b981";
      toastContainer.appendChild(t);
      setTimeout(()=> { t.style.opacity = "0"; t.style.transform = "translateX(10px)"; }, 3500);
      setTimeout(()=> t.remove(), 4200);
    }

    // Cria conta demo (ignora se já existir)
    async function createDemoAccount() {
      try {
        await auth.createUserWithEmailAndPassword(DEMO_EMAIL, DEMO_PASS);
        showToast('success', 'Conta de demonstração criada. Você pode entrar com admin@teste.com / 123456');
      } catch (err) {
        if (err.code === 'auth/email-already-in-use') {
          showToast('warning', 'Conta demo já existe. Tente entrar com admin@teste.com');
        } else {
          console.error(err);
          showToast('error', 'Erro ao criar conta demo: ' + err.message);
        }
      }
    }

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.style.display = "none";
      const email = emailInput.value.trim();
      const pass  = passwordInput.value.trim();

      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithEmailAndPassword(email, pass);
        // onAuthStateChanged fará o resto
      } catch (err) {
        console.error(err);
        loginError.textContent = (err.code === 'auth/wrong-password') ? 'Senha incorreta' : err.message;
        loginError.style.display = "block";
        showToast('error', 'Erro de login: ' + err.message);
      }
    });

    btnCreateDemo.addEventListener("click", () => {
      createDemoAccount();
    });

    btnOpenLogin.addEventListener("click", () => {
      // rolar para o login e focar
      loginCard.scrollIntoView({behavior:'smooth',block:'center'});
      emailInput.focus();
    });

    btnLogout.addEventListener("click", async () => {
      try {
        await auth.signOut();
        showOnlyLogin();
        showToast('success', 'Desconectado com sucesso');
      } catch (err) {
        console.error(err);
        showToast('error', 'Erro ao sair: ' + err.message);
      }
    });

    // Monitor de autenticação
    auth.onAuthStateChanged((user) => {
      if (user) {
        showAppForUser(user);
      } else {
        showOnlyLogin();
      }
    });

    // Exemplo: carregar itens do Firestore (coleção "patrimonio") somente após login
    async function loadItems() {
      try {
        const snap = await db.collection('patrimonio').limit(200).get();
        if (snap.empty) {
          tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Nenhum item cadastrado</td></tr>';
          filterCount.textContent = '0 itens';
          return;
        }
        const rows = [];
        snap.forEach(doc => {
          const d = doc.data();
          rows.push({ id: doc.id, ...d });
        });

        filterCount.textContent = `${rows.length} itens`;

        tableBody.innerHTML = rows.map(item => `
          <tr>
            <td>${item.numero || '-'}</td>
            <td>${item.equipamento || '-'}</td>
            <td>${item.setor || '-'}</td>
            <td>
              <button class="btn btn-ghost btn-sm" data-id="${item.id}" onclick="viewItem('${item.id}')"><i class="fas fa-eye"></i> Ver</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
        showToast('error', 'Erro ao carregar itens: ' + err.message);
      }
    }

    // Função global para visualizar item (usada no botão da tabela)
    window.viewItem = async function(id) {
      try {
        const doc = await db.collection('patrimonio').doc(id).get();
        if (!doc.exists) {
          viewBox.innerHTML = '<div class="empty-state">Item não encontrado</div>';
          return;
        }
        const data = doc.data();
        viewBox.innerHTML = `
          <div style="padding:10px">
            <h3 style="margin-bottom:8px">${data.equipamento || 'Sem nome'}</h3>
            <div class="text-muted" style="margin-bottom:8px">Nº Patrimônio: ${data.numero || '-'}</div>
            <div style="margin-bottom:8px">Setor: ${data.setor || '-'}</div>
            <div style="margin-top:12px">${data.configuracao ? '<pre style="white-space:pre-wrap;background:#f7f7f7;padding:10px;border-radius:6px">'+data.configuracao+'</pre>':''}</div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        showToast('error', 'Erro ao carregar item: ' + err.message);
      }
    };

    // Salvar novo item (apenas disponível se estiver logado)
    document.getElementById('btnSave').addEventListener('click', async () => {
      const numero = document.getElementById('numeroPatrimonio').value.trim();
      const equipamento = document.getElementById('equipamento').value.trim();
      const setor = document.getElementById('setor').value.trim();
      if (!numero || !equipamento) { showToast('error','Preencha Nº Patrimônio e Equipamento'); return; }
      try {
        const docRef = await db.collection('patrimonio').add({ numero, equipamento, setor, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        showToast('success', 'Item salvo: ' + docRef.id);
        // limpa campos
        document.getElementById('numeroPatrimonio').value = '';
        document.getElementById('equipamento').value = '';
        document.getElementById('setor').value = '';
        // recarrega itens
        loadItems();
      } catch (err) {
        console.error(err);
        showToast('error', 'Erro ao salvar: ' + err.message);
      }
    });

    // Cancelar edição
    document.getElementById('btnCancel').addEventListener('click', () => {
      document.getElementById('numeroPatrimonio').value = '';
      document.getElementById('equipamento').value = '';
      document.getElementById('setor').value = '';
      showToast('success','Formulário limpo');
    });

    // Conectividade / estado online
    function updateOnlineStatus() {
      const on = navigator.onLine;
      onlineText.textContent = on ? 'Online' : 'Offline';
      document.getElementById('onlineStatus').classList.toggle('status-offline', !on);
    }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

    // Inicializa: tenta criar conta demo silenciosamente para facilitar testes
    (async function init() {
      // não sobrescreve se já existir
      try {
        await auth.createUserWithEmailAndPassword(DEMO_EMAIL, DEMO_PASS);
        console.log('Conta demo criada:', DEMO_EMAIL);
      } catch (err) {
        if (err.code !== 'auth/email-already-in-use' && err.code !== 'auth/invalid-email') {
          console.warn('Erro ao criar conta demo (ignorado):', err.message);
        }
      }
      // Apenas garantir que a UI inicial fique correta até o listener de auth rodar
      showOnlyLogin();
    })();

  </script>
</body>
</html>
