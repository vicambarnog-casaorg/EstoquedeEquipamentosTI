<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Patrimônio TI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#111;color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
main{padding:20px}
.card{background:#fff;border-radius:10px;padding:16px;margin-bottom:16px}
.hidden{display:none}
input, textarea{padding:8px;width:100%;box-sizing:border-box;font-family:Arial}
textarea{min-height:80px;resize:vertical}
button{padding:8px 12px;border:0;border-radius:6px;cursor:pointer}
.btn{background:#2563eb;color:#fff}
.btn-edit{background:#f59e0b;color:#fff}
.btn-delete{background:#dc2626;color:#fff}
.btn-cancel{background:#6b7280;color:#fff}
.btn-history{background:#10b981;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
.photo-thumbnail{width:70px;height:70px;object-fit:cover;border-radius:6px;margin-right:4px;cursor:pointer;transition:transform 0.2s}
.photo-thumbnail:hover{transform:scale(1.05)}
.action-buttons{display:flex;gap:5px;flex-wrap:wrap}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1000;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
.image-modal{background:rgba(0,0,0,0.95);cursor:pointer}
.image-modal-content{background:transparent;padding:0;max-width:90vw;max-height:90vh;width:auto;display:flex;align-items:center;justify-content:center}
.image-modal-img{max-width:100%;max-height:90vh;object-fit:contain;border-radius:5px}
.image-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.3s}
.image-nav:hover{background:rgba(255,255,255,0.4)}
.image-nav.prev{left:20px}
.image-nav.next{right:20px}
.image-counter{position:absolute;bottom:20px;left:0;right:0;text-align:center;color:white;font-size:16px}
.image-close{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.2);color:white;border:none;width:40px;height:40px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.image-close:hover{background:rgba(255,255,255,0.4)}
.photo-container{display:flex;flex-wrap:wrap;gap:5px;align-items:center}
.photo-wrapper{position:relative}
.loading-spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #2563eb;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-right: 8px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.history-item {
  background: #f8fafc;
  border-left: 4px solid #2563eb;
  padding: 10px;
  margin: 5px 0;
  border-radius: 4px;
}
.history-date {
  font-weight: bold;
  color: #374151;
  font-size: 14px;
}
.history-text {
  color: #4b5563;
  margin-top: 5px;
}
.history-author {
  font-size: 12px;
  color: #6b7280;
  text-align: right;
  margin-top: 5px;
}
.history-container {
  max-height: 200px;
  overflow-y: auto;
  margin-top: 10px;
  padding: 10px;
  background: #f9fafb;
  border-radius: 6px;
}
.form-row {
  display: flex;
  gap: 15px;
  margin-bottom: 12px;
}
.form-row > div {
  flex: 1;
}
.form-row label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #374151;
}
</style>
</head>
<body>

<header>
  <div>Patrimônio TI</div>
  <div>
    <span id="userEmail"></span>
    <button id="logoutBtn" class="btn hidden">Sair</button>
  </div>
</header>

<main>
  <!-- Modal para Visualização de Imagem -->
  <div id="imageModal" class="modal image-modal">
    <div class="image-modal-content">
      <button class="image-nav prev" onclick="navImage(-1)">❮</button>
      <img id="modalImage" class="image-modal-img" src="" alt="Imagem ampliada">
      <button class="image-nav next" onclick="navImage(1)">❯</button>
      <button class="image-close" onclick="fecharModalImagem()">×</button>
      <div id="imageCounter" class="image-counter"></div>
    </div>
  </div>

  <!-- Modal para Edição -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>Editar Produto</h3>
      
      <div class="form-row">
        <div>
          <label>Número do patrimônio *</label>
          <input id="editNumero" placeholder="Ex: 001234">
        </div>
        <div>
          <label>Setor *</label>
          <input id="editSetor" placeholder="Ex: TI, Administrativo">
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label>Equipamento *</label>
          <input id="editEquipamento" placeholder="Ex: Notebook, Desktop">
        </div>
        <div>
          <label>Modelo</label>
          <input id="editModelo" placeholder="Ex: Dell Latitude 5420">
        </div>
      </div>
      
      <div style="margin-bottom:12px">
        <label>Configuração</label>
        <textarea id="editConfiguracao" placeholder="Processador, RAM, HD, etc."></textarea>
      </div>
      
      <div id="editCurrentPhotos" style="margin-bottom:10px"></div>
      
      <div id="editPhotoUploadContainer">
        <label>Adicionar mais fotos</label>
        <input type="file" id="editPhotoUpload" multiple accept="image/*" style="margin-bottom:10px">
        <div id="uploadStatusEdit" style="margin:5px 0;font-size:14px;color:#666;display:none">
          <span class="loading-spinner"></span><span id="statusTextEdit">Enviando imagens...</span>
        </div>
        <div id="editPreview" style="margin-top:10px"></div>
      </div>
      
      <br>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="cancelEditBtn" class="btn-cancel">Cancelar</button>
        <button id="updateProductBtn" class="btn">Atualizar</button>
      </div>
      <p id="editError" style="color:red;display:none"></p>
    </div>
  </div>

  <!-- Modal para Histórico de Manutenção -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <h3>Histórico de Manutenção</h3>
      <p><strong>Produto:</strong> <span id="historyProductTitle"></span></p>
      
      <div style="margin:15px 0">
        <label>Adicionar nova entrada ao histórico:</label>
        <textarea id="newHistoryEntry" placeholder="Descreva o que foi feito na manutenção..."></textarea>
        <button id="addHistoryBtn" class="btn" style="margin-top:8px">Adicionar ao Histórico</button>
      </div>
      
      <h4>Histórico:</h4>
      <div id="historyList" class="history-container"></div>
      
      <br>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button onclick="fecharModalHistorico()" class="btn-cancel">Fechar</button>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h3>Login</h3>
    <input id="email" placeholder="Email">
    <br><br>
    <input id="password" type="password" placeholder="Senha">
    <br><br>
    <button id="loginBtn" class="btn">Entrar</button>
    <p id="loginError" style="color:red;display:none"></p>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <!-- Formulário Principal -->
    <div class="card">
      <h3>Novo Produto</h3>
      
      <div class="form-row">
        <div>
          <label>Número do patrimônio *</label>
          <input id="numero" placeholder="Ex: 001234">
        </div>
        <div>
          <label>Setor alocado *</label>
          <input id="setor" placeholder="Ex: TI, Administrativo">
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label>Equipamento *</label>
          <input id="equipamento" placeholder="Ex: Notebook, Desktop">
        </div>
        <div>
          <label>Modelo</label>
          <input id="modelo" placeholder="Ex: Dell Latitude 5420">
        </div>
      </div>
      
      <div style="margin-bottom:12px">
        <label>Configuração</label>
        <textarea id="configuracao" placeholder="Processador: i5-11400H, RAM: 16GB, SSD: 512GB, etc."></textarea>
      </div>
      
      <div style="margin-bottom:12px">
        <label>Histórico de Manutenção (opcional)</label>
        <textarea id="historico" placeholder="Ex: 15/01/2024 - Troca de pasta térmica"></textarea>
        <small style="color:#666">Pode deixar em branco e adicionar depois</small>
      </div>

      <label>Fotos do equipamento</label>
      <input type="file" id="photoUpload" multiple accept="image/*" style="margin-bottom:10px">
      <div id="uploadStatus" style="margin:5px 0;font-size:14px;color:#666;display:none">
        <span class="loading-spinner"></span><span id="statusText">Comprimindo e enviando imagens...</span>
      </div>

      <div id="preview" style="margin-top:10px" class="photo-container"></div>
      <br>

      <button id="saveProductBtn" class="btn">Salvar produto</button>
      <p id="saveError" style="color:red;display:none"></p>
    </div>

    <!-- Lista de Produtos -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3 style="margin:0">Produtos cadastrados</h3>
        <button id="refreshBtn" class="btn">Atualizar lista</button>
      </div>
      
      <div style="margin-bottom:10px">
        <input type="text" id="searchInput" placeholder="Buscar por número, equipamento, modelo ou setor..." style="width:100%">
      </div>
      
      <table>
        <thead>
          <tr>
            <th>Nº Patrimônio</th>
            <th>Equipamento</th>
            <th>Modelo</th>
            <th>Setor</th>
            <th>Fotos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
      <p id="loadError" style="color:red;display:none"></p>
      <div id="pagination" style="margin-top:10px;text-align:center;display:none">
        <button id="prevPage" class="btn-cancel">Anterior</button>
        <span id="pageInfo" style="margin:0 10px">Página 1</span>
        <button id="nextPage" class="btn-cancel">Próxima</button>
      </div>
    </div>
  </div>
</main>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  query, 
  orderBy, 
  deleteDoc, 
  doc, 
  updateDoc,
  Timestamp,
  where,
  or,
  limit,
  startAfter,
  getCountFromServer,
  arrayUnion,
  arrayRemove
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwCfiEB3JEUu_6rKR32C2E5whnb6-SgX0",
  authDomain: "sis-eetibkp.firebaseapp.com",
  projectId: "sis-eetibkp"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Configuração do ImgBB
const IMGBB_API_KEY = 'f79456acbdeadef07393b773e313a05d';

// Variáveis globais
let fotoBase64 = []; // Armazena objetos {url, thumb, localPreview}
let editFotoBase64 = []; // Para edição
let lastVisible = null;
let currentPage = 1;
const itemsPerPage = 10;
let currentProductId = null;
let currentImageIndex = 0;
let currentImages = [];
let currentHistoryProductId = null;

// Configurar eventos quando o DOM carregar
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM carregado');
  
  // Configurar todos os event listeners
  setupEventListeners();
});

function setupEventListeners() {
  // Botões principais
  const loginBtn = document.getElementById("loginBtn");
  const saveProductBtn = document.getElementById("saveProductBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const searchInput = document.getElementById("searchInput");
  const addHistoryBtn = document.getElementById("addHistoryBtn");
  
  // Upload de fotos
  const photoUpload = document.getElementById("photoUpload");
  const editPhotoUpload = document.getElementById("editPhotoUpload");
  
  // Botões do modal de edição
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const updateProductBtn = document.getElementById("updateProductBtn");
  const editModal = document.getElementById("editModal");
  
  // Botões do modal de histórico
  if (addHistoryBtn) {
    addHistoryBtn.addEventListener('click', adicionarEntradaHistorico);
  }
  
  // Botões de paginação
  const prevPageBtn = document.getElementById("prevPage");
  const nextPageBtn = document.getElementById("nextPage");
  
  // Event Listeners principais
  if (loginBtn) loginBtn.addEventListener('click', login);
  if (saveProductBtn) saveProductBtn.addEventListener('click', salvarProduto);
  if (logoutBtn) logoutBtn.addEventListener('click', logout);
  if (refreshBtn) refreshBtn.addEventListener('click', () => {
    currentPage = 1;
    lastVisible = null;
    carregarProdutos();
  });
  
  // Upload de fotos - novo produto
  if (photoUpload) {
    photoUpload.addEventListener('change', async function(e) {
      await handleImageUpload(e, 'preview', fotoBase64, 'uploadStatus', 'statusText');
    });
  }
  
  // Upload de fotos - edição
  if (editPhotoUpload) {
    editPhotoUpload.addEventListener('change', async function(e) {
      await handleImageUpload(e, 'editPreview', editFotoBase64, 'uploadStatusEdit', 'statusTextEdit');
    });
  }
  
  // Busca
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.trim();
      if (searchTerm.length >= 2 || searchTerm.length === 0) {
        setTimeout(() => buscarProdutos(searchTerm), 300);
      }
    });
  }
  
  // Modal de edição
  if (cancelEditBtn) cancelEditBtn.addEventListener('click', fecharModalEdicao);
  if (updateProductBtn) updateProductBtn.addEventListener('click', atualizarProduto);
  
  // Fechar modais ao clicar fora
  const modals = [document.getElementById("editModal"), document.getElementById("imageModal"), document.getElementById("historyModal")];
  modals.forEach(modal => {
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          if (modal.id === "editModal") fecharModalEdicao();
          if (modal.id === "imageModal") fecharModalImagem();
          if (modal.id === "historyModal") fecharModalHistorico();
        }
      });
    }
  });
  
  // Fechar modal de imagem com ESC e navegação com setas
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      fecharModalImagem();
      fecharModalHistorico();
    }
    
    // Navegação com setas no modal de imagem
    if (document.getElementById("imageModal").style.display === 'flex') {
      if (e.key === 'ArrowLeft') navImage(-1);
      if (e.key === 'ArrowRight') navImage(1);
    }
  });
  
  // Paginação
  if (prevPageBtn) prevPageBtn.addEventListener('click', paginaAnterior);
  if (nextPageBtn) nextPageBtn.addEventListener('click', proximaPagina);
  
  // Permitir Enter no login
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  
  if (emailInput && passwordInput) {
    emailInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
    
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
  }
}

// =============================================
// FUNÇÕES DE COMPRESSÃO E UPLOAD DE IMAGENS
// =============================================

// Função para comprimir imagem para ~100KB
async function compressImage(file, maxSizeKB = 100) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Redimensionar se muito grande (mantém proporção)
        const maxDimension = 1200;
        if (width > maxDimension || height > maxDimension) {
          if (width > height) {
            height = Math.round((height * maxDimension) / width);
            width = maxDimension;
          } else {
            width = Math.round((width * maxDimension) / height);
            height = maxDimension;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Qualidade inicial
        let quality = 0.8;
        let base64;
        
        // Tentar diferentes qualidades
        for (let i = 0; i < 5; i++) {
          base64 = canvas.toDataURL('image/jpeg', quality);
          const sizeKB = (base64.length * 3) / 4 / 1024;
          
          if (sizeKB <= maxSizeKB || quality <= 0.3) {
            break;
          }
          quality -= 0.15;
        }
        
        // Se ainda muito grande, reduzir dimensões
        if ((base64.length * 3) / 4 / 1024 > maxSizeKB) {
          canvas.width = Math.round(width * 0.7);
          canvas.height = Math.round(height * 0.7);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          base64 = canvas.toDataURL('image/jpeg', 0.6);
        }
        
        console.log(`Imagem comprimida: ${Math.round((base64.length * 3) / 4 / 1024)}KB`);
        resolve(base64);
      };
      
      img.onerror = reject;
    };
    
    reader.onerror = reject;
  });
}

// Função para upload no ImgBB
async function uploadToImgBB(base64Image) {
  try {
    const base64Data = base64Image.includes(',') 
      ? base64Image.split(',')[1] 
      : base64Image;
    
    const formData = new FormData();
    formData.append('image', base64Data);
    
    console.log('Enviando para ImgBB...');
    
    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error?.message || 'Falha no upload');
    }
    
    return {
      url: data.data.url,
      thumb: data.data.thumb?.url || data.data.url,
      deleteUrl: data.data.delete_url
    };
    
  } catch (error) {
    console.error('Erro no ImgBB:', error);
    throw new Error('Falha ao enviar imagem: ' + error.message);
  }
}

// Função principal para lidar com upload de imagens
async function handleImageUpload(event, previewId, storageArray, statusId, statusTextId) {
  const files = event.target.files;
  const preview = document.getElementById(previewId);
  const uploadStatus = document.getElementById(statusId);
  const statusText = document.getElementById(statusTextId);
  
  if (!preview || !files.length) return;
  
  // Mostrar status de upload
  if (uploadStatus && statusText) {
    uploadStatus.style.display = 'block';
  }
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    
    if (!file.type.match('image.*')) {
      alert('Por favor, selecione apenas imagens (JPG, PNG, etc).');
      continue;
    }
    
    if (file.size > 32 * 1024 * 1024) {
      alert('Imagem muito grande! Máximo: 32MB');
      continue;
    }
    
    try {
      // Atualizar status
      if (statusText) {
        statusText.textContent = `Comprimindo imagem ${i + 1}/${files.length}...`;
      }
      
      // Comprimir imagem para ~100KB
      const compressedBase64 = await compressImage(file, 100);
      
      // Atualizar status
      if (statusText) {
        statusText.textContent = `Enviando imagem ${i + 1}/${files.length} para ImgBB...`;
      }
      
      // Upload para ImgBB
      const imgbbResult = await uploadToImgBB(compressedBase64);
      
      // Armazenar objeto com URL
      storageArray.push({
        url: imgbbResult.url,
        thumb: imgbbResult.thumb,
        localPreview: compressedBase64
      });
      
      // Adicionar preview
      const index = storageArray.length - 1;
      preview.innerHTML += `
        <div class="photo-wrapper">
          <img src="${compressedBase64}" 
               class="photo-thumbnail" 
               data-index="${index}"
               data-url="${imgbbResult.url}"
               onclick="visualizarImagemFromArray(${index})"
               title="Clique para ampliar">
        </div>`;
        
    } catch (error) {
      console.error('Erro no upload:', error);
      alert(`Erro na imagem ${i + 1}: ${error.message}`);
      break;
    }
  }
  
  // Esconder status de upload
  if (uploadStatus) {
    uploadStatus.style.display = 'none';
  }
  
  // Limpar input
  event.target.value = '';
}

// =============================================
// FUNÇÕES DE AUTENTICAÇÃO
// =============================================

async function login() {
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginError = document.getElementById("loginError");
  
  if (!emailInput || !passwordInput) return;
  
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  
  if (!email || !password) {
    if (loginError) {
      loginError.textContent = "Por favor, preencha email e senha";
      loginError.style.display = "block";
    }
    return;
  }
  
  try {
    if (loginError) loginError.style.display = "none";
    await signInWithEmailAndPassword(auth, email, password);
  } catch (error) {
    console.error("Erro no login:", error);
    if (loginError) {
      loginError.textContent = "Erro no login: " + error.message;
      loginError.style.display = "block";
    }
  }
}

async function logout() {
  try {
    await signOut(auth);
  } catch (error) {
    console.error("Erro ao sair:", error);
  }
}

onAuthStateChanged(auth, user => {
  const loginCard = document.getElementById("loginCard");
  const app = document.getElementById("app");
  const logoutBtn = document.getElementById("logoutBtn");
  const userEmail = document.getElementById("userEmail");
  
  if (user) {
    if (loginCard) loginCard.classList.add("hidden");
    if (app) app.classList.remove("hidden");
    if (logoutBtn) logoutBtn.classList.remove("hidden");
    if (userEmail) userEmail.innerText = user.email;
    
    carregarProdutos();
  } else {
    if (loginCard) loginCard.classList.remove("hidden");
    if (app) app.classList.add("hidden");
    if (logoutBtn) logoutBtn.classList.add("hidden");
    if (userEmail) userEmail.innerText = "";
    
    const lista = document.getElementById("lista");
    if (lista) lista.innerHTML = "";
    
    const loadError = document.getElementById("loadError");
    if (loadError) loadError.style.display = "none";
    
    const pagination = document.getElementById("pagination");
    if (pagination) pagination.style.display = "none";
  }
});

// =============================================
// FUNÇÕES DO FIRESTORE
// =============================================

async function carregarProdutos() {
  const lista = document.getElementById("lista");
  const loadError = document.getElementById("loadError");
  const pagination = document.getElementById("pagination");
  const pageInfo = document.getElementById("pageInfo");
  
  if (!lista) return;
  
  try {
    if (loadError) loadError.style.display = "none";
    
    let produtosQuery;
    
    if (currentPage === 1) {
      produtosQuery = query(
        collection(db, "produtos"),
        orderBy("timestamp", "desc"),
        limit(itemsPerPage)
      );
      lastVisible = null;
    } else {
      produtosQuery = query(
        collection(db, "produtos"),
        orderBy("timestamp", "desc"),
        startAfter(lastVisible),
        limit(itemsPerPage)
      );
    }
    
    const querySnapshot = await getDocs(produtosQuery);
    
    if (!querySnapshot.empty) {
      lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
    }
    
    atualizarListaProdutos(querySnapshot);
    
    if (pagination && pageInfo) {
      const totalCount = await getTotalCount();
      const totalPages = Math.ceil(totalCount / itemsPerPage);
      
      if (totalPages > 1) {
        pagination.style.display = "block";
        pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
        
        document.getElementById("prevPage").disabled = currentPage === 1;
        document.getElementById("nextPage").disabled = currentPage === totalPages;
      } else {
        pagination.style.display = "none";
      }
    }
    
  } catch (error) {
    console.error("Erro ao carregar produtos:", error);
    if (loadError) {
      loadError.textContent = "Erro ao carregar produtos: " + error.message;
      loadError.style.display = "block";
    }
  }
}

async function getTotalCount() {
  const countQuery = query(collection(db, "produtos"));
  const snapshot = await getCountFromServer(countQuery);
  return snapshot.data().count;
}

function atualizarListaProdutos(querySnapshot) {
  const lista = document.getElementById("lista");
  if (!lista) return;
  
  lista.innerHTML = "";
  
  if (querySnapshot.empty) {
    lista.innerHTML = '<tr><td colspan="6" style="text-align:center">Nenhum produto cadastrado</td></tr>';
    return;
  }
  
  querySnapshot.forEach(doc => {
    const produto = doc.data();
    const produtoId = doc.id;
    const fotoUrlsArray = produto.fotos || [];
    
    let fotosHTML = "Nenhuma foto";
    if (fotoUrlsArray.length > 0) {
      fotosHTML = '<div class="photo-container">';
      fotoUrlsArray.forEach((url, index) => {
        fotosHTML += `
          <div class="photo-wrapper">
            <img src="${url}" 
                 class="photo-thumbnail" 
                 onclick="visualizarImagemFromList('${produtoId}', ${index})"
                 title="Clique para ampliar"
                 onerror="this.onerror=null; this.src='https://via.placeholder.com/70?text=Imagem'">
          </div>`;
      });
      fotosHTML += '</div>';
    }
    
    lista.innerHTML += `
      <tr id="produto-${produtoId}">
        <td><strong>${produto.numero || ''}</strong></td>
        <td>${produto.equipamento || ''}</td>
        <td>${produto.modelo || '-'}</td>
        <td>${produto.setor || ''}</td>
        <td>${fotosHTML}</td>
        <td>
          <div class="action-buttons">
            <button class="btn-history" onclick="abrirModalHistorico('${produtoId}', '${produto.numero || ''} - ${produto.equipamento || ''}')">Histórico</button>
            <button class="btn-edit" onclick="editarProduto('${produtoId}')">Editar</button>
            <button class="btn-delete" onclick="confirmarExclusao('${produtoId}', '${produto.numero || ''}')">Excluir</button>
          </div>
        </td>
      </tr>`;
  });
}

async function buscarProdutos(termo) {
  const lista = document.getElementById("lista");
  const loadError = document.getElementById("loadError");
  const pagination = document.getElementById("pagination");
  
  if (!lista) return;
  
  if (!termo || termo.trim() === "") {
    carregarProdutos();
    return;
  }
  
  try {
    if (loadError) loadError.style.display = "none";
    if (pagination) pagination.style.display = "none";
    
    const produtosQuery = query(
      collection(db, "produtos"),
      or(
        where("numero", ">=", termo),
        where("numero", "<=", termo + "\uf8ff"),
        where("equipamento", ">=", termo),
        where("equipamento", "<=", termo + "\uf8ff"),
        where("modelo", ">=", termo),
        where("modelo", "<=", termo + "\uf8ff"),
        where("setor", ">=", termo),
        where("setor", "<=", termo + "\uf8ff")
      )
    );
    
    const querySnapshot = await getDocs(produtosQuery);
    atualizarListaProdutos(querySnapshot);
    
  } catch (error) {
    console.error("Erro na busca:", error);
    if (loadError) {
      loadError.textContent = "Erro na busca: " + error.message;
      loadError.style.display = "block";
    }
  }
}

async function proximaPagina() {
  currentPage++;
  await carregarProdutos();
}

async function paginaAnterior() {
  if (currentPage > 1) {
    currentPage--;
    await carregarProdutos();
  }
}

// =============================================
// FUNÇÕES DE VISUALIZAÇÃO DE IMAGENS
// =============================================

function visualizarImagemFromArray(index) {
  if (!fotoBase64[index]) return;
  const url = fotoBase64[index].url || fotoBase64[index].localPreview;
  visualizarImagemModalComTodas([url], 0);
}

function visualizarImagemFromList(produtoId, index) {
  const container = document.querySelector(`#produto-${produtoId} .photo-container`);
  if (!container) return;
  
  const images = container.querySelectorAll('img');
  const imageUrls = [];
  images.forEach(img => {
    imageUrls.push(img.src);
  });
  
  visualizarImagemModalComTodas(imageUrls, index);
}

function visualizarImagemModalComTodas(imageUrls, startIndex) {
  currentImages = imageUrls;
  currentImageIndex = startIndex;
  
  const modalImage = document.getElementById("modalImage");
  const imageCounter = document.getElementById("imageCounter");
  const imageModal = document.getElementById("imageModal");
  const prevBtn = document.querySelector('.image-nav.prev');
  const nextBtn = document.querySelector('.image-nav.next');
  
  if (modalImage && imageCounter && imageModal) {
    modalImage.src = currentImages[currentImageIndex];
    imageCounter.textContent = (currentImageIndex + 1) + ' / ' + currentImages.length;
    imageModal.style.display = "flex";
    
    // Mostrar/ocultar botões de navegação
    if (prevBtn && nextBtn) {
      prevBtn.style.display = currentImages.length > 1 ? 'flex' : 'none';
      nextBtn.style.display = currentImages.length > 1 ? 'flex' : 'none';
    }
  }
}

function navImage(direction) {
  if (!currentImages || !currentImages.length) return;
  
  currentImageIndex += direction;
  
  if (currentImageIndex < 0) {
    currentImageIndex = currentImages.length - 1;
  } else if (currentImageIndex >= currentImages.length) {
    currentImageIndex = 0;
  }
  
  const modalImage = document.getElementById("modalImage");
  const imageCounter = document.getElementById("imageCounter");
  
  if (modalImage && imageCounter) {
    modalImage.src = currentImages[currentImageIndex];
    imageCounter.textContent = (currentImageIndex + 1) + ' / ' + currentImages.length;
  }
}

function fecharModalImagem() {
  const imageModal = document.getElementById("imageModal");
  if (imageModal) {
    imageModal.style.display = "none";
  }
  currentImages = [];
  currentImageIndex = 0;
}

// =============================================
// FUNÇÕES DE EDIÇÃO
// =============================================

function abrirModalEdicao(produtoId, produto) {
  currentProductId = produtoId;
  
  document.getElementById("editNumero").value = produto.numero || "";
  document.getElementById("editEquipamento").value = produto.equipamento || "";
  document.getElementById("editSetor").value = produto.setor || "";
  document.getElementById("editModelo").value = produto.modelo || "";
  document.getElementById("editConfiguracao").value = produto.configuracao || "";
  
  const editCurrentPhotos = document.getElementById("editCurrentPhotos");
  editCurrentPhotos.innerHTML = "<strong>Fotos atuais:</strong><br>";
  
  if (produto.fotos && produto.fotos.length > 0) {
    editCurrentPhotos.innerHTML += '<div class="photo-container">';
    produto.fotos.forEach((url, index) => {
      editCurrentPhotos.innerHTML += `
        <div class="photo-wrapper">
          <img src="${url}" 
               class="photo-thumbnail" 
               onclick="visualizarImagemModalComTodas([${produto.fotos.map(f => `'${f}'`).join(',')}], ${index})"
               title="Clique para ampliar"
               onerror="this.onerror=null; this.src='https://via.placeholder.com/70?text=Imagem'">
        </div>`;
    });
    editCurrentPhotos.innerHTML += '</div>';
  } else {
    editCurrentPhotos.innerHTML += "Nenhuma foto";
  }
  
  editFotoBase64 = [];
  document.getElementById("editPreview").innerHTML = "";
  document.getElementById("editPhotoUpload").value = "";
  
  document.getElementById("editModal").style.display = "flex";
}

function fecharModalEdicao() {
  document.getElementById("editModal").style.display = "none";
  currentProductId = null;
  editFotoBase64 = [];
  document.getElementById("editPreview").innerHTML = "";
  document.getElementById("editError").style.display = "none";
}

async function editarProduto(produtoId) {
  try {
    const produtoDoc = await getDocs(query(collection(db, "produtos"), where("__name__", "==", produtoId)));
    
    if (!produtoDoc.empty) {
      const produto = produtoDoc.docs[0].data();
      abrirModalEdicao(produtoId, produto);
    }
  } catch (error) {
    console.error("Erro ao buscar produto para edição:", error);
    alert("Erro ao carregar produto para edição: " + error.message);
  }
}

async function atualizarProduto() {
  const editNumero = document.getElementById("editNumero");
  const editEquipamento = document.getElementById("editEquipamento");
  const editSetor = document.getElementById("editSetor");
  const editModelo = document.getElementById("editModelo");
  const editConfiguracao = document.getElementById("editConfiguracao");
  const editError = document.getElementById("editError");
  
  if (!currentProductId) return;
  
  const numeroVal = editNumero.value.trim();
  const equipamentoVal = editEquipamento.value.trim();
  const setorVal = editSetor.value.trim();
  const modeloVal = editModelo.value.trim();
  const configuracaoVal = editConfiguracao.value.trim();
  
  if (!numeroVal) {
    alert("Por favor, insira o número do patrimônio");
    editNumero.focus();
    return;
  }
  
  if (!equipamentoVal) {
    alert("Por favor, insira o equipamento");
    editEquipamento.focus();
    return;
  }
  
  try {
    if (editError) editError.style.display = "none";
    
    const produtoRef = doc(db, "produtos", currentProductId);
    const produtoDoc = await getDocs(query(collection(db, "produtos"), where("__name__", "==", currentProductId)));
    
    let fotosAtualizadas = [];
    
    if (!produtoDoc.empty) {
      const produtoAtual = produtoDoc.docs[0].data();
      fotosAtualizadas = [...(produtoAtual.fotos || [])];
    }
    
    const novasFotosUrls = editFotoBase64.map(img => img.url);
    fotosAtualizadas = [...fotosAtualizadas, ...novasFotosUrls];
    
    await updateDoc(produtoRef, {
      numero: numeroVal,
      equipamento: equipamentoVal,
      setor: setorVal,
      modelo: modeloVal,
      configuracao: configuracaoVal,
      fotos: fotosAtualizadas,
      atualizadoEm: Timestamp.now(),
      atualizadoPor: auth.currentUser?.email || "desconhecido"
    });
    
    fecharModalEdicao();
    await carregarProdutos();
    
    alert("✅ Produto atualizado com sucesso!");
    
  } catch (error) {
    console.error("Erro ao atualizar produto:", error);
    if (editError) {
      editError.textContent = "Erro ao atualizar: " + error.message;
      editError.style.display = "block";
    }
    alert("❌ Erro ao atualizar produto: " + error.message);
  }
}

// =============================================
// FUNÇÕES DE HISTÓRICO DE MANUTENÇÃO
// =============================================

async function abrirModalHistorico(produtoId, produtoNome) {
  currentHistoryProductId = produtoId;
  
  document.getElementById("historyProductTitle").textContent = produtoNome;
  document.getElementById("newHistoryEntry").value = "";
  
  await carregarHistorico(produtoId);
  document.getElementById("historyModal").style.display = "flex";
}

function fecharModalHistorico() {
  document.getElementById("historyModal").style.display = "none";
  currentHistoryProductId = null;
}

async function carregarHistorico(produtoId) {
  const historyList = document.getElementById("historyList");
  
  try {
    const produtoDoc = await getDocs(query(collection(db, "produtos"), where("__name__", "==", produtoId)));
    
    if (!produtoDoc.empty) {
      const produto = produtoDoc.docs[0].data();
      const historico = produto.historico || [];
      
      if (historico.length === 0) {
        historyList.innerHTML = '<p style="text-align:center;color:#666">Nenhuma entrada no histórico</p>';
        return;
      }
      
      // Ordenar por data (mais recente primeiro)
      historico.sort((a, b) => new Date(b.data) - new Date(a.data));
      
      let html = '';
      historico.forEach(entry => {
        const date = new Date(entry.data).toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        html += `
          <div class="history-item">
            <div class="history-date">${date}</div>
            <div class="history-text">${entry.texto}</div>
            <div class="history-author">Registrado por: ${entry.autor || 'Sistema'}</div>
          </div>
        `;
      });
      
      historyList.innerHTML = html;
    }
  } catch (error) {
    console.error("Erro ao carregar histórico:", error);
    historyList.innerHTML = '<p style="color:red">Erro ao carregar histórico</p>';
  }
}

async function adicionarEntradaHistorico() {
  const newHistoryEntry = document.getElementById("newHistoryEntry");
  const texto = newHistoryEntry.value.trim();
  
  if (!texto) {
    alert("Por favor, descreva o que foi feito na manutenção");
    newHistoryEntry.focus();
    return;
  }
  
  if (!currentHistoryProductId) return;
  
  try {
    const produtoRef = doc(db, "produtos", currentHistoryProductId);
    const usuario = auth.currentUser?.email || "Sistema";
    const dataAtual = new Date().toISOString();
    
    const novaEntrada = {
      data: dataAtual,
      texto: texto,
      autor: usuario
    };
    
    // Adicionar ao array de histórico
    await updateDoc(produtoRef, {
      historico: arrayUnion(novaEntrada)
    });
    
    // Limpar campo e recarregar
    newHistoryEntry.value = "";
    await carregarHistorico(currentHistoryProductId);
    
    alert("✅ Entrada adicionada ao histórico!");
    
  } catch (error) {
    console.error("Erro ao adicionar histórico:", error);
    alert("❌ Erro ao adicionar entrada: " + error.message);
  }
}

// =============================================
// FUNÇÕES DE EXCLUSÃO
// =============================================

async function confirmarExclusao(produtoId, numero) {
  if (confirm("Tem certeza que deseja excluir o patrimônio " + numero + "? Esta ação não pode ser desfeita.")) {
    try {
      await excluirProduto(produtoId);
    } catch (error) {
      console.error("Erro ao excluir:", error);
      alert("Erro ao excluir produto: " + error.message);
    }
  }
}

async function excluirProduto(produtoId) {
  try {
    await deleteDoc(doc(db, "produtos", produtoId));
    
    const elemento = document.getElementById("produto-" + produtoId);
    if (elemento) {
      elemento.remove();
    }
    
    const lista = document.getElementById("lista");
    if (lista && lista.children.length === 1) {
      carregarProdutos();
    }
    
    alert("✅ Produto excluído com sucesso!");
    
  } catch (error) {
    console.error("Erro ao excluir produto:", error);
    throw error;
  }
}

// =============================================
// SALVAR NOVO PRODUTO
// =============================================

async function salvarProduto() {
  const numero = document.getElementById("numero");
  const equipamento = document.getElementById("equipamento");
  const setor = document.getElementById("setor");
  const modelo = document.getElementById("modelo");
  const configuracao = document.getElementById("configuracao");
  const historicoInicial = document.getElementById("historico");
  const preview = document.getElementById("preview");
  const saveError = document.getElementById("saveError");
  const uploadStatus = document.getElementById("uploadStatus");
  
  const numeroVal = numero.value.trim();
  const equipamentoVal = equipamento.value.trim();
  const setorVal = setor.value.trim();
  const modeloVal = modelo.value.trim();
  const configuracaoVal = configuracao.value.trim();
  const historicoInicialVal = historicoInicial.value.trim();
  
  if (!numeroVal) {
    alert("Por favor, insira o número do patrimônio");
    numero.focus();
    return;
  }
  
  if (!equipamentoVal) {
    alert("Por favor, insira o equipamento");
    equipamento.focus();
    return;
  }
  
  if (!setorVal) {
    alert("Por favor, insira o setor alocado");
    setor.focus();
    return;
  }
  
  if (uploadStatus && uploadStatus.style.display === 'block') {
    alert("Aguarde o upload das imagens terminar antes de salvar.");
    return;
  }
  
  try {
    if (saveError) saveError.style.display = "none";
    
    // Extrair URLs do ImgBB
    const fotosUrls = fotoBase64.map(img => img.url);
    
    // Preparar histórico inicial se houver
    let historicoArray = [];
    if (historicoInicialVal) {
      historicoArray.push({
        data: new Date().toISOString(),
        texto: historicoInicialVal,
        autor: auth.currentUser?.email || "Sistema"
      });
    }
    
    await addDoc(collection(db, "produtos"), {
      numero: numeroVal,
      equipamento: equipamentoVal,
      setor: setorVal,
      modelo: modeloVal,
      configuracao: configuracaoVal,
      fotos: fotosUrls,
      historico: historicoArray,
      timestamp: Timestamp.now(),
      criadoPor: auth.currentUser?.email || "desconhecido"
    });
    
    // Limpar tudo
    numero.value = "";
    equipamento.value = "";
    setor.value = "";
    modelo.value = "";
    configuracao.value = "";
    historicoInicial.value = "";
    fotoBase64 = [];
    if (preview) preview.innerHTML = "";
    document.getElementById("photoUpload").value = "";
    
    // Recarregar lista
    currentPage = 1;
    lastVisible = null;
    await carregarProdutos();
    
    alert("✅ Produto salvo com sucesso!");
    
  } catch (error) {
    console.error("Erro ao salvar produto:", error);
    if (saveError) {
      saveError.textContent = "Erro ao salvar: " + error.message;
      saveError.style.display = "block";
    }
    alert("❌ Erro ao salvar produto: " + error.message);
  }
}

// =============================================
// EXPORTAR FUNÇÕES PARA ESCOPO GLOBAL
// =============================================

window.editarProduto = editarProduto;
window.confirmarExclusao = confirmarExclusao;
window.visualizarImagemModalComTodas = visualizarImagemModalComTodas;
window.visualizarImagemFromArray = visualizarImagemFromArray;
window.visualizarImagemFromList = visualizarImagemFromList;
window.navImage = navImage;
window.fecharModalImagem = fecharModalImagem;
window.abrirModalHistorico = abrirModalHistorico;
window.fecharModalHistorico = fecharModalHistorico;
</script>

</body>
</html>
