<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Patrim√¥nio TI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#111;color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
main{padding:20px}
.card{background:#fff;border-radius:10px;padding:16px;margin-bottom:16px}
.hidden{display:none}
input, textarea, select{padding:8px;width:100%;box-sizing:border-box;font-family:Arial}
textarea{min-height:80px;resize:vertical}
button{padding:8px 12px;border:0;border-radius:6px;cursor:pointer}
.btn{background:#2563eb;color:#fff}
.btn-edit{background:#f59e0b;color:#fff}
.btn-delete{background:#dc2626;color:#fff}
.btn-cancel{background:#6b7280;color:#fff}
.btn-history{background:#10b981;color:#fff}
.btn-export{background:#8b5cf6;color:#fff}
.btn-import{background:#06b6d4;color:#fff}
.btn-camera{background:#3b82f6;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
.photo-thumbnail{width:70px;height:70px;object-fit:cover;border-radius:6px;margin-right:4px;cursor:pointer;transition:transform 0.2s}
.photo-thumbnail:hover{transform:scale(1.05)}
.action-buttons{display:flex;gap:5px;flex-wrap:wrap}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1000;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
.image-modal{background:rgba(0,0,0,0.95);cursor:pointer}
.image-modal-content{background:transparent;padding:0;max-width:90vw;max-height:90vh;width:auto;display:flex;align-items:center;justify-content:center}
.image-modal-img{max-width:100%;max-height:90vh;object-fit:contain;border-radius:5px}
.image-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.3s}
.image-nav:hover{background:rgba(255,255,255,0.4)}
.image-nav.prev{left:20px}
.image-nav.next{right:20px}
.image-counter{position:absolute;bottom:20px;left:0;right:0;text-align:center;color:white;font-size:16px}
.image-close{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.2);color:white;border:none;width:40px;height:40px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.image-close:hover{background:rgba(255,255,255,0.4)}
.photo-container{display:flex;flex-wrap:wrap;gap:5px;align-items:center}
.photo-wrapper{position:relative}
.loading-spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #2563eb;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-right: 8px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.history-item {
  background: #f8fafc;
  border-left: 4px solid #2563eb;
  padding: 10px;
  margin: 5px 0;
  border-radius: 4px;
}
.history-date {
  font-weight: bold;
  color: #374151;
  font-size: 14px;
}
.history-text {
  color: #4b5563;
  margin-top: 5px;
}
.history-author {
  font-size: 12px;
  color: #6b7280;
  text-align: right;
  margin-top: 5px;
}
.history-container {
  max-height: 200px;
  overflow-y: auto;
  margin-top: 10px;
  padding: 10px;
  background: #f9fafb;
  border-radius: 6px;
}
.form-row {
  display: flex;
  gap: 15px;
  margin-bottom: 12px;
}
.form-row > div {
  flex: 1;
}
.form-row label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #374151;
}
.camera-container {
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
  text-align: center;
}
.camera-preview {
  width: 100%;
  height: 300px;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 10px;
}
.camera-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.camera-canvas {
  display: none;
}
.camera-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 10px;
}
.import-export-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.instructions {
  background: #f0f9ff;
  border-left: 4px solid #3b82f6;
  padding: 12px;
  margin: 15px 0;
  border-radius: 4px;
}
.instructions h4 {
  margin-top: 0;
  color: #1e40af;
}
.instructions ul {
  margin: 8px 0;
  padding-left: 20px;
}
.instructions li {
  margin: 4px 0;
}
.file-input-container {
  margin: 15px 0;
}
.import-status {
  margin-top: 10px;
  padding: 10px;
  border-radius: 6px;
  display: none;
}
.import-status.success {
  background: #d1fae5;
  color: #065f46;
  display: block;
}
.import-status.error {
  background: #fee2e2;
  color: #991b1b;
  display: block;
}
.import-status.processing {
  background: #fef3c7;
  color: #92400e;
  display: block;
}
.import-summary {
  margin-top: 10px;
  font-size: 14px;
}
</style>
</head>
<body>

<header>
  <div>Patrim√¥nio TI</div>
  <div>
    <span id="userEmail"></span>
    <button id="logoutBtn" class="btn hidden">Sair</button>
  </div>
</header>

<main>
  <!-- Modal para Visualiza√ß√£o de Imagem -->
  <div id="imageModal" class="modal image-modal">
    <div class="image-modal-content">
      <button class="image-nav prev" onclick="navImage(-1)">‚ùÆ</button>
      <img id="modalImage" class="image-modal-img" src="" alt="Imagem ampliada">
      <button class="image-nav next" onclick="navImage(1)">‚ùØ</button>
      <button class="image-close" onclick="fecharModalImagem()">√ó</button>
      <div id="imageCounter" class="image-counter"></div>
    </div>
  </div>

  <!-- Modal para Edi√ß√£o -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>Editar Produto</h3>
      
      <div class="form-row">
        <div>
          <label>N√∫mero do patrim√¥nio *</label>
          <input id="editNumero" placeholder="Ex: 001234">
        </div>
        <div>
          <label>Setor *</label>
          <input id="editSetor" placeholder="Ex: TI, Administrativo">
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label>Equipamento *</label>
          <input id="editEquipamento" placeholder="Ex: Notebook, Desktop">
        </div>
        <div>
          <label>Modelo</label>
          <input id="editModelo" placeholder="Ex: Dell Latitude 5420">
        </div>
      </div>
      
      <div style="margin-bottom:12px">
        <label>Configura√ß√£o</label>
        <textarea id="editConfiguracao" placeholder="Processador, RAM, HD, etc."></textarea>
      </div>
      
      <div id="editCurrentPhotos" style="margin-bottom:10px"></div>
      
      <div id="editPhotoUploadContainer">
        <label>Adicionar mais fotos</label>
        <div style="display:flex;gap:10px;margin-bottom:10px">
          <input type="file" id="editPhotoUpload" multiple accept="image/*" style="flex:1">
          <button id="editCameraBtn" class="btn-camera">üì∑ C√¢mera</button>
        </div>
        <div id="uploadStatusEdit" style="margin:5px 0;font-size:14px;color:#666;display:none">
          <span class="loading-spinner"></span><span id="statusTextEdit">Enviando imagens...</span>
        </div>
        <div id="editPreview" style="margin-top:10px"></div>
      </div>
      
      <br>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="cancelEditBtn" class="btn-cancel">Cancelar</button>
        <button id="updateProductBtn" class="btn">Atualizar</button>
      </div>
      <p id="editError" style="color:red;display:none"></p>
    </div>
  </div>

  <!-- Modal para C√¢mera -->
  <div id="cameraModal" class="modal">
    <div class="modal-content">
      <h3>Tirar Foto</h3>
      <div class="camera-container">
        <div class="camera-preview">
          <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
          <canvas id="cameraCanvas" class="camera-canvas"></canvas>
        </div>
        <div class="camera-controls">
          <button id="captureBtn" class="btn">Tirar Foto</button>
          <button id="retakeBtn" class="btn-cancel" style="display:none">Tirar Outra</button>
          <button id="usePhotoBtn" class="btn" style="display:none">Usar Foto</button>
        </div>
      </div>
      <br>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button onclick="fecharCamera()" class="btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para Importa√ß√£o Excel -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <h3>Importar Produtos do Excel</h3>
      
      <div class="instructions">
        <h4>Instru√ß√µes:</h4>
        <ul>
          <li>Baixe o <a href="#" onclick="baixarModeloExcel()">modelo da planilha</a></li>
          <li>Preencha os dados seguindo o formato</li>
          <li>Colunas obrigat√≥rias: N√∫mero, Equipamento, Setor</li>
          <li>Colunas opcionais: Modelo, Configura√ß√£o</li>
          <li>Envie o arquivo Excel (.xlsx) ou CSV</li>
        </ul>
      </div>
      
      <div class="file-input-container">
        <label>Selecione o arquivo:</label>
        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv">
      </div>
      
      <div id="importStatus" class="import-status"></div>
      
      <div id="importSummary" class="import-summary" style="display:none"></div>
      
      <br>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button onclick="fecharImportModal()" class="btn-cancel">Cancelar</button>
        <button id="importBtn" class="btn-import">Importar</button>
      </div>
    </div>
  </div>

  <!-- Modal para Hist√≥rico de Manuten√ß√£o -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <h3>Hist√≥rico de Manuten√ß√£o</h3>
      <p><strong>Produto:</strong> <span id="historyProductTitle"></span></p>
      
      <div style="margin:15px 0">
        <label>Adicionar nova entrada ao hist√≥rico:</label>
        <textarea id="newHistoryEntry" placeholder="Descreva o que foi feito na manuten√ß√£o..."></textarea>
        <button id="addHistoryBtn" class="btn" style="margin-top:8px">Adicionar ao Hist√≥rico</button>
      </div>
      
      <h4>Hist√≥rico:</h4>
      <div id="historyList" class="history-container"></div>
      
      <br>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button onclick="fecharModalHistorico()" class="btn-cancel">Fechar</button>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h3>Login</h3>
    <input id="email" placeholder="Email">
    <br><br>
    <input id="password" type="password" placeholder="Senha">
    <br><br>
    <button id="loginBtn" class="btn">Entrar</button>
    <p id="loginError" style="color:red;display:none"></p>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <!-- Formul√°rio Principal -->
    <div class="card">
      <h3>Novo Produto</h3>
      
      <div class="form-row">
        <div>
          <label>N√∫mero do patrim√¥nio *</label>
          <input id="numero" placeholder="Ex: 001234">
        </div>
        <div>
          <label>Setor alocado *</label>
          <input id="setor" placeholder="Ex: TI, Administrativo">
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label>Equipamento *</label>
          <input id="equipamento" placeholder="Ex: Notebook, Desktop">
        </div>
        <div>
          <label>Modelo</label>
          <input id="modelo" placeholder="Ex: Dell Latitude 5420">
        </div>
      </div>
      
      <div style="margin-bottom:12px">
        <label>Configura√ß√£o</label>
        <textarea id="configuracao" placeholder="Processador: i5-11400H, RAM: 16GB, SSD: 512GB, etc."></textarea>
      </div>
      
      <div style="margin-bottom:12px">
        <label>Hist√≥rico de Manuten√ß√£o (opcional)</label>
        <textarea id="historico" placeholder="Ex: 15/01/2024 - Troca de pasta t√©rmica"></textarea>
        <small style="color:#666">Pode deixar em branco e adicionar depois</small>
      </div>

      <label>Fotos do equipamento</label>
      <div style="display:flex;gap:10px;margin-bottom:10px">
        <input type="file" id="photoUpload" multiple accept="image/*" style="flex:1">
        <button id="cameraBtn" class="btn-camera">üì∑ C√¢mera</button>
      </div>
      <div id="uploadStatus" style="margin:5px 0;font-size:14px;color:#666;display:none">
        <span class="loading-spinner"></span><span id="statusText">Comprimindo e enviando imagens...</span>
      </div>

      <div id="preview" style="margin-top:10px" class="photo-container"></div>
      <br>

      <button id="saveProductBtn" class="btn">Salvar produto</button>
      <p id="saveError" style="color:red;display:none"></p>
    </div>

    <!-- Lista de Produtos -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3 style="margin:0">Produtos cadastrados</h3>
        <div class="import-export-buttons">
          <button id="exportBtn" class="btn-export">üì• Exportar Excel</button>
          <button id="importModalBtn" class="btn-import">üì§ Importar Excel</button>
          <button id="refreshBtn" class="btn">Atualizar lista</button>
        </div>
      </div>
      
      <div style="margin-bottom:10px">
        <input type="text" id="searchInput" placeholder="Buscar por n√∫mero, equipamento, modelo ou setor..." style="width:100%">
      </div>
      
      <table>
        <thead>
          <tr>
            <th>N¬∫ Patrim√¥nio</th>
            <th>Equipamento</th>
            <th>Modelo</th>
            <th>Setor</th>
            <th>Fotos</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
      <p id="loadError" style="color:red;display:none"></p>
      <div id="pagination" style="margin-top:10px;text-align:center;display:none">
        <button id="prevPage" class="btn-cancel">Anterior</button>
        <span id="pageInfo" style="margin:0 10px">P√°gina 1</span>
        <button id="nextPage" class="btn-cancel">Pr√≥xima</button>
      </div>
    </div>
  </div>
</main>

<!-- Bibliotecas para Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  query, 
  orderBy, 
  deleteDoc, 
  doc, 
  updateDoc,
  Timestamp,
  where,
  or,
  limit,
  startAfter,
  getCountFromServer,
  arrayUnion
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwCfiEB3JEUu_6rKR32C2E5whnb6-SgX0",
  authDomain: "sis-eetibkp.firebaseapp.com",
  projectId: "sis-eetibkp"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Configura√ß√£o do ImgBB
const IMGBB_API_KEY = 'f79456acbdeadef07393b773e313a05d';

// Vari√°veis globais
let fotoBase64 = [];
let editFotoBase64 = [];
let lastVisible = null;
let currentPage = 1;
const itemsPerPage = 10;
let currentProductId = null;
let currentImageIndex = 0;
let currentImages = [];
let currentHistoryProductId = null;
let cameraStream = null;
let currentCameraMode = 'new'; // 'new' ou 'edit'

// Configurar eventos quando o DOM carregar
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM carregado');
  setupEventListeners();
});

function setupEventListeners() {
  // Bot√µes principais
  const loginBtn = document.getElementById("loginBtn");
  const saveProductBtn = document.getElementById("saveProductBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const searchInput = document.getElementById("searchInput");
  const addHistoryBtn = document.getElementById("addHistoryBtn");
  const exportBtn = document.getElementById("exportBtn");
  const importModalBtn = document.getElementById("importModalBtn");
  const importBtn = document.getElementById("importBtn");
  const cameraBtn = document.getElementById("cameraBtn");
  const editCameraBtn = document.getElementById("editCameraBtn");
  
  // Upload de fotos
  const photoUpload = document.getElementById("photoUpload");
  const editPhotoUpload = document.getElementById("editPhotoUpload");
  
  // Bot√µes do modal de edi√ß√£o
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const updateProductBtn = document.getElementById("updateProductBtn");
  
  // Bot√µes da c√¢mera
  const captureBtn = document.getElementById("captureBtn");
  const retakeBtn = document.getElementById("retakeBtn");
  const usePhotoBtn = document.getElementById("usePhotoBtn");
  
  // Event Listeners principais
  if (loginBtn) loginBtn.addEventListener('click', login);
  if (saveProductBtn) saveProductBtn.addEventListener('click', salvarProduto);
  if (logoutBtn) logoutBtn.addEventListener('click', logout);
  if (refreshBtn) refreshBtn.addEventListener('click', () => {
    currentPage = 1;
    lastVisible = null;
    carregarProdutos();
  });
  
  // C√¢mera
  if (cameraBtn) cameraBtn.addEventListener('click', () => abrirCamera('new'));
  if (editCameraBtn) editCameraBtn.addEventListener('click', () => abrirCamera('edit'));
  if (captureBtn) captureBtn.addEventListener('click', capturarFoto);
  if (retakeBtn) retakeBtn.addEventListener('click', retomarCamera);
  if (usePhotoBtn) usePhotoBtn.addEventListener('click', usarFoto);
  
  // Import/Export
  if (exportBtn) exportBtn.addEventListener('click', exportarParaExcel);
  if (importModalBtn) importModalBtn.addEventListener('click', abrirImportModal);
  if (importBtn) importBtn.addEventListener('click', importarDoExcel);
  
  // Upload de fotos - novo produto
  if (photoUpload) {
    photoUpload.addEventListener('change', async function(e) {
      await handleImageUpload(e, 'preview', fotoBase64, 'uploadStatus', 'statusText');
    });
  }
  
  // Upload de fotos - edi√ß√£o
  if (editPhotoUpload) {
    editPhotoUpload.addEventListener('change', async function(e) {
      await handleImageUpload(e, 'editPreview', editFotoBase64, 'uploadStatusEdit', 'statusTextEdit');
    });
  }
  
  // Busca
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.trim();
      if (searchTerm.length >= 2 || searchTerm.length === 0) {
        setTimeout(() => buscarProdutos(searchTerm), 300);
      }
    });
  }
  
  // Modal de edi√ß√£o
  if (cancelEditBtn) cancelEditBtn.addEventListener('click', fecharModalEdicao);
  if (updateProductBtn) updateProductBtn.addEventListener('click', atualizarProduto);
  
  // Modal de hist√≥rico
  if (addHistoryBtn) {
    addHistoryBtn.addEventListener('click', adicionarEntradaHistorico);
  }
  
  // Fechar modais ao clicar fora
  const modals = [
    document.getElementById("editModal"), 
    document.getElementById("imageModal"), 
    document.getElementById("historyModal"),
    document.getElementById("cameraModal"),
    document.getElementById("importModal")
  ];
  modals.forEach(modal => {
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          if (modal.id === "editModal") fecharModalEdicao();
          if (modal.id === "imageModal") fecharModalImagem();
          if (modal.id === "historyModal") fecharModalHistorico();
          if (modal.id === "cameraModal") fecharCamera();
          if (modal.id === "importModal") fecharImportModal();
        }
      });
    }
  });
  
  // Fechar modais com ESC e navega√ß√£o com setas
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      fecharModalImagem();
      fecharModalHistorico();
      fecharCamera();
      fecharImportModal();
    }
    
    // Navega√ß√£o com setas no modal de imagem
    if (document.getElementById("imageModal").style.display === 'flex') {
      if (e.key === 'ArrowLeft') navImage(-1);
      if (e.key === 'ArrowRight') navImage(1);
    }
  });
  
  // Pagina√ß√£o
  const prevPageBtn = document.getElementById("prevPage");
  const nextPageBtn = document.getElementById("nextPage");
  if (prevPageBtn) prevPageBtn.addEventListener('click', paginaAnterior);
  if (nextPageBtn) nextPageBtn.addEventListener('click', proximaPagina);
  
  // Permitir Enter no login
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  
  if (emailInput && passwordInput) {
    emailInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
    
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
  }
}

// =============================================
// FUN√á√ïES DE C√ÇMERA
// =============================================

async function abrirCamera(mode) {
  currentCameraMode = mode;
  
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false 
    });
    
    const video = document.getElementById('cameraVideo');
    video.srcObject = cameraStream;
    
    // Resetar controles
    document.getElementById('captureBtn').style.display = 'block';
    document.getElementById('retakeBtn').style.display = 'none';
    document.getElementById('usePhotoBtn').style.display = 'none';
    video.style.display = 'block';
    
    document.getElementById('cameraModal').style.display = 'flex';
    
  } catch (error) {
    console.error('Erro ao acessar c√¢mera:', error);
    alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.');
  }
}

function capturarFoto() {
  const video = document.getElementById('cameraVideo');
  const canvas = document.getElementById('cameraCanvas');
  const context = canvas.getContext('2d');
  
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  // Parar v√≠deo e mostrar foto
  video.style.display = 'none';
  canvas.style.display = 'block';
  
  // Mostrar controles
  document.getElementById('captureBtn').style.display = 'none';
  document.getElementById('retakeBtn').style.display = 'block';
  document.getElementById('usePhotoBtn').style.display = 'block';
}

function retomarCamera() {
  const video = document.getElementById('cameraVideo');
  const canvas = document.getElementById('cameraCanvas');
  
  video.style.display = 'block';
  canvas.style.display = 'none';
  
  document.getElementById('captureBtn').style.display = 'block';
  document.getElementById('retakeBtn').style.display = 'none';
  document.getElementById('usePhotoBtn').style.display = 'none';
}

async function usarFoto() {
  const canvas = document.getElementById('cameraCanvas');
  const base64Image = canvas.toDataURL('image/jpeg', 0.8);
  
  try {
    // Comprimir imagem
    const compressedBase64 = await compressBase64Image(base64Image, 100);
    
    // Upload para ImgBB
    const imgbbResult = await uploadToImgBB(compressedBase64);
    
    // Adicionar ao array correto
    if (currentCameraMode === 'new') {
      fotoBase64.push({
        url: imgbbResult.url,
        thumb: imgbbResult.thumb,
        localPreview: compressedBase64
      });
      
      // Adicionar preview
      const preview = document.getElementById('preview');
      const index = fotoBase64.length - 1;
      preview.innerHTML += `
        <div class="photo-wrapper">
          <img src="${compressedBase64}" 
               class="photo-thumbnail" 
               data-index="${index}"
               data-url="${imgbbResult.url}"
               onclick="visualizarImagemFromArray(${index})"
               title="Clique para ampliar">
        </div>`;
    } else if (currentCameraMode === 'edit') {
      editFotoBase64.push({
        url: imgbbResult.url,
        thumb: imgbbResult.thumb,
        localPreview: compressedBase64
      });
      
      // Adicionar preview
      const preview = document.getElementById('editPreview');
      const index = editFotoBase64.length - 1;
      preview.innerHTML += `
        <div class="photo-wrapper">
          <img src="${compressedBase64}" 
               class="photo-thumbnail" 
               data-index="${index}"
               data-url="${imgbbResult.url}"
               onclick="visualizarImagemFromArray(${index})"
               title="Clique para ampliar">
        </div>`;
    }
    
    fecharCamera();
    
  } catch (error) {
    console.error('Erro ao processar foto:', error);
    alert('Erro ao processar foto: ' + error.message);
  }
}

function fecharCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  
  const video = document.getElementById('cameraVideo');
  video.srcObject = null;
  
  document.getElementById('cameraModal').style.display = 'none';
}

// Fun√ß√£o auxiliar para comprimir base64
async function compressBase64Image(base64Image, maxSizeKB = 100) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;
      
      const maxDimension = 1200;
      if (width > maxDimension || height > maxDimension) {
        if (width > height) {
          height = Math.round((height * maxDimension) / width);
          width = maxDimension;
        } else {
          width = Math.round((width * maxDimension) / height);
          height = maxDimension;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      let quality = 0.8;
      let result;
      
      for (let i = 0; i < 5; i++) {
        result = canvas.toDataURL('image/jpeg', quality);
        const sizeKB = (result.length * 3) / 4 / 1024;
        
        if (sizeKB <= maxSizeKB || quality <= 0.3) {
          break;
        }
        quality -= 0.15;
      }
      
      if ((result.length * 3) / 4 / 1024 > maxSizeKB) {
        canvas.width = Math.round(width * 0.7);
        canvas.height = Math.round(height * 0.7);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        result = canvas.toDataURL('image/jpeg', 0.6);
      }
      
      resolve(result);
    };
    
    img.onerror = reject;
    img.src = base64Image;
  });
}

// =============================================
// FUN√á√ïES DE IMPORT/EXPORT EXCEL
// =============================================

function baixarModeloExcel() {
  const dados = [
    ['N√∫mero', 'Equipamento', 'Setor', 'Modelo', 'Configura√ß√£o', 'Hist√≥rico Inicial'],
    ['001234', 'Notebook', 'TI', 'Dell Latitude 5420', 'i5-11400H, 16GB RAM, 512GB SSD', '15/01/2024 - Troca de pasta t√©rmica'],
    ['001235', 'Desktop', 'Administrativo', 'HP ProDesk 400', 'i3-10100, 8GB RAM, 256GB SSD', ''],
    ['001236', 'Monitor', 'TI', 'Dell P2422H', '24" Full HD, IPS', ''],
    ['', '', '', '', '', ''],
    ['INSTRU√á√ïES:', '', '', '', '', ''],
    ['1. Preencha as colunas (as 3 primeiras s√£o obrigat√≥rias)', '', '', '', '', ''],
    ['2. Deixe em branco se n√£o tiver informa√ß√£o', '', '', '', '', ''],
    ['3. Salve como arquivo Excel (.xlsx) ou CSV', '', '', '', '', ''],
    ['4. Importe usando o bot√£o "Importar Excel"', '', '', '', '', '']
  ];
  
  const ws = XLSX.utils.aoa_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Modelo Patrim√¥nio TI");
  
  // Estilizar (largura das colunas)
  const wscols = [
    {wch: 12}, // N√∫mero
    {wch: 15}, // Equipamento
    {wch: 15}, // Setor
    {wch: 20}, // Modelo
    {wch: 30}, // Configura√ß√£o
    {wch: 40}  // Hist√≥rico
  ];
  ws['!cols'] = wscols;
  
  XLSX.writeFile(wb, "modelo_patrimonio_ti.xlsx");
}

async function exportarParaExcel() {
  try {
    // Buscar todos os produtos
    const produtosQuery = query(collection(db, "produtos"), orderBy("timestamp", "desc"));
    const querySnapshot = await getDocs(produtosQuery);
    
    if (querySnapshot.empty) {
      alert("Nenhum produto para exportar");
      return;
    }
    
    // Preparar dados
    const dados = [
      ['N√∫mero', 'Equipamento', 'Setor', 'Modelo', 'Configura√ß√£o', 'Fotos', 'Hist√≥rico', 'Criado em', 'Criado por']
    ];
    
    querySnapshot.forEach(doc => {
      const produto = doc.data();
      
      // Formatar hist√≥rico
      let historicoFormatado = '';
      if (produto.historico && Array.isArray(produto.historico)) {
        historicoFormatado = produto.historico.map(entry => {
          const date = new Date(entry.data).toLocaleDateString('pt-BR');
          return `${date}: ${entry.texto}`;
        }).join('; ');
      }
      
      // Formatar fotos
      let fotosFormatado = '';
      if (produto.fotos && Array.isArray(produto.fotos)) {
        fotosFormatado = produto.fotos.join('; ');
      }
      
      dados.push([
        produto.numero || '',
        produto.equipamento || '',
        produto.setor || '',
        produto.modelo || '',
        produto.configuracao || '',
        fotosFormatado,
        historicoFormatado,
        produto.timestamp ? produto.timestamp.toDate().toLocaleDateString('pt-BR') : '',
        produto.criadoPor || ''
      ]);
    });
    
    // Criar planilha
    const ws = XLSX.utils.aoa_to_sheet(dados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Patrim√¥nio TI");
    
    // Ajustar largura das colunas
    const wscols = [
      {wch: 12}, // N√∫mero
      {wch: 15}, // Equipamento
      {wch: 15}, // Setor
      {wch: 20}, // Modelo
      {wch: 30}, // Configura√ß√£o
      {wch: 50}, // Fotos
      {wch: 50}, // Hist√≥rico
      {wch: 15}, // Criado em
      {wch: 20}  // Criado por
    ];
    ws['!cols'] = wscols;
    
    // Exportar
    XLSX.writeFile(wb, `patrimonio_ti_${new Date().toISOString().split('T')[0]}.xlsx`);
    
    alert(`‚úÖ ${querySnapshot.size} produtos exportados com sucesso!`);
    
  } catch (error) {
    console.error("Erro ao exportar:", error);
    alert("‚ùå Erro ao exportar: " + error.message);
  }
}

function abrirImportModal() {
  document.getElementById('importModal').style.display = 'flex';
  document.getElementById('excelFile').value = '';
  document.getElementById('importStatus').style.display = 'none';
  document.getElementById('importSummary').style.display = 'none';
}

function fecharImportModal() {
  document.getElementById('importModal').style.display = 'none';
}

async function importarDoExcel() {
  const fileInput = document.getElementById('excelFile');
  const file = fileInput.files[0];
  
  if (!file) {
    alert("Por favor, selecione um arquivo Excel ou CSV");
    return;
  }
  
  const importStatus = document.getElementById('importStatus');
  const importSummary = document.getElementById('importSummary');
  
  try {
    importStatus.className = 'import-status processing';
    importStatus.innerHTML = '<span class="loading-spinner"></span> Processando arquivo...';
    importStatus.style.display = 'block';
    
    const data = await readExcelFile(file);
    
    if (!data || data.length === 0) {
      throw new Error('Arquivo vazio ou formato inv√°lido');
    }
    
    // Validar cabe√ßalhos
    const headers = data[0];
    const requiredHeaders = ['N√∫mero', 'Equipamento', 'Setor'];
    
    for (const header of requiredHeaders) {
      if (!headers.includes(header)) {
        throw new Error(`Coluna obrigat√≥ria n√£o encontrada: "${header}"`);
      }
    }
    
    // Processar linhas
    const produtos = [];
    let sucesso = 0;
    let erro = 0;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row.every(cell => !cell)) continue; // Pular linhas vazias
      
      try {
        // Mapear colunas
        const numeroIndex = headers.indexOf('N√∫mero');
        const equipamentoIndex = headers.indexOf('Equipamento');
        const setorIndex = headers.indexOf('Setor');
        const modeloIndex = headers.indexOf('Modelo');
        const configuracaoIndex = headers.indexOf('Configura√ß√£o');
        const historicoIndex = headers.indexOf('Hist√≥rico Inicial');
        
        const produto = {
          numero: row[numeroIndex]?.toString().trim() || '',
          equipamento: row[equipamentoIndex]?.toString().trim() || '',
          setor: row[setorIndex]?.toString().trim() || '',
          modelo: row[modeloIndex]?.toString().trim() || '',
          configuracao: row[configuracaoIndex]?.toString().trim() || '',
          fotos: [],
          timestamp: Timestamp.now(),
          criadoPor: auth.currentUser?.email || "Importa√ß√£o Excel"
        };
        
        // Validar campos obrigat√≥rios
        if (!produto.numero || !produto.equipamento || !produto.setor) {
          throw new Error('Campos obrigat√≥rios faltando');
        }
        
        // Adicionar hist√≥rico inicial se houver
        const historicoInicial = row[historicoIndex]?.toString().trim();
        if (historicoInicial) {
          produto.historico = [{
            data: new Date().toISOString(),
            texto: historicoInicial,
            autor: auth.currentUser?.email || "Importa√ß√£o Excel"
          }];
        }
        
        produtos.push(produto);
        sucesso++;
        
      } catch (error) {
        console.error(`Erro na linha ${i + 1}:`, error);
        erro++;
      }
    }
    
    // Salvar no Firestore
    if (produtos.length > 0) {
      for (const produto of produtos) {
        await addDoc(collection(db, "produtos"), produto);
      }
    }
    
    // Mostrar resumo
    importStatus.className = 'import-status success';
    importStatus.innerHTML = `‚úÖ Importa√ß√£o conclu√≠da!`;
    importStatus.style.display = 'block';
    
    importSummary.innerHTML = `
      <strong>Resumo da importa√ß√£o:</strong><br>
      ‚úÖ ${sucesso} produtos importados com sucesso<br>
      ${erro > 0 ? `‚ùå ${erro} produtos com erro` : ''}
    `;
    importSummary.style.display = 'block';
    
    // Recarregar lista
    setTimeout(() => {
      carregarProdutos();
      fecharImportModal();
    }, 2000);
    
  } catch (error) {
    console.error('Erro na importa√ß√£o:', error);
    importStatus.className = 'import-status error';
    importStatus.innerHTML = `‚ùå Erro na importa√ß√£o: ${error.message}`;
    importStatus.style.display = 'block';
  }
}

function readExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Pegar primeira planilha
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        
        // Converter para array
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        resolve(jsonData);
      } catch (error) {
        reject(error);
      }
    };
    
    reader.onerror = reject;
    
    // Ler arquivo
    if (file.name.endsWith('.csv')) {
      reader.readAsText(file);
    } else {
      reader.readAsArrayBuffer(file);
    }
  });
}

// =============================================
// FUN√á√ïES DE COMPRESS√ÉO E UPLOAD DE IMAGENS
// =============================================

async function compressImage(file, maxSizeKB = 100) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        const maxDimension = 1200;
        if (width > maxDimension || height > maxDimension) {
          if (width > height) {
            height = Math.round((height * maxDimension) / width);
            width = maxDimension;
          } else {
            width = Math.round((width * maxDimension) / height);
            height = maxDimension;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        let quality = 0.8;
        let base64;
        
        for (let i = 0; i < 5; i++) {
          base64 = canvas.toDataURL('image/jpeg', quality);
          const sizeKB = (base64.length * 3) / 4 / 1024;
          
          if (sizeKB <= maxSizeKB || quality <= 0.3) {
            break;
          }
          quality -= 0.15;
        }
        
        if ((base64.length * 3) / 4 / 1024 > maxSizeKB) {
          canvas.width = Math.round(width * 0.7);
          canvas.height = Math.round(height * 0.7);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          base64 = canvas.toDataURL('image/jpeg', 0.6);
        }
        
        resolve(base64);
      };
      
      img.onerror = reject;
    };
    
    reader.onerror = reject;
  });
}

async function uploadToImgBB(base64Image) {
  try {
    const base64Data = base64Image.includes(',') 
      ? base64Image.split(',')[1] 
      : base64Image;
    
    const formData = new FormData();
    formData.append('image', base64Data);
    
    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error?.message || 'Falha no upload');
    }
    
    return {
      url: data.data.url,
      thumb: data.data.thumb?.url || data.data.url,
      deleteUrl: data.data.delete_url
    };
    
  } catch (error) {
    console.error('Erro no ImgBB:', error);
    throw new Error('Falha ao enviar imagem: ' + error.message);
  }
}

async function handleImageUpload(event, previewId, storageArray, statusId, statusTextId) {
  const files = event.target.files;
  const preview = document.getElementById(previewId);
  const uploadStatus = document.getElementById(statusId);
  const statusText = document.getElementById(statusTextId);
  
  if (!preview || !files.length) return;
  
  if (uploadStatus && statusText) {
    uploadStatus.style.display = 'block';
  }
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    
    if (!file.type.match('image.*')) {
      alert('Por favor, selecione apenas imagens (JPG, PNG, etc).');
      continue;
    }
    
    if (file.size > 32 * 1024 * 1024) {
      alert('Imagem muito grande! M√°ximo: 32MB');
      continue;
    }
    
    try {
      if (statusText) {
        statusText.textContent = `Comprimindo imagem ${i + 1}/${files.length}...`;
      }
      
      const compressedBase64 = await compressImage(file, 100);
      
      if (statusText) {
        statusText.textContent = `Enviando imagem ${i + 1}/${files.length} para ImgBB...`;
      }
      
      const imgbbResult = await uploadToImgBB(compressedBase64);
      
      storageArray.push({
        url: imgbbResult.url,
        thumb: imgbbResult.thumb,
        localPreview: compressedBase64
      });
      
      const index = storageArray.length - 1;
      preview.innerHTML += `
        <div class="photo-wrapper">
          <img src="${compressedBase64}" 
               class="photo-thumbnail" 
               data-index="${index}"
               data-url="${imgbbResult.url}"
               onclick="visualizarImagemFromArray(${index})"
               title="Clique para ampliar">
        </div>`;
        
    } catch (error) {
      console.error('Erro no upload:', error);
      alert(`Erro na imagem ${i + 1}: ${error.message}`);
      break;
    }
  }
  
  if (uploadStatus) {
    uploadStatus.style.display = 'none';
  }
  
  event.target.value = '';
}

// =============================================
// FUN√á√ïES DE AUTENTICA√á√ÉO
// =============================================

async function login() {
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginError = document.getElementById("loginError");
  
  if (!emailInput || !passwordInput) return;
  
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  
  if (!email || !password) {
    if (loginError) {
      loginError.textContent = "Por favor, preencha email e senha";
      loginError.style.display = "block";
    }
    return;
  }
  
  try {
    if (loginError) loginError.style.display = "none";
    await signInWithEmailAndPassword(auth, email, password);
  } catch (error) {
    console.error("Erro no login:", error);
    if (loginError) {
      loginError.textContent = "Erro no login: " + error.message;
      loginError.style.display = "block";
    }
  }
}

async function logout() {
  try {
    await signOut(auth);
  } catch (error) {
    console.error("Erro ao sair:", error);
  }
}

onAuthStateChanged(auth, user => {
  const loginCard = document.getElementById("loginCard");
  const app = document.getElementById("app");
  const logoutBtn = document.getElementById("logoutBtn");
  const userEmail = document.getElementById("userEmail");
  
  if (user) {
    if (loginCard) loginCard.classList.add("hidden");
    if (app) app.classList.remove("hidden");
    if (logoutBtn) logoutBtn.classList.remove("hidden");
    if (userEmail) userEmail.innerText = user.email;
    
    carregarProdutos();
  } else {
    if (loginCard) loginCard.classList.remove("hidden");
    if (app) app.classList.add("hidden");
    if (logoutBtn) logoutBtn.classList.add("hidden");
    if (userEmail) userEmail.innerText = "";
    
    const lista = document.getElementById("lista");
    if (lista) lista.innerHTML = "";
    
    const loadError = document.getElementById("loadError");
    if (loadError) loadError.style.display = "none";
    
    const pagination = document.getElementById("pagination");
    if (pagination) pagination.style.display = "none";
  }
});

// =============================================
// FUN√á√ïES DO FIRESTORE (restantes - mantidas do c√≥digo anterior)
// =============================================

// [As fun√ß√µes restantes s√£o as mesmas do c√≥digo anterior:
// carregarProdutos, getTotalCount, atualizarListaProdutos, 
// buscarProdutos, proximaPagina, paginaAnterior,
// visualizarImagemFromArray, visualizarImagemFromList,
// visualizarImagemModalComTodas, navImage, fecharModalImagem,
// abrirModalEdicao, fecharModalEdicao, editarProduto, atualizarProduto,
// abrirModalHistorico, fecharModalHistorico, carregarHistorico,
// adicionarEntradaHistorico, confirmarExclusao, excluirProduto,
// salvarProduto]

// Por quest√£o de espa√ßo, mantive apenas as fun√ß√µes principais novas.
// As outras fun√ß√µes do c√≥digo anterior devem ser mantidas.

// ... [resto das fun√ß√µes do c√≥digo anterior] ...

</script>

</body>
</html>
