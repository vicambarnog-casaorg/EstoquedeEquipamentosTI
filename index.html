<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111111">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Patrim√¥nio TI</title>
    
    <style>
        /* ====== RESET E BASE ====== */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f6f8;
            color: #333;
            line-height: 1.5;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }
        
        /* ====== HEADER MOBILE ====== */
        header {
            background: linear-gradient(135deg, #111111 0%, #2d3748 100%);
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        header > div:first-child {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        header > div:first-child::before {
            content: "üíª";
            font-size: 24px;
        }
        
        #userEmail {
            font-size: 14px;
            opacity: 0.9;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        #logoutBtn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        #logoutBtn:hover {
            background: rgba(255,255,255,0.25);
        }
        
        /* ====== CONTE√öDO PRINCIPAL ====== */
        main {
            padding: 80px 16px 30px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            min-height: calc(100vh - 60px);
        }
        
        /* ====== CARDS MOBILE ====== */
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            animation: fadeIn 0.5s ease;
        }
        
        .card h3 {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 25px 0;
            color: #111;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        /* ====== FORMUL√ÅRIOS MOBILE ====== */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 22px;
        }
        
        .form-row > div {
            width: 100%;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #374151;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            font-size: 17px;
            transition: all 0.3s;
            background: #f9fafb;
            font-family: inherit;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        textarea {
            min-height: 140px;
            resize: vertical;
            line-height: 1.6;
        }
        
        /* ====== BOT√ïES MOBILE ====== */
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 18px 24px;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin: 10px 0;
            gap: 10px;
            font-family: inherit;
            min-height: 50px;
        }
        
        .btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        
        .btn-edit {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-history {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        .btn-import {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }
        
        .btn-camera {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-cancel {
            background: #f1f5f9;
            color: #374151;
            border: 2px solid #e2e8f0;
        }
        
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        }
        
        .btn-sm {
            padding: 12px 18px;
            font-size: 15px;
            border-radius: 10px;
            width: auto;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .import-export-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        /* ====== FOTOS MOBILE ====== */
        .photo-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .photo-thumbnail {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-thumbnail:hover {
            transform: scale(1.05);
            border-color: #2563eb;
        }
        
        /* ====== TABELA MOBILE ====== */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px -16px;
            padding: 0 16px;
            border-radius: 16px;
        }
        
        table {
            width: 100%;
            min-width: 700px;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        th {
            padding: 18px 16px;
            text-align: left;
            font-weight: 700;
            color: #374151;
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
            font-size: 15px;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 15px;
            vertical-align: middle;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        /* ====== MODAIS MOBILE ====== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
            animation: modalSlide 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        .image-modal .modal-content {
            background: transparent;
            padding: 0;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-modal-img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 12px;
        }
        
        .image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            z-index: 10;
        }
        
        .image-nav:hover {
            background: rgba(255,255,255,0.4);
        }
        
        .image-nav.prev {
            left: 20px;
        }
        
        .image-nav.next {
            right: 20px;
        }
        
        .image-counter {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .image-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-close:hover {
            background: rgba(255,255,255,0.4);
        }
        
        /* ====== ANIMA√á√ïES ====== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ====== LOADING ====== */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        /* ====== MENSAGENS ====== */
        #loginError, #saveError, #loadError, #editError {
            background: #fee2e2;
            color: #991b1b;
            padding: 16px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #ef4444;
            display: none;
        }
        
        /* ====== BARRA DE BUSCA ====== */
        #searchInput {
            width: 100%;
            padding: 18px 24px;
            border: none;
            border-radius: 16px;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            font-size: 17px;
            font-family: inherit;
            margin-bottom: 20px;
        }
        
        /* ====== PAGINA√á√ÉO ====== */
        #pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        #pageInfo {
            font-weight: 600;
            color: #374151;
            font-size: 16px;
        }
        
        /* ====== UTILIT√ÅRIOS ====== */
        .hidden {
            display: none !important;
        }
        
        small {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* ====== SCROLLBAR ====== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* ====== RESPONSIVIDADE EXTRA ====== */
        @media (max-width: 480px) {
            main {
                padding: 80px 12px 20px;
            }
            
            .card {
                padding: 20px;
                border-radius: 18px;
            }
            
            button {
                padding: 16px 20px;
                font-size: 16px;
            }
            
            input, textarea, select {
                padding: 14px 16px;
                font-size: 16px;
            }
            
            .modal-content {
                padding: 25px 20px;
                margin: 10px;
                border-radius: 20px;
            }
            
            .photo-container {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }
            
            .photo-thumbnail {
                height: 70px;
            }
            
            header > div:first-child {
                font-size: 20px;
            }
        }
        
        /* ====== SAFE AREA PARA IPHONE ====== */
        @supports (padding-top: env(safe-area-inset-top)) {
            header {
                padding-top: calc(15px + env(safe-area-inset-top)) !important;
                height: calc(60px + env(safe-area-inset-top)) !important;
            }
            
            main {
                padding-top: calc(80px + env(safe-area-inset-top)) !important;
            }
        }
        
        /* ====== DARK MODE ====== */
        @media (prefers-color-scheme: dark) {
            body {
                background: #121212;
                color: #e5e7eb;
            }
            
            .card {
                background: #1f2937;
                border-color: #374151;
                color: #e5e7eb;
            }
            
            input, textarea, select {
                background: #374151;
                border-color: #4b5563;
                color: #e5e7eb;
            }
            
            input:focus, textarea:focus, select:focus {
                background: #4b5563;
                border-color: #60a5fa;
            }
            
            table {
                background: #1f2937;
                color: #e5e7eb;
            }
            
            th {
                background: #374151;
                color: #e5e7eb;
                border-color: #4b5563;
            }
            
            td {
                border-color: #374151;
            }
            
            tr:hover {
                background: #374151;
            }
            
            #searchInput {
                background: #374151;
                color: #e5e7eb;
                border: 1px solid #4b5563;
            }
            
            .btn-cancel {
                background: #374151;
                border-color: #4b5563;
                color: #e5e7eb;
            }
        }
        
        /* ====== LAYOUT PARA DESKTOP (se necess√°rio) ====== */
        @media (min-width: 769px) {
            .form-row {
                flex-direction: row;
            }
            
            .action-buttons {
                flex-direction: row;
            }
            
            .import-export-buttons {
                flex-direction: row;
            }
            
            button {
                width: auto;
            }
            
            .btn-sm {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER FIXO -->
    <header>
        <div>Patrim√¥nio TI</div>
        <div style="display: flex; align-items: center;">
            <span id="userEmail"></span>
            <button id="logoutBtn" class="hidden">Sair</button>
        </div>
    </header>

    <!-- CONTE√öDO PRINCIPAL -->
    <main>
        <!-- MODAL DE IMAGEM -->
        <div id="imageModal" class="modal image-modal">
            <div class="modal-content">
                <button class="image-nav prev" onclick="navImage(-1)">‚ùÆ</button>
                <img id="modalImage" class="image-modal-img" src="" alt="Imagem ampliada">
                <button class="image-nav next" onclick="navImage(1)">‚ùØ</button>
                <button class="image-close" onclick="fecharModalImagem()">√ó</button>
                <div id="imageCounter" class="image-counter"></div>
            </div>
        </div>

        <!-- MODAL DE EDI√á√ÉO -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <h3 style="margin-top: 0; margin-bottom: 25px;">‚úèÔ∏è Editar Produto</h3>
                
                <div class="form-row">
                    <div>
                        <label>üî¢ N√∫mero do patrim√¥nio *</label>
                        <input id="editNumero" placeholder="Ex: 001234">
                    </div>
                    <div>
                        <label>üè¢ Setor *</label>
                        <input id="editSetor" placeholder="Ex: TI, Administrativo">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>üíª Equipamento *</label>
                        <input id="editEquipamento" placeholder="Ex: Notebook, Desktop">
                    </div>
                    <div>
                        <label>üì± Modelo</label>
                        <input id="editModelo" placeholder="Ex: Dell Latitude 5420">
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>‚öôÔ∏è Configura√ß√£o</label>
                    <textarea id="editConfiguracao" placeholder="Processador, RAM, HD, etc."></textarea>
                </div>
                
                <div id="editCurrentPhotos" style="margin-bottom: 20px;">
                    <label>üì∏ Fotos atuais</label>
                    <div class="photo-container"></div>
                </div>
                
                <div id="editPhotoUploadContainer" style="margin-bottom: 20px;">
                    <label>‚ûï Adicionar mais fotos</label>
                    <div class="photo-container" id="editPreview"></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="file" id="editPhotoUpload" multiple accept="image/*" style="flex: 1; padding: 12px;">
                        <button id="editCameraBtn" class="btn-camera btn-sm">üì∑ C√¢mera</button>
                    </div>
                </div>
                
                <div id="uploadStatusEdit" style="margin: 15px 0; display: none;">
                    <span class="loading-spinner"></span>
                    <span id="statusTextEdit">Enviando imagens...</span>
                </div>
                
                <div id="editError" style="display: none;"></div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button id="cancelEditBtn" class="btn-cancel" style="flex: 1;">Cancelar</button>
                    <button id="updateProductBtn" class="btn" style="flex: 2;">Atualizar Produto</button>
                </div>
            </div>
        </div>

        <!-- MODAL DE C√ÇMERA -->
        <div id="cameraModal" class="modal">
            <div class="modal-content">
                <h3 style="margin-top: 0; margin-bottom: 20px;">üì∑ Tirar Foto</h3>
                <div class="camera-container" style="width: 100%; max-width: 400px; margin: 0 auto; text-align: center;">
                    <div class="camera-preview" style="width: 100%; height: 300px; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 20px; position: relative;">
                        <video id="cameraVideo" style="width: 100%; height: 100%; object-fit: contain;" autoplay playsinline></video>
                        <canvas id="cameraCanvas" style="display: none; width: 100%; height: auto; max-height: 300px; object-fit: contain;"></canvas>
                    </div>
                    <div class="camera-controls" style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                        <button id="captureBtn" class="btn">Tirar Foto</button>
                        <button id="retakeBtn" class="btn-cancel" style="display: none;">Tirar Outra</button>
                        <button id="usePhotoBtn" class="btn" style="display: none;">Usar Foto</button>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button id="closeCameraBtn" class="btn-cancel">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- MODAL DE IMPORTA√á√ÉO -->
        <div id="importModal" class="modal">
            <div class="modal-content">
                <h3 style="margin-top: 0; margin-bottom: 20px;">üì§ Importar Produtos</h3>
                
                <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 18px; margin: 20px 0; border-radius: 8px;">
                    <h4 style="margin-top: 0; color: #1e40af; margin-bottom: 10px;">üìã Instru√ß√µes:</h4>
                    <ul style="margin: 8px 0; padding-left: 20px; color: #374151;">
                        <li style="margin: 6px 0;">Baixe o <a href="#" id="downloadModeloLink" style="color: #2563eb; font-weight: bold;">modelo da planilha</a></li>
                        <li style="margin: 6px 0;">Preencha os dados seguindo o formato</li>
                        <li style="margin: 6px 0;">Colunas obrigat√≥rias: N√∫mero, Equipamento, Setor</li>
                        <li style="margin: 6px 0;">Colunas opcionais: Modelo, Configura√ß√£o</li>
                        <li style="margin: 6px 0;">Envie o arquivo Excel (.xlsx) ou CSV</li>
                    </ul>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">üìÅ Selecione o arquivo:</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="width: 100%; padding: 16px; border: 2px solid #d1d5db; border-radius: 12px; background: #f9fafb;">
                </div>
                
                <div id="importStatus" style="display: none; padding: 16px; border-radius: 12px; margin: 20px 0;"></div>
                
                <div id="importSummary" style="display: none; margin-top: 20px;"></div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button id="closeImportBtn" class="btn-cancel">Cancelar</button>
                    <button id="importBtn" class="btn-import">Importar</button>
                </div>
            </div>
        </div>

        <!-- MODAL DE HIST√ìRICO -->
        <div id="historyModal" class="modal">
            <div class="modal-content">
                <h3 style="margin-top: 0; margin-bottom: 20px;">üìã Hist√≥rico de Manuten√ß√£o</h3>
                <p style="margin-bottom: 20px;"><strong>Produto:</strong> <span id="historyProductTitle"></span></p>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">‚ûï Adicionar nova entrada:</label>
                    <textarea id="newHistoryEntry" placeholder="Descreva o que foi feito na manuten√ß√£o..." style="width: 100%; padding: 16px; border: 2px solid #d1d5db; border-radius: 12px; background: #f9fafb; min-height: 120px;"></textarea>
                    <button id="addHistoryBtn" class="btn" style="margin-top: 15px;">Adicionar ao Hist√≥rico</button>
                </div>
                
                <h4 style="margin: 25px 0 15px 0;">üìú Hist√≥rico:</h4>
                <div id="historyList" style="max-height: 300px; overflow-y: auto; padding: 15px; background: #f9fafb; border-radius: 12px;"></div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button id="closeHistoryBtn" class="btn-cancel">Fechar</button>
                </div>
            </div>
        </div>

        <!-- TELA DE LOGIN -->
        <div id="loginCard" class="card">
            <h3>üîê Login</h3>
            <div style="margin-bottom: 20px;">
                <label>üìß Email</label>
                <input id="email" placeholder="seu@email.com">
            </div>
            <div style="margin-bottom: 25px;">
                <label>üîí Senha</label>
                <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div id="loginError" style="display: none;"></div>
            <button id="loginBtn" class="btn">Entrar</button>
        </div>

        <!-- AP√ìS LOGIN (APP) -->
        <div id="app" class="hidden">
            <!-- FORMUL√ÅRIO PRINCIPAL -->
            <div class="card">
                <h3>‚ûï Novo Produto</h3>
                
                <div class="form-row">
                    <div>
                        <label>üî¢ N√∫mero do patrim√¥nio *</label>
                        <input id="numero" placeholder="Ex: 001234">
                    </div>
                    <div>
                        <label>üè¢ Setor alocado *</label>
                        <input id="setor" placeholder="Ex: TI, Administrativo">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>üíª Equipamento *</label>
                        <input id="equipamento" placeholder="Ex: Notebook, Desktop">
                    </div>
                    <div>
                        <label>üì± Modelo</label>
                        <input id="modelo" placeholder="Ex: Dell Latitude 5420">
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>‚öôÔ∏è Configura√ß√£o</label>
                    <textarea id="configuracao" placeholder="Processador: i5-11400H, RAM: 16GB, SSD: 512GB, etc."></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>üìù Hist√≥rico de Manuten√ß√£o (opcional)</label>
                    <textarea id="historico" placeholder="Ex: 15/01/2024 - Troca de pasta t√©rmica"></textarea>
                    <small>Pode deixar em branco e adicionar depois</small>
                </div>

                <div style="margin-bottom: 20px;">
                    <label>üì∏ Fotos do equipamento</label>
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <input type="file" id="photoUpload" multiple accept="image/*" style="flex: 1; padding: 12px;">
                        <button id="cameraBtn" class="btn-camera btn-sm">üì∑ C√¢mera</button>
                    </div>
                    <div id="uploadStatus" style="margin: 15px 0; display: none;">
                        <span class="loading-spinner"></span>
                        <span id="statusText">Comprimindo e enviando imagens...</span>
                    </div>
                    <div id="preview" class="photo-container" style="margin-top: 15px;"></div>
                </div>

                <div id="saveError" style="display: none;"></div>
                <button id="saveProductBtn" class="btn">üíæ Salvar produto</button>
            </div>

            <!-- LISTA DE PRODUTOS -->
            <div class="card">
                <div style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px;">
                    <h3 style="margin: 0;">üìã Produtos cadastrados</h3>
                    <div class="import-export-buttons">
                        <button id="exportBtn" class="btn-export">üì• Exportar Excel</button>
                        <button id="importModalBtn" class="btn-import">üì§ Importar Excel</button>
                        <button id="refreshBtn" class="btn">üîÑ Atualizar lista</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por n√∫mero, equipamento, modelo ou setor...">
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>N¬∫ Patrim√¥nio</th>
                                <th>Equipamento</th>
                                <th>Modelo</th>
                                <th>Setor</th>
                                <th>Fotos</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista"></tbody>
                    </table>
                </div>
                
                <div id="loadError" style="display: none;"></div>
                
                <div id="pagination" style="display: none;">
                    <button id="prevPage" class="btn-cancel btn-sm">‚óÄ Anterior</button>
                    <span id="pageInfo" style="margin: 0 15px;">P√°gina 1</span>
                    <button id="nextPage" class="btn-cancel btn-sm">Pr√≥xima ‚ñ∂</button>
                </div>
            </div>
        </div>
    </main>

    <!-- BIBLIOTECAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- FIREBASE E JAVASCRIPT -->
    <script type="module">
    // ====== CONFIGURA√á√ÉO FIREBASE ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        getDocs, 
        getDoc,
        query, 
        orderBy, 
        deleteDoc, 
        doc, 
        updateDoc,
        Timestamp,
        where,
        or,
        limit,
        startAfter,
        getCountFromServer,
        arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAwCfiEB3JEUu_6rKR32C2E5whnb6-SgX0",
        authDomain: "sis-eetibkp.firebaseapp.com",
        projectId: "sis-eetibkp"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Configura√ß√£o do ImgBB
    const IMGBB_API_KEY = 'f79456acbdeadef07393b773e313a05d';

    // Vari√°veis globais
    let fotoBase64 = [];
    let editFotoBase64 = [];
    let lastVisible = null;
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentProductId = null;
    let currentImageIndex = 0;
    let currentImages = [];
    let currentHistoryProductId = null;
    let cameraStream = null;
    let currentCameraMode = 'new';

    // ====== FUN√á√ÉO PARA MOBILE TOAST ======
    function showMobileToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: ${type === 'success' ? '#10b981' : '#ef4444'};
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideDown 0.3s ease;
            max-width: 90%;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        `;
        
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }

    // ====== INICIALIZA√á√ÉO MOBILE ======
    document.addEventListener('DOMContentLoaded', function() {
        console.log('App Patrim√¥nio TI Mobile carregado');
        
        // Verificar se √© dispositivo m√≥vel
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            console.log('Dispositivo m√≥vel detectado - Aplicando otimiza√ß√µes');
            document.body.classList.add('mobile-device');
            
            // Ajustar altura para evitar barra de navega√ß√£o
            function adjustHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                document.body.style.height = 'calc(var(--vh, 1vh) * 100)';
            }
            
            adjustHeight();
            window.addEventListener('resize', adjustHeight);
            
            // Prevenir zoom em inputs no iOS
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Melhorar performance de scroll
            document.body.style.webkitOverflowScrolling = 'touch';
            
            // Ajustar bot√µes para touch
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.offsetWidth < 44 || button.offsetHeight < 44) {
                    button.style.minWidth = '44px';
                    button.style.minHeight = '44px';
                }
                
                // Feedback visual ao tocar
                button.addEventListener('touchstart', function() {
                    this.style.opacity = '0.8';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
                
                button.addEventListener('touchcancel', function() {
                    this.style.opacity = '1';
                });
            });
            
            // Ajustar inputs para mobile
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    // Scroll suave para o input
                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
            
            // Swipe para fechar modais
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                let startY;
                
                modal.addEventListener('touchstart', function(e) {
                    startY = e.touches[0].clientY;
                });
                
                modal.addEventListener('touchmove', function(e) {
                    if (!startY) return;
                    
                    const currentY = e.touches[0].clientY;
                    const diff = currentY - startY;
                    
                    // Swipe para baixo > 100px fecha o modal
                    if (diff > 100) {
                        if (modal.id === 'editModal') fecharModalEdicao();
                        else if (modal.id === 'historyModal') fecharModalHistorico();
                        else if (modal.id === 'imageModal') fecharModalImagem();
                        else if (modal.id === 'cameraModal') fecharCamera();
                        else if (modal.id === 'importModal') fecharImportModal();
                        
                        startY = null;
                    }
                });
            });
        }
        
        // Configurar link do modelo Excel
        const downloadModeloLink = document.getElementById('downloadModeloLink');
        if (downloadModeloLink) {
            downloadModeloLink.addEventListener('click', function(e) {
                e.preventDefault();
                baixarModeloExcel(e);
            });
        }
        
        // Inicializar Firebase e configura√ß√µes
        setupEventListeners();
    });

    // ====== FUN√á√ïES PRINCIPAIS ======
    function setupEventListeners() {
        // Bot√µes principais
        const loginBtn = document.getElementById("loginBtn");
        const saveProductBtn = document.getElementById("saveProductBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const refreshBtn = document.getElementById("refreshBtn");
        const searchInput = document.getElementById("searchInput");
        const addHistoryBtn = document.getElementById("addHistoryBtn");
        const exportBtn = document.getElementById("exportBtn");
        const importModalBtn = document.getElementById("importModalBtn");
        const importBtn = document.getElementById("importBtn");
        const cameraBtn = document.getElementById("cameraBtn");
        const editCameraBtn = document.getElementById("editCameraBtn");
        
        // Bot√µes de cancelar
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        const closeCameraBtn = document.getElementById("closeCameraBtn");
        const closeImportBtn = document.getElementById("closeImportBtn");
        const closeHistoryBtn = document.getElementById("closeHistoryBtn");
        
        // Upload de fotos
        const photoUpload = document.getElementById("photoUpload");
        const editPhotoUpload = document.getElementById("editPhotoUpload");
        
        // Bot√µes do modal de edi√ß√£o
        const updateProductBtn = document.getElementById("updateProductBtn");
        
        // Bot√µes da c√¢mera
        const captureBtn = document.getElementById("captureBtn");
        const retakeBtn = document.getElementById("retakeBtn");
        const usePhotoBtn = document.getElementById("usePhotoBtn");
        
        // Event Listeners principais
        if (loginBtn) loginBtn.addEventListener('click', login);
        if (saveProductBtn) saveProductBtn.addEventListener('click', salvarProduto);
        if (logoutBtn) logoutBtn.addEventListener('click', logout);
        if (refreshBtn) refreshBtn.addEventListener('click', () => {
            currentPage = 1;
            lastVisible = null;
            carregarProdutos();
            showMobileToast('Lista atualizada!', 'success');
        });
        
        // Bot√µes de cancelar
        if (cancelEditBtn) cancelEditBtn.addEventListener('click', fecharModalEdicao);
        if (closeCameraBtn) closeCameraBtn.addEventListener('click', fecharCamera);
        if (closeImportBtn) closeImportBtn.addEventListener('click', fecharImportModal);
        if (closeHistoryBtn) closeHistoryBtn.addEventListener('click', fecharModalHistorico);
        
        // C√¢mera
        if (cameraBtn) {
            cameraBtn.addEventListener('click', function() {
                abrirCamera('new');
            });
        }
        
        if (editCameraBtn) {
            editCameraBtn.addEventListener('click', function() {
                abrirCamera('edit');
            });
        }
        
        if (captureBtn) captureBtn.addEventListener('click', capturarFoto);
        if (retakeBtn) retakeBtn.addEventListener('click', retomarCamera);
        if (usePhotoBtn) usePhotoBtn.addEventListener('click', usarFoto);
        
        // Import/Export
        if (exportBtn) exportBtn.addEventListener('click', exportarParaExcel);
        if (importModalBtn) importModalBtn.addEventListener('click', abrirImportModal);
        if (importBtn) importBtn.addEventListener('click', importarDoExcel);
        
        // Upload de fotos - novo produto
        if (photoUpload) {
            photoUpload.addEventListener('change', async function(e) {
                await handleImageUpload(e, 'preview', fotoBase64, 'uploadStatus', 'statusText');
            });
        }
        
        // Upload de fotos - edi√ß√£o
        if (editPhotoUpload) {
            editPhotoUpload.addEventListener('change', async function(e) {
                await handleImageUpload(e, 'editPreview', editFotoBase64, 'uploadStatusEdit', 'statusTextEdit');
            });
        }
        
        // Busca
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.trim();
                if (searchTerm.length >= 2 || searchTerm.length === 0) {
                    setTimeout(() => buscarProdutos(searchTerm), 300);
                }
            });
        }
        
        // Modal de edi√ß√£o
        if (updateProductBtn) updateProductBtn.addEventListener('click', atualizarProduto);
        
        // Modal de hist√≥rico
        if (addHistoryBtn) {
            addHistoryBtn.addEventListener('click', adicionarEntradaHistorico);
        }
        
        // Fechar modais ao clicar fora
        const modals = [
            {id: "editModal", closeFn: fecharModalEdicao},
            {id: "imageModal", closeFn: fecharModalImagem},
            {id: "historyModal", closeFn: fecharModalHistorico},
            {id: "cameraModal", closeFn: fecharCamera},
            {id: "importModal", closeFn: fecharImportModal}
        ];
        
        modals.forEach(modalInfo => {
            const modal = document.getElementById(modalInfo.id);
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modalInfo.closeFn();
                    }
                });
            }
        });
        
        // Fechar modais com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById("editModal").style.display === 'flex') fecharModalEdicao();
                if (document.getElementById("imageModal").style.display === 'flex') fecharModalImagem();
                if (document.getElementById("historyModal").style.display === 'flex') fecharModalHistorico();
                if (document.getElementById("cameraModal").style.display === 'flex') fecharCamera();
                if (document.getElementById("importModal").style.display === 'flex') fecharImportModal();
            }
            
            // Navega√ß√£o com setas no modal de imagem
            if (document.getElementById("imageModal").style.display === 'flex') {
                if (e.key === 'ArrowLeft') navImage(-1);
                if (e.key === 'ArrowRight') navImage(1);
            }
        });
        
        // Pagina√ß√£o
        const prevPageBtn = document.getElementById("prevPage");
        const nextPageBtn = document.getElementById("nextPage");
        if (prevPageBtn) prevPageBtn.addEventListener('click', paginaAnterior);
        if (nextPageBtn) nextPageBtn.addEventListener('click', proximaPagina);
        
        // Permitir Enter no login
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        
        if (emailInput && passwordInput) {
            emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        }
    }

    // ====== AUTENTICA√á√ÉO ======
    async function login() {
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const loginError = document.getElementById("loginError");
        
        if (!emailInput || !passwordInput) return;
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        
        if (!email || !password) {
            if (loginError) {
                loginError.textContent = "Por favor, preencha email e senha";
                loginError.style.display = "block";
            }
            return;
        }
        
        try {
            if (loginError) loginError.style.display = "none";
            await signInWithEmailAndPassword(auth, email, password);
            showMobileToast('Login realizado com sucesso!', 'success');
        } catch (error) {
            console.error("Erro no login:", error);
            if (loginError) {
                loginError.textContent = "Erro no login: " + error.message;
                loginError.style.display = "block";
            }
        }
    }

    async function logout() {
        try {
            await signOut(auth);
            showMobileToast('Logout realizado!', 'success');
        } catch (error) {
            console.error("Erro ao sair:", error);
        }
    }

    // ====== FUN√á√ïES DE C√ÇMERA ======
    async function abrirCamera(mode) {
        currentCameraMode = mode;
        
        try {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false 
            });
            
            const video = document.getElementById('cameraVideo');
            video.srcObject = cameraStream;
            
            document.getElementById('captureBtn').style.display = 'block';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('usePhotoBtn').style.display = 'none';
            video.style.display = 'block';
            
            const canvas = document.getElementById('cameraCanvas');
            canvas.style.display = 'none';
            
            document.getElementById('cameraModal').style.display = 'flex';
            
        } catch (error) {
            console.error('Erro ao acessar c√¢mera:', error);
            showMobileToast('N√£o foi poss√≠vel acessar a c√¢mera. Use a galeria.', 'error');
            
            // Fallback para galeria
            if (mode === 'new') {
                document.getElementById('photoUpload').click();
            } else {
                document.getElementById('editPhotoUpload').click();
            }
        }
    }

    function capturarFoto() {
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('cameraCanvas');
        const context = canvas.getContext('2d');
        
        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;
        
        canvas.width = videoWidth;
        canvas.height = videoHeight;
        
        context.drawImage(video, 0, 0, videoWidth, videoHeight);
        
        video.style.display = 'none';
        canvas.style.display = 'block';
        
        document.getElementById('captureBtn').style.display = 'none';
        document.getElementById('retakeBtn').style.display = 'block';
        document.getElementById('usePhotoBtn').style.display = 'block';
    }

    function retomarCamera() {
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('cameraCanvas');
        
        video.style.display = 'block';
        canvas.style.display = 'none';
        
        document.getElementById('captureBtn').style.display = 'block';
        document.getElementById('retakeBtn').style.display = 'none';
        document.getElementById('usePhotoBtn').style.display = 'none';
    }

    async function usarFoto() {
        const canvas = document.getElementById('cameraCanvas');
        const cameraPreview = document.querySelector('.camera-preview');
        
        // Mostrar indicador de processamento
        const processingDiv = document.createElement('div');
        processingDiv.className = 'camera-processing';
        processingDiv.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 8px;
        `;
        processingDiv.innerHTML = `
            <div class="loading-spinner"></div>
            <div style="margin-top: 10px; font-size: 14px;">Processando foto...</div>
        `;
        cameraPreview.appendChild(processingDiv);
        
        // Desabilitar bot√µes durante o processamento
        document.getElementById('usePhotoBtn').disabled = true;
        document.getElementById('retakeBtn').disabled = true;
        
        try {
            // Capturar a foto com qualidade reduzida
            const base64Image = canvas.toDataURL('image/jpeg', 0.7);
            
            // Processar em segundo plano
            setTimeout(async () => {
                try {
                    // Compress√£o otimizada
                    const compressedBase64 = await compressBase64ImageFast(base64Image, 150);
                    
                    // Upload para ImgBB
                    const imgbbResult = await uploadToImgBB(compressedBase64);
                    
                    // Adicionar ao array correto
                    if (currentCameraMode === 'new') {
                        fotoBase64.push({
                            url: imgbbResult.url,
                            thumb: imgbbResult.thumb,
                            localPreview: compressedBase64
                        });
                        
                        // Adicionar preview
                        const preview = document.getElementById('preview');
                        const index = fotoBase64.length - 1;
                        preview.innerHTML += `
                            <div class="photo-wrapper">
                                <img src="${compressedBase64}" 
                                     class="photo-thumbnail" 
                                     data-index="${index}"
                                     data-url="${imgbbResult.url}"
                                     onclick="visualizarImagemFromArray(${index})"
                                     title="Clique para ampliar">
                            </div>`;
                    } else if (currentCameraMode === 'edit') {
                        editFotoBase64.push({
                            url: imgbbResult.url,
                            thumb: imgbbResult.thumb,
                            localPreview: compressedBase64
                        });
                        
                        // Adicionar preview
                        const preview = document.getElementById('editPreview');
                        const index = editFotoBase64.length - 1;
                        preview.innerHTML += `
                            <div class="photo-wrapper">
                                <img src="${compressedBase64}" 
                                     class="photo-thumbnail" 
                                     data-index="${index}"
                                     data-url="${imgbbResult.url}"
                                     onclick="visualizarImagemFromArray(${index})"
                                     title="Clique para ampliar">
                            </div>`;
                    }
                    
                    // Remover indicador de processamento
                    cameraPreview.removeChild(processingDiv);
                    
                    // Reabilitar bot√µes
                    document.getElementById('usePhotoBtn').disabled = false;
                    document.getElementById('retakeBtn').disabled = false;
                    
                    fecharCamera();
                    showMobileToast('Foto adicionada com sucesso!', 'success');
                    
                } catch (error) {
                    console.error('Erro ao processar foto:', error);
                    
                    // Remover indicador de processamento
                    cameraPreview.removeChild(processingDiv);
                    
                    // Reabilitar bot√µes
                    document.getElementById('usePhotoBtn').disabled = false;
                    document.getElementById('retakeBtn').disabled = false;
                    
                    showMobileToast('‚ùå Erro ao processar foto. Tente novamente.', 'error');
                }
            }, 100);
            
        } catch (error) {
            console.error('Erro inicial ao processar foto:', error);
            
            // Remover indicador de processamento se existir
            if (cameraPreview.contains(processingDiv)) {
                cameraPreview.removeChild(processingDiv);
            }
            
            // Reabilitar bot√µes
            document.getElementById('usePhotoBtn').disabled = false;
            document.getElementById('retakeBtn').disabled = false;
            
            showMobileToast('‚ùå Erro ao processar foto: ' + error.message, 'error');
        }
    }

    function fecharCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        
        const video = document.getElementById('cameraVideo');
        video.srcObject = null;
        
        document.getElementById('cameraModal').style.display = 'none';
    }

    // ====== FUN√á√ïES DE COMPRESS√ÉO ======
    async function compressBase64ImageFast(base64Image, maxSizeKB = 150) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                // Reduzir tamanho mais agressivamente para ser r√°pido
                let width = img.width;
                let height = img.height;
                
                // Reduzir para no m√°ximo 800px na maior dimens√£o
                const maxDimension = 800;
                if (width > maxDimension || height > maxDimension) {
                    if (width > height) {
                        height = Math.round((height * maxDimension) / width);
                        width = maxDimension;
                    } else {
                        width = Math.round((width * maxDimension) / height);
                        height = maxDimension;
                    }
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                
                // Fundo branco para JPEG
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, width, height);
                
                // Desenhar imagem
                ctx.drawImage(img, 0, 0, width, height);
                
                // Compress√£o mais r√°pida
                let quality = 0.7;
                let compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                
                // Verificar tamanho
                const sizeKB = Math.round((compressedBase64.length * 3) / 4 / 1024);
                
                // Se ainda muito grande, reduzir qualidade mais
                if (sizeKB > maxSizeKB) {
                    quality = 0.5;
                    compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                }
                
                console.log(`Compress√£o r√°pida: ${sizeKB}KB com qualidade ${quality}`);
                resolve(compressedBase64);
            };
            
            img.onerror = () => {
                // Fallback: imagem original
                resolve(base64Image);
            };
            
            img.src = base64Image;
        });
    }

    async function compressImage(file, maxSizeKB = 100) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    const maxDimension = 1200;
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = Math.round((height * maxDimension) / width);
                            width = maxDimension;
                        } else {
                            width = Math.round((width * maxDimension) / height);
                            height = maxDimension;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    let quality = 0.8;
                    let base64;
                    
                    for (let i = 0; i < 5; i++) {
                        base64 = canvas.toDataURL('image/jpeg', quality);
                        const sizeKB = (base64.length * 3) / 4 / 1024;
                        
                        if (sizeKB <= maxSizeKB || quality <= 0.3) {
                            break;
                        }
                        quality -= 0.15;
                    }
                    
                    if ((base64.length * 3) / 4 / 1024 > maxSizeKB) {
                        canvas.width = Math.round(width * 0.7);
                        canvas.height = Math.round(height * 0.7);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        base64 = canvas.toDataURL('image/jpeg', 0.6);
                    }
                    
                    resolve(base64);
                };
                
                img.onerror = reject;
            };
            
            reader.onerror = reject;
        });
    }

    // ====== UPLOAD PARA IMGBB ======
    async function uploadToImgBB(base64Image) {
        return new Promise((resolve, reject) => {
            try {
                const base64Data = base64Image.includes(',') 
                    ? base64Image.split(',')[1] 
                    : base64Image;
                
                // Criar timeout para evitar espera infinita
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout: Upload muito demorado'));
                }, 30000);
                
                fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `image=${encodeURIComponent(base64Data)}`
                })
                .then(response => {
                    clearTimeout(timeout);
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error?.message || 'Falha no upload');
                    }
                    resolve({
                        url: data.data.url,
                        thumb: data.data.thumb?.url || data.data.url,
                        deleteUrl: data.data.delete_url
                    });
                })
                .catch(error => {
                    clearTimeout(timeout);
                    reject(error);
                });
                
            } catch (error) {
                reject(new Error('Falha ao preparar upload: ' + error.message));
            }
        });
    }

    // ====== UPLOAD DE IMAGENS ======
    async function handleImageUpload(event, previewId, storageArray, statusId, statusTextId) {
        const files = event.target.files;
        const preview = document.getElementById(previewId);
        const uploadStatus = document.getElementById(statusId);
        const statusText = document.getElementById(statusTextId);
        
        if (!preview || !files.length) return;
        
        if (uploadStatus && statusText) {
            uploadStatus.style.display = 'block';
        }
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            if (!file.type.match('image.*')) {
                showMobileToast('Por favor, selecione apenas imagens (JPG, PNG, etc).', 'error');
                continue;
            }
            
            if (file.size > 32 * 1024 * 1024) {
                showMobileToast('Imagem muito grande! M√°ximo: 32MB', 'error');
                continue;
            }
            
            try {
                if (statusText) {
                    statusText.textContent = `Comprimindo imagem ${i + 1}/${files.length}...`;
                }
                
                const compressedBase64 = await compressImage(file, 100);
                
                if (statusText) {
                    statusText.textContent = `Enviando imagem ${i + 1}/${files.length} para ImgBB...`;
                }
                
                const imgbbResult = await uploadToImgBB(compressedBase64);
                
                storageArray.push({
                    url: imgbbResult.url,
                    thumb: imgbbResult.thumb,
                    localPreview: compressedBase64
                });
                
                const index = storageArray.length - 1;
                preview.innerHTML += `
                    <div class="photo-wrapper">
                        <img src="${compressedBase64}" 
                             class="photo-thumbnail" 
                             data-index="${index}"
                             data-url="${imgbbResult.url}"
                             onclick="visualizarImagemFromArray(${index})"
                             title="Clique para ampliar">
                    </div>`;
                    
            } catch (error) {
                console.error('Erro no upload:', error);
                showMobileToast(`Erro na imagem ${i + 1}: ${error.message}`, 'error');
                break;
            }
        }
        
        if (uploadStatus) {
            uploadStatus.style.display = 'none';
        }
        
        event.target.value = '';
    }

    // ====== FIRESTORE CRUD ======
    async function carregarProdutos() {
        const lista = document.getElementById("lista");
        const loadError = document.getElementById("loadError");
        const pagination = document.getElementById("pagination");
        const pageInfo = document.getElementById("pageInfo");
        
        if (!lista) return;
        
        try {
            if (loadError) loadError.style.display = "none";
            
            let produtosQuery;
            
            if (currentPage === 1) {
                produtosQuery = query(
                    collection(db, "produtos"),
                    orderBy("timestamp", "desc"),
                    limit(itemsPerPage)
                );
                lastVisible = null;
            } else {
                produtosQuery = query(
                    collection(db, "produtos"),
                    orderBy("timestamp", "desc"),
                    startAfter(lastVisible),
                    limit(itemsPerPage)
                );
            }
            
            const querySnapshot = await getDocs(produtosQuery);
            
            if (!querySnapshot.empty) {
                lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
            }
            
            atualizarListaProdutos(querySnapshot);
            
            if (pagination && pageInfo) {
                const totalCount = await getTotalCount();
                const totalPages = Math.ceil(totalCount / itemsPerPage);
                
                if (totalPages > 1) {
                    pagination.style.display = "block";
                    pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
                    
                    const prevPageBtn = document.getElementById("prevPage");
                    const nextPageBtn = document.getElementById("nextPage");
                    if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
                    if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages;
                } else {
                    pagination.style.display = "none";
                }
            }
            
        } catch (error) {
            console.error("Erro ao carregar produtos:", error);
            if (loadError) {
                loadError.textContent = "Erro ao carregar produtos: " + error.message;
                loadError.style.display = "block";
            }
        }
    }

    async function getTotalCount() {
        const countQuery = query(collection(db, "produtos"));
        const snapshot = await getCountFromServer(countQuery);
        return snapshot.data().count;
    }

    function atualizarListaProdutos(querySnapshot) {
        const lista = document.getElementById("lista");
        if (!lista) return;
        
        lista.innerHTML = "";
        
        if (querySnapshot.empty) {
            lista.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px; color: #6b7280;">Nenhum produto cadastrado</td></tr>';
            return;
        }
        
        querySnapshot.forEach(doc => {
            const produto = doc.data();
            const produtoId = doc.id;
            const fotoUrlsArray = produto.fotos || [];
            
            let fotosHTML = '<div class="photo-container">';
            if (fotoUrlsArray.length > 0) {
                fotoUrlsArray.forEach((url, index) => {
                    fotosHTML += `
                        <div class="photo-wrapper">
                            <img src="${url}" 
                                 class="photo-thumbnail" 
                                 onclick="visualizarImagemFromList('${produtoId}', ${index})"
                                 title="Clique para ampliar"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/70?text=Imagem'">
                        </div>`;
                });
            } else {
                fotosHTML += '<span style="color: #6b7280; font-size: 14px;">Sem fotos</span>';
            }
            fotosHTML += '</div>';
            
            lista.innerHTML += `
                <tr id="produto-${produtoId}">
                    <td><strong>${produto.numero || ''}</strong></td>
                    <td>${produto.equipamento || ''}</td>
                    <td>${produto.modelo || '-'}</td>
                    <td>${produto.setor || ''}</td>
                    <td>${fotosHTML}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-history btn-sm" onclick="abrirModalHistorico('${produtoId}', '${produto.numero || ''} - ${produto.equipamento || ''}')">üìã</button>
                            <button class="btn-edit btn-sm" onclick="editarProduto('${produtoId}')">‚úèÔ∏è</button>
                            <button class="btn-delete btn-sm" onclick="confirmarExclusao('${produtoId}', '${produto.numero || ''}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>`;
        });
    }

    async function buscarProdutos(termo) {
        const lista = document.getElementById("lista");
        const loadError = document.getElementById("loadError");
        const pagination = document.getElementById("pagination");
        
        if (!lista) return;
        
        if (!termo || termo.trim() === "") {
            carregarProdutos();
            return;
        }
        
        try {
            if (loadError) loadError.style.display = "none";
            if (pagination) pagination.style.display = "none";
            
            const produtosQuery = query(
                collection(db, "produtos"),
                or(
                    where("numero", ">=", termo),
                    where("numero", "<=", termo + "\uf8ff"),
                    where("equipamento", ">=", termo),
                    where("equipamento", "<=", termo + "\uf8ff"),
                    where("modelo", ">=", termo),
                    where("modelo", "<=", termo + "\uf8ff"),
                    where("setor", ">=", termo),
                    where("setor", "<=", termo + "\uf8ff")
                )
            );
            
            const querySnapshot = await getDocs(produtosQuery);
            atualizarListaProdutos(querySnapshot);
            
        } catch (error) {
            console.error("Erro na busca:", error);
            if (loadError) {
                loadError.textContent = "Erro na busca: " + error.message;
                loadError.style.display = "block";
            }
        }
    }

    async function proximaPagina() {
        currentPage++;
        await carregarProdutos();
    }

    async function paginaAnterior() {
        if (currentPage > 1) {
            currentPage--;
            await carregarProdutos();
        }
    }

    // ====== SALVAR NOVO PRODUTO ======
    async function salvarProduto() {
        const numero = document.getElementById("numero");
        const equipamento = document.getElementById("equipamento");
        const setor = document.getElementById("setor");
        const modelo = document.getElementById("modelo");
        const configuracao = document.getElementById("configuracao");
        const historicoInicial = document.getElementById("historico");
        const preview = document.getElementById("preview");
        const saveError = document.getElementById("saveError");
        const uploadStatus = document.getElementById("uploadStatus");
        
        const numeroVal = numero.value.trim();
        const equipamentoVal = equipamento.value.trim();
        const setorVal = setor.value.trim();
        const modeloVal = modelo.value.trim();
        const configuracaoVal = configuracao.value.trim();
        const historicoInicialVal = historicoInicial.value.trim();
        
        if (!numeroVal) {
            showMobileToast("Por favor, insira o n√∫mero do patrim√¥nio", "error");
            numero.focus();
            return;
        }
        
        if (!equipamentoVal) {
            showMobileToast("Por favor, insira o equipamento", "error");
            equipamento.focus();
            return;
        }
        
        if (!setorVal) {
            showMobileToast("Por favor, insira o setor alocado", "error");
            setor.focus();
            return;
        }
        
        if (uploadStatus && uploadStatus.style.display === 'block') {
            showMobileToast("Aguarde o upload das imagens terminar antes de salvar.", "error");
            return;
        }
        
        try {
            if (saveError) saveError.style.display = "none";
            
            const fotosUrls = fotoBase64.map(img => img.url);
            
            let historicoArray = [];
            if (historicoInicialVal) {
                historicoArray.push({
                    data: new Date().toISOString(),
                    texto: historicoInicialVal,
                    autor: auth.currentUser?.email || "Sistema"
                });
            }
            
            await addDoc(collection(db, "produtos"), {
                numero: numeroVal,
                equipamento: equipamentoVal,
                setor: setorVal,
                modelo: modeloVal,
                configuracao: configuracaoVal,
                fotos: fotosUrls,
                historico: historicoArray,
                timestamp: Timestamp.now(),
                criadoPor: auth.currentUser?.email || "desconhecido"
            });
            
            // Limpar tudo
            numero.value = "";
            equipamento.value = "";
            setor.value = "";
            modelo.value = "";
            configuracao.value = "";
            historicoInicial.value = "";
            fotoBase64 = [];
            if (preview) preview.innerHTML = "";
            document.getElementById("photoUpload").value = "";
            
            currentPage = 1;
            lastVisible = null;
            await carregarProdutos();
            
            showMobileToast("‚úÖ Produto salvo com sucesso!", "success");
            
        } catch (error) {
            console.error("Erro ao salvar produto:", error);
            if (saveError) {
                saveError.textContent = "Erro ao salvar: " + error.message;
                saveError.style.display = "block";
            }
            showMobileToast("‚ùå Erro ao salvar produto: " + error.message, "error");
        }
    }

    // ====== EDI√á√ÉO DE PRODUTOS ======
    function abrirModalEdicao(produtoId, produto) {
        currentProductId = produtoId;
        
        document.getElementById("editNumero").value = produto.numero || "";
        document.getElementById("editEquipamento").value = produto.equipamento || "";
        document.getElementById("editSetor").value = produto.setor || "";
        document.getElementById("editModelo").value = produto.modelo || "";
        document.getElementById("editConfiguracao").value = produto.configuracao || "";
        
        const editCurrentPhotos = document.getElementById("editCurrentPhotos");
        editCurrentPhotos.innerHTML = "<label>üì∏ Fotos atuais</label>";
        
        if (produto.fotos && produto.fotos.length > 0) {
            editCurrentPhotos.innerHTML += '<div class="photo-container">';
            produto.fotos.forEach((url, index) => {
                editCurrentPhotos.innerHTML += `
                    <div class="photo-wrapper">
                        <img src="${url}" 
                             class="photo-thumbnail" 
                             onclick="visualizarImagemModalComTodas([${produto.fotos.map(f => `'${f}'`).join(',')}], ${index})"
                             title="Clique para ampliar"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/70?text=Imagem'">
                    </div>`;
            });
            editCurrentPhotos.innerHTML += '</div>';
        } else {
            editCurrentPhotos.innerHTML += '<div class="photo-container"><span style="color: #6b7280;">Nenhuma foto</span></div>';
        }
        
        editFotoBase64 = [];
        document.getElementById("editPreview").innerHTML = "";
        document.getElementById("editPhotoUpload").value = "";
        
        document.getElementById("editModal").style.display = "flex";
    }

    function fecharModalEdicao() {
        document.getElementById("editModal").style.display = "none";
        currentProductId = null;
        editFotoBase64 = [];
        document.getElementById("editPreview").innerHTML = "";
        const editError = document.getElementById("editError");
        if (editError) editError.style.display = "none";
    }

    async function editarProduto(produtoId) {
        try {
            const produtoRef = doc(db, "produtos", produtoId);
            const produtoDoc = await getDoc(produtoRef);
            
            if (produtoDoc.exists()) {
                const produto = produtoDoc.data();
                abrirModalEdicao(produtoId, produto);
            }
        } catch (error) {
            console.error("Erro ao buscar produto para edi√ß√£o:", error);
            showMobileToast("Erro ao carregar produto para edi√ß√£o: " + error.message, "error");
        }
    }

    async function atualizarProduto() {
        const editNumero = document.getElementById("editNumero");
        const editEquipamento = document.getElementById("editEquipamento");
        const editSetor = document.getElementById("editSetor");
        const editModelo = document.getElementById("editModelo");
        const editConfiguracao = document.getElementById("editConfiguracao");
        const editError = document.getElementById("editError");
        
        if (!currentProductId) return;
        
        const numeroVal = editNumero.value.trim();
        const equipamentoVal = editEquipamento.value.trim();
        const setorVal = editSetor.value.trim();
        const modeloVal = editModelo.value.trim();
        const configuracaoVal = editConfiguracao.value.trim();
        
        if (!numeroVal) {
            showMobileToast("Por favor, insira o n√∫mero do patrim√¥nio", "error");
            editNumero.focus();
            return;
        }
        
        if (!equipamentoVal) {
            showMobileToast("Por favor, insira o equipamento", "error");
            editEquipamento.focus();
            return;
        }
        
        try {
            if (editError) editError.style.display = "none";
            
            const produtoRef = doc(db, "produtos", currentProductId);
            const produtoDoc = await getDoc(produtoRef);
            
            let fotosAtualizadas = [];
            
            if (produtoDoc.exists()) {
                const produtoAtual = produtoDoc.data();
                fotosAtualizadas = [...(produtoAtual.fotos || [])];
            }
            
            const novasFotosUrls = editFotoBase64.map(img => img.url);
            fotosAtualizadas = [...fotosAtualizadas, ...novasFotosUrls];
            
            await updateDoc(produtoRef, {
                numero: numeroVal,
                equipamento: equipamentoVal,
                setor: setorVal,
                modelo: modeloVal,
                configuracao: configuracaoVal,
                fotos: fotosAtualizadas,
                atualizadoEm: Timestamp.now(),
                atualizadoPor: auth.currentUser?.email || "desconhecido"
            });
            
            fecharModalEdicao();
            await carregarProdutos();
            
            showMobileToast("‚úÖ Produto atualizado com sucesso!", "success");
            
        } catch (error) {
            console.error("Erro ao atualizar produto:", error);
            if (editError) {
                editError.textContent = "Erro ao atualizar: " + error.message;
                editError.style.display = "block";
            }
            showMobileToast("‚ùå Erro ao atualizar produto: " + error.message, "error");
        }
    }

    // ====== HIST√ìRICO DE MANUTEN√á√ÉO ======
    async function abrirModalHistorico(produtoId, produtoNome) {
        currentHistoryProductId = produtoId;
        
        document.getElementById("historyProductTitle").textContent = produtoNome;
        document.getElementById("newHistoryEntry").value = "";
        
        await carregarHistorico(produtoId);
        document.getElementById("historyModal").style.display = "flex";
    }

    function fecharModalHistorico() {
        document.getElementById("historyModal").style.display = "none";
        currentHistoryProductId = null;
    }

    async function carregarHistorico(produtoId) {
        const historyList = document.getElementById("historyList");
        
        try {
            const produtoRef = doc(db, "produtos", produtoId);
            const produtoDoc = await getDoc(produtoRef);
            
            if (produtoDoc.exists()) {
                const produto = produtoDoc.data();
                const historico = produto.historico || [];
                
                if (historico.length === 0) {
                    historyList.innerHTML = '<p style="text-align:center;color:#666">Nenhuma entrada no hist√≥rico</p>';
                    return;
                }
                
                historico.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                let html = '';
                historico.forEach(entry => {
                    const date = new Date(entry.data).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <div class="history-item" style="background: #f8fafc; border-left: 4px solid #2563eb; padding: 10px; margin: 5px 0; border-radius: 4px;">
                            <div class="history-date" style="font-weight: bold; color: #374151; font-size: 14px;">${date}</div>
                            <div class="history-text" style="color: #4b5563; margin-top: 5px;">${entry.texto}</div>
                            <div class="history-author" style="font-size: 12px; color: #6b7280; text-align: right; margin-top: 5px;">Registrado por: ${entry.autor || 'Sistema'}</div>
                        </div>
                    `;
                });
                
                historyList.innerHTML = html;
            }
        } catch (error) {
            console.error("Erro ao carregar hist√≥rico:", error);
            historyList.innerHTML = '<p style="color:red">Erro ao carregar hist√≥rico</p>';
        }
    }

    async function adicionarEntradaHistorico() {
        const newHistoryEntry = document.getElementById("newHistoryEntry");
        const texto = newHistoryEntry.value.trim();
        
        if (!texto) {
            showMobileToast("Por favor, descreva o que foi feito na manuten√ß√£o", "error");
            newHistoryEntry.focus();
            return;
        }
        
        if (!currentHistoryProductId) return;
        
        try {
            const produtoRef = doc(db, "produtos", currentHistoryProductId);
            const usuario = auth.currentUser?.email || "Sistema";
            const dataAtual = new Date().toISOString();
            
            const novaEntrada = {
                data: dataAtual,
                texto: texto,
                autor: usuario
            };
            
            await updateDoc(produtoRef, {
                historico: arrayUnion(novaEntrada)
            });
            
            newHistoryEntry.value = "";
            await carregarHistorico(currentHistoryProductId);
            
            showMobileToast("‚úÖ Entrada adicionada ao hist√≥rico!", "success");
            
        } catch (error) {
            console.error("Erro ao adicionar hist√≥rico:", error);
            showMobileToast("‚ùå Erro ao adicionar entrada: " + error.message, "error");
        }
    }

    // ====== EXCLUS√ÉO ======
    async function confirmarExclusao(produtoId, numero) {
        if (confirm("Tem certeza que deseja excluir o patrim√¥nio " + numero + "? Esta a√ß√£o n√£o pode ser desfeita.")) {
            try {
                await excluirProduto(produtoId);
                showMobileToast("‚úÖ Produto exclu√≠do com sucesso!", "success");
            } catch (error) {
                console.error("Erro ao excluir:", error);
                showMobileToast("‚ùå Erro ao excluir produto: " + error.message, "error");
            }
        }
    }

    async function excluirProduto(produtoId) {
        try {
            await deleteDoc(doc(db, "produtos", produtoId));
            
            const elemento = document.getElementById("produto-" + produtoId);
            if (elemento) {
                elemento.remove();
            }
            
            const lista = document.getElementById("lista");
            if (lista && lista.children.length === 1) {
                carregarProdutos();
            }
            
        } catch (error) {
            console.error("Erro ao excluir produto:", error);
            throw error;
        }
    }

    // ====== VISUALIZA√á√ÉO DE IMAGENS ======
    function visualizarImagemFromArray(index) {
        if (!fotoBase64[index]) return;
        const url = fotoBase64[index].url || fotoBase64[index].localPreview;
        visualizarImagemModalComTodas([url], 0);
    }

    function visualizarImagemFromList(produtoId, index) {
        const container = document.querySelector(`#produto-${produtoId} .photo-container`);
        if (!container) return;
        
        const images = container.querySelectorAll('img');
        const imageUrls = [];
        images.forEach(img => {
            imageUrls.push(img.src);
        });
        
        visualizarImagemModalComTodas(imageUrls, index);
    }

    function visualizarImagemModalComTodas(imageUrls, startIndex) {
        currentImages = imageUrls;
        currentImageIndex = startIndex;
        
        const modalImage = document.getElementById("modalImage");
        const imageCounter = document.getElementById("imageCounter");
        const imageModal = document.getElementById("imageModal");
        const prevBtn = document.querySelector('.image-nav.prev');
        const nextBtn = document.querySelector('.image-nav.next');
        
        if (modalImage && imageCounter && imageModal) {
            modalImage.src = currentImages[currentImageIndex];
            imageCounter.textContent = (currentImageIndex + 1) + ' / ' + currentImages.length;
            imageModal.style.display = "flex";
            
            if (prevBtn && nextBtn) {
                prevBtn.style.display = currentImages.length > 1 ? 'flex' : 'none';
                nextBtn.style.display = currentImages.length > 1 ? 'flex' : 'none';
            }
        }
    }

    function navImage(direction) {
        if (!currentImages || !currentImages.length) return;
        
        currentImageIndex += direction;
        
        if (currentImageIndex < 0) {
            currentImageIndex = currentImages.length - 1;
        } else if (currentImageIndex >= currentImages.length) {
            currentImageIndex = 0;
        }
        
        const modalImage = document.getElementById("modalImage");
        const imageCounter = document.getElementById("imageCounter");
        
        if (modalImage && imageCounter) {
            modalImage.src = currentImages[currentImageIndex];
            imageCounter.textContent = (currentImageIndex + 1) + ' / ' + currentImages.length;
        }
    }

    function fecharModalImagem() {
        const imageModal = document.getElementById("imageModal");
        if (imageModal) {
            imageModal.style.display = "none";
        }
        currentImages = [];
        currentImageIndex = 0;
    }

    // ====== IMPORT/EXPORT EXCEL ======
    function abrirImportModal() {
        document.getElementById('importModal').style.display = 'flex';
        document.getElementById('excelFile').value = '';
        document.getElementById('importStatus').style.display = 'none';
        document.getElementById('importSummary').style.display = 'none';
    }

    function fecharImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }

    function baixarModeloExcel(event) {
        if (event) event.preventDefault();
        
        try {
            const dados = [
                ['N√∫mero', 'Equipamento', 'Setor', 'Modelo', 'Configura√ß√£o', 'Hist√≥rico Inicial'],
                ['001234', 'Notebook', 'TI', 'Dell Latitude 5420', 'i5-11400H, 16GB RAM, 512GB SSD', '15/01/2024 - Troca de pasta t√©rmica'],
                ['001235', 'Desktop', 'Administrativo', 'HP ProDesk 400', 'i3-10100, 8GB RAM, 256GB SSD', ''],
                ['001236', 'Monitor', 'TI', 'Dell P2422H', '24" Full HD, IPS', ''],
                ['', '', '', '', '', ''],
                ['INSTRU√á√ïES:', '', '', '', '', ''],
                ['1. Preencha as colunas (as 3 primeiras s√£o obrigat√≥rias)', '', '', '', '', ''],
                ['2. Deixe em branco se n√£o tiver informa√ß√£o', '', '', '', '', ''],
                ['3. Salve como arquivo Excel (.xlsx) ou CSV', '', '', '', '', ''],
                ['4. Importe usando o bot√£o "Importar Excel"', '', '', '', '', '']
            ];
            
            // Criar workbook
            const wb = XLSX.utils.book_new();
            
            // Converter dados para worksheet
            const ws = XLSX.utils.aoa_to_sheet(dados);
            
            // Adicionar worksheet ao workbook
            XLSX.utils.book_append_sheet(wb, ws, "Modelo Patrim√¥nio TI");
            
            // Ajustar largura das colunas
            const wscols = [
                {wch: 12}, // N√∫mero
                {wch: 15}, // Equipamento
                {wch: 15}, // Setor
                {wch: 20}, // Modelo
                {wch: 30}, // Configura√ß√£o
                {wch: 40}  // Hist√≥rico
            ];
            ws['!cols'] = wscols;
            
            // Gerar nome do arquivo com data
            const fileName = `modelo_patrimonio_ti.xlsx`;
            
            // Escrever arquivo
            XLSX.writeFile(wb, fileName);
            
            showMobileToast('‚úÖ Modelo Excel baixado com sucesso!', 'success');
            
        } catch (error) {
            console.error('Erro ao baixar modelo:', error);
            showMobileToast('‚ùå Erro ao baixar modelo. Tente novamente.', 'error');
        }
        
        return false;
    }

    async function exportarParaExcel() {
        try {
            const produtosQuery = query(collection(db, "produtos"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(produtosQuery);
            
            if (querySnapshot.empty) {
                showMobileToast("Nenhum produto para exportar", "error");
                return;
            }
            
            const dados = [
                ['N√∫mero', 'Equipamento', 'Setor', 'Modelo', 'Configura√ß√£o', 'Fotos', 'Hist√≥rico', 'Criado em', 'Criado por']
            ];
            
            querySnapshot.forEach(doc => {
                const produto = doc.data();
                
                let historicoFormatado = '';
                if (produto.historico && Array.isArray(produto.historico)) {
                    historicoFormatado = produto.historico.map(entry => {
                        const date = new Date(entry.data).toLocaleDateString('pt-BR');
                        return `${date}: ${entry.texto}`;
                    }).join('; ');
                }
                
                let fotosFormatado = '';
                if (produto.fotos && Array.isArray(produto.fotos)) {
                    fotosFormatado = produto.fotos.join('; ');
                }
                
                dados.push([
                    produto.numero || '',
                    produto.equipamento || '',
                    produto.setor || '',
                    produto.modelo || '',
                    produto.configuracao || '',
                    fotosFormatado,
                    historicoFormatado,
                    produto.timestamp ? produto.timestamp.toDate().toLocaleDateString('pt-BR') : '',
                    produto.criadoPor || ''
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Patrim√¥nio TI");
            
            const wscols = [
                {wch: 12}, {wch: 15}, {wch: 15}, {wch: 20}, {wch: 30}, 
                {wch: 50}, {wch: 50}, {wch: 15}, {wch: 20}
            ];
            ws['!cols'] = wscols;
            
            XLSX.writeFile(wb, `patrimonio_ti_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showMobileToast(`‚úÖ ${querySnapshot.size} produtos exportados com sucesso!`, "success");
            
        } catch (error) {
            console.error("Erro ao exportar:", error);
            showMobileToast("‚ùå Erro ao exportar: " + error.message, "error");
        }
    }

    async function importarDoExcel() {
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        
        if (!file) {
            showMobileToast("Por favor, selecione um arquivo Excel ou CSV", "error");
            return;
        }
        
        const importStatus = document.getElementById('importStatus');
        const importSummary = document.getElementById('importSummary');
        
        try {
            importStatus.style.display = 'block';
            importStatus.style.background = '#fef3c7';
            importStatus.style.color = '#92400e';
            importStatus.innerHTML = '<div class="loading-spinner"></div> Processando arquivo...';
            
            const data = await readExcelFile(file);
            
            if (!data || data.length === 0) {
                throw new Error('Arquivo vazio ou formato inv√°lido');
            }
            
            const headers = data[0];
            const requiredHeaders = ['N√∫mero', 'Equipamento', 'Setor'];
            
            for (const header of requiredHeaders) {
                if (!headers.includes(header)) {
                    throw new Error(`Coluna obrigat√≥ria n√£o encontrada: "${header}"`);
                }
            }
            
            const produtos = [];
            let sucesso = 0;
            let erro = 0;
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.every(cell => !cell)) continue;
                
                try {
                    const numeroIndex = headers.indexOf('N√∫mero');
                    const equipamentoIndex = headers.indexOf('Equipamento');
                    const setorIndex = headers.indexOf('Setor');
                    const modeloIndex = headers.indexOf('Modelo');
                    const configuracaoIndex = headers.indexOf('Configura√ß√£o');
                    const historicoIndex = headers.indexOf('Hist√≥rico Inicial');
                    
                    const produto = {
                        numero: row[numeroIndex]?.toString().trim() || '',
                        equipamento: row[equipamentoIndex]?.toString().trim() || '',
                        setor: row[setorIndex]?.toString().trim() || '',
                        modelo: row[modeloIndex]?.toString().trim() || '',
                        configuracao: row[configuracaoIndex]?.toString().trim() || '',
                        fotos: [],
                        timestamp: Timestamp.now(),
                        criadoPor: auth.currentUser?.email || "Importa√ß√£o Excel"
                    };
                    
                    if (!produto.numero || !produto.equipamento || !produto.setor) {
                        throw new Error('Campos obrigat√≥rios faltando');
                    }
                    
                    const historicoInicial = row[historicoIndex]?.toString().trim();
                    if (historicoInicial) {
                        produto.historico = [{
                            data: new Date().toISOString(),
                            texto: historicoInicial,
                            autor: auth.currentUser?.email || "Importa√ß√£o Excel"
                        }];
                    }
                    
                    produtos.push(produto);
                    sucesso++;
                    
                } catch (error) {
                    erro++;
                }
            }
            
            if (produtos.length > 0) {
                for (const produto of produtos) {
                    await addDoc(collection(db, "produtos"), produto);
                }
            }
            
            importStatus.style.background = '#d1fae5';
            importStatus.style.color = '#065f46';
            importStatus.innerHTML = `‚úÖ Importa√ß√£o conclu√≠da!`;
            
            importSummary.innerHTML = `
                <strong>Resumo da importa√ß√£o:</strong><br>
                ‚úÖ ${sucesso} produtos importados com sucesso<br>
                ${erro > 0 ? `‚ùå ${erro} produtos com erro` : ''}
            `;
            importSummary.style.display = 'block';
            
            setTimeout(() => {
                carregarProdutos();
                fecharImportModal();
                showMobileToast(`‚úÖ ${sucesso} produtos importados com sucesso!`, "success");
            }, 2000);
            
        } catch (error) {
            console.error('Erro na importa√ß√£o:', error);
            importStatus.style.background = '#fee2e2';
            importStatus.style.color = '#991b1b';
            importStatus.innerHTML = `‚ùå Erro na importa√ß√£o: ${error.message}`;
            showMobileToast(`‚ùå Erro na importa√ß√£o: ${error.message}`, "error");
        }
    }

    function readExcelFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    resolve(jsonData);
                } catch (error) {
                    reject(error);
                }
            };
            
            reader.onerror = reject;
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        });
    }

    // ====== CONFIGURA√á√ÉO DE AUTENTICA√á√ÉO ======
    onAuthStateChanged(auth, user => {
        const loginCard = document.getElementById("loginCard");
        const app = document.getElementById("app");
        const logoutBtn = document.getElementById("logoutBtn");
        const userEmail = document.getElementById("userEmail");
        
        if (user) {
            if (loginCard) loginCard.classList.add("hidden");
            if (app) app.classList.remove("hidden");
            if (logoutBtn) logoutBtn.classList.remove("hidden");
            if (userEmail) userEmail.innerText = user.email;
            
            carregarProdutos();
        } else {
            if (loginCard) loginCard.classList.remove("hidden");
            if (app) app.classList.add("hidden");
            if (logoutBtn) logoutBtn.classList.add("hidden");
            if (userEmail) userEmail.innerText = "";
            
            const lista = document.getElementById("lista");
            if (lista) lista.innerHTML = "";
            
            const loadError = document.getElementById("loadError");
            if (loadError) loadError.style.display = "none";
            
            const pagination = document.getElementById("pagination");
            if (pagination) pagination.style.display = "none";
        }
    });

    // ====== EXPORTAR FUN√á√ïES PARA ESCOPO GLOBAL ======
    window.editarProduto = editarProduto;
    window.confirmarExclusao = confirmarExclusao;
    window.visualizarImagemModalComTodas = visualizarImagemModalComTodas;
    window.visualizarImagemFromArray = visualizarImagemFromArray;
    window.visualizarImagemFromList = visualizarImagemFromList;
    window.navImage = navImage;
    window.fecharModalImagem = fecharModalImagem;
    window.abrirModalHistorico = abrirModalHistorico;
    window.fecharModalHistorico = fecharModalHistorico;
    window.fecharModalEdicao = fecharModalEdicao;
    window.fecharCamera = fecharCamera;
    window.fecharImportModal = fecharImportModal;
    window.baixarModeloExcel = baixarModeloExcel;
    window.importarDoExcel = importarDoExcel;

    </script>
</body>
</html>
