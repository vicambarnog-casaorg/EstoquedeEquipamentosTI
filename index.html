<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Patrimônio</title>
<style>
/* Estilo claro/escuro automático */
:root {
  color-scheme: light dark;
  --bg: #ffffff;
  --fg: #222222;
  --card: #f1f1f1;
  --border: #cccccc;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #121212;
    --fg: #e1e1e1;
    --card: #1e1e1e;
    --border: #333333;
  }
}
body {
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:Arial, sans-serif;
}
header, .card {
  background:var(--card);
  padding:16px;
  border-radius:8px;
  border:1px solid var(--border);
}
input, button {
  padding:8px;
  margin:4px 0;
}
.hidden{display:none;}
.photo-thumb{width:80px;height:80px;object-fit:cover;border-radius:6px;}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:#0008;display:none;align-items:center;justify-content:center;}
.modal.show{display:flex;}
</style>
</head>
<body>

<div id="loginBox">
  <header><h2>Login</h2></header>
  <input id="emailLogin" placeholder="Email"><br>
  <input id="senhaLogin" placeholder="Senha" type="password"><br>
  <button id="btnLogin">Entrar</button>
  <div id="loginMsg" style="color:red;display:none"></div>
</div>

<div id="appLayout" class="hidden">
  <header>
    <h2>Patrimônio</h2>
    <button id="btnLogout">Sair</button>
  </header>

  <section class="card">
    <h3>Novo Produto</h3>
    <input id="numeroInput" placeholder="Nº Patrimônio">
    <input id="equipamentoInput" placeholder="Equipamento">
    <input id="setorInput" placeholder="Setor"><br>
    <button id="openCameraBtn">Câmera</button>
    <input id="fileInput" type="file" accept="image/*" multiple class="hidden">
    <button id="selectFilesBtn">Selecionar Fotos</button><br>
    <div id="stagedPreview" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
    <button id="saveProductBtn">Salvar Produto</button>
  </section>

  <section class="card">
    <h3>Produtos</h3>
    <table border="1" width="100%">
      <thead><tr><th>Nº</th><th>Equipamento</th><th>Setor</th><th>Foto</th></tr></thead>
      <tbody id="productTableBody"></tbody>
    </table>
  </section>
</div>

<!-- Modal Câmera -->
<div id="cameraModal" class="modal">
  <div class="card">
    <video id="cameraVideo" autoplay style="width:280px"></video><br>
    <button id="captureBtn">Capturar</button>
    <button id="closeCameraBtn">Fechar</button>
  </div>
</div>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAwCfiEB3JEUu_6rKR32C2E5whnb6-SgX0",
  authDomain: "sis-eetibkp.firebaseapp.com",
  projectId: "sis-eetibkp",
  storageBucket: "sis-eetibkp.appspot.com",
  messagingSenderId: "524123050144",
  appId: "1:524123050144:web:79fba6107cf073118679c5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Elementos
const loginBox = document.getElementById("loginBox");
const appLayout = document.getElementById("appLayout");
const emailLogin = document.getElementById("emailLogin");
const senhaLogin = document.getElementById("senhaLogin");
const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const loginMsg = document.getElementById("loginMsg");

const numeroInput = document.getElementById("numeroInput");
const equipamentoInput = document.getElementById("equipamentoInput");
const setorInput = document.getElementById("setorInput");
const fileInput = document.getElementById("fileInput");
const selectFilesBtn = document.getElementById("selectFilesBtn");
const stagedPreview = document.getElementById("stagedPreview");
const saveProductBtn = document.getElementById("saveProductBtn");

const cameraModal = document.getElementById("cameraModal");
const cameraVideo = document.getElementById("cameraVideo");
const openCameraBtn = document.getElementById("openCameraBtn");
const closeCameraBtn = document.getElementById("closeCameraBtn");
const captureBtn = document.getElementById("captureBtn");

const productTableBody = document.getElementById("productTableBody");

let capturedPhotos = [];

// Login
btnLogin.onclick = async ()=>{
  try{
    await auth.signInWithEmailAndPassword(emailLogin.value, senhaLogin.value);
  }catch(e){
    loginMsg.style.display="block";
    loginMsg.innerText=e.message;
  }
};
btnLogout.onclick=()=>auth.signOut();

// Auth listener
auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.classList.add("hidden");
    appLayout.classList.remove("hidden");
    loadProducts();
  } else {
    loginBox.classList.remove("hidden");
    appLayout.classList.add("hidden");
  }
});

// Seleção de arquivos
selectFilesBtn.onclick=()=>fileInput.click();
fileInput.onchange=e=>{
  for(const file of e.target.files){
    capturedPhotos.push(file);
    const img=document.createElement("img");
    img.src=URL.createObjectURL(file);
    img.className="photo-thumb";
    stagedPreview.appendChild(img);
  }
};

// Câmera
openCameraBtn.onclick=async ()=>{
  cameraModal.classList.add("show");
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  cameraVideo.srcObject=stream;
};
closeCameraBtn.onclick=()=>{
  cameraModal.classList.remove("show");
  let track=cameraVideo.srcObject?.getTracks()[0];
  track?.stop();
};
captureBtn.onclick=()=>{
  const canvas=document.createElement("canvas");
  canvas.width=300; canvas.height=300;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(cameraVideo,0,0,300,300);
  canvas.toBlob(blob=>{
    capturedPhotos.push(blob);
    const img=document.createElement("img");
    img.src=URL.createObjectURL(blob);
    img.className="photo-thumb";
    stagedPreview.appendChild(img);
  },"image/jpeg",0.6);
  closeCameraBtn.click();
};

// Upload Cloudinary
async function uploadCloudinary(blob){
  const url="https://api.cloudinary.com/v1_1/dwanrvvob/image/upload";
  const form=new FormData();
  form.append("file", blob);
  form.append("upload_preset","unsigned_patrimonio");
  form.append("folder","patrimonio");
  const r=await fetch(url,{method:"POST",body:form});
  const j=await r.json();
  return j.secure_url;
}

// Salvar produto
saveProductBtn.onclick=async ()=>{
  let urls=[];
  for(const photo of capturedPhotos){
    urls.push(await uploadCloudinary(photo));
  }
  await db.collection("produtos").add({
    numero:numeroInput.value,
    equipamento:equipamentoInput.value,
    setor:setorInput.value,
    fotos:urls,
    criado:Date.now()
  });
  capturedPhotos=[];
  stagedPreview.innerHTML="";
  numeroInput.value="";
  equipamentoInput.value="";
  setorInput.value="";
  loadProducts();
};

// Carregar produtos
async function loadProducts(){
  const snap=await db.collection("produtos").orderBy("criado","desc").get();
  productTableBody.innerHTML="";
  snap.forEach(doc=>{
    const p=doc.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p.numero}</td>
      <td>${p.equipamento}</td>
      <td>${p.setor}</td>
      <td>${p.fotos?.length?'<img class="photo-thumb" src="'+p.fotos[0]+'">':'—'}</td>
    `;
    productTableBody.appendChild(tr);
  });
}
</script>

<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

</body>
</html>
