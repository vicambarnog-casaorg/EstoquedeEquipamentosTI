<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Sistema de Patrim√¥nio - Sincronizado</title>

  <!-- Manifest simplificado -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2lzdGVtYSBkZSBQYXRyaW1vbmkiLCJzaG9ydF9uYW1lIjoiUGF0cmltw6FuaW8iLCJ2ZXJzaW9uIjoiMS4wIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJpY29ucyI6W119">

  <style>
    :root{
      --primary:#667eea;
      --primary-dark:#5568d3;
      --danger:#dc3545;
      --muted:#888;
      --bg:#f3f6fb;
      --card:#ffffff;
      --success:#d4edda;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),#fff);
      padding:20px;
      min-height:100vh;
    }
    .app{
      max-width:1200px;margin:0 auto;background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 18px 40px rgba(23,30,60,0.08)
    }
    header{background:linear-gradient(90deg,var(--primary),#764ba2);color:#fff;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.12)}
    .btn-logout{background:rgba(255,255,255,0.12);color:#fff}
    .btn-sync{background:rgba(255,255,255,0.15);color:#fff}
    main{padding:20px;display:grid;grid-template-columns:380px 1fr;gap:18px}
    .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(18,24,40,0.04)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text], input[type=date], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fbfdff}
    textarea{min-height:80px;resize:vertical}
    .file-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .photo-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .photo-preview .item{position:relative;width:100px;height:80px;border-radius:6px;overflow:hidden;border:1px solid #e6eef8;background:#f7f9fc}
    .photo-preview img{width:100%;height:100%;object-fit:cover}
    .photo-remove{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #eef4fb;font-size:14px}
    th{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:#fff}
    .actions{display:flex;gap:8px}
    .btn-view{background:#28a745;color:#fff}
    .btn-edit{background:#ffc107;color:#111}
    .btn-del{background:var(--danger);color:#fff}
    .status{padding:8px;border-radius:8px;margin-bottom:12px}
    .hide{display:none !important}
    .sync-status{font-size:12px;background:rgba(255,255,255,0.1);padding:4px 8px;border-radius:4px}
    @media(max-width:980px){main{grid-template-columns:1fr;}}
    /* modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1500}
    .modal .content{width:min(920px,96%);max-height:90vh;overflow:auto;padding:16px;border-radius:10px;background:#fff}
    .flex{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .camera-video{width:100%;max-height:360px;border-radius:8px;background:#000}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>üìã Sistema de Patrim√¥nio - Sincronizado</h1>
      <div class="controls" id="headerControls">
        <div id="syncStatus" class="sync-status hide">üîÑ Sincronizando...</div>
        <div id="currentUserBox" class="muted small hide">Conectado como <strong id="currentUser"></strong></div>
        <button class="btn btn-sync" id="btnSyncUp" title="Enviar backup para nuvem">‚Üë Backup</button>
        <button class="btn btn-sync" id="btnSyncDown" title="Restaurar da nuvem">‚Üì Restaurar</button>
        <button class="btn btn-ghost" id="btnOpenLogin">Entrar</button>
        <button class="btn btn-logout hide" id="btnLogout">Sair</button>
      </div>
    </header>

    <main>
      <!-- esquerda: formul√°rio (adicionar / editar / c√¢mera) -->
      <section class="card" id="leftPanel">
        <div id="authArea">
          <!-- login form -->
          <div id="loginBox">
            <h3>üîê Entrar</h3>
            <div id="loginError" class="status hide" style="background:#fdecea;color:#611a15"></div>
            <form id="loginForm">
              <label>Usu√°rio</label>
              <input type="text" id="username" placeholder="usu√°rio" autocomplete="username" value="admin">
              <label>Senha</label>
              <input type="text" id="password" placeholder="senha" autocomplete="current-password" value="admin123">
              <div style="margin-top:10px;display:flex;gap:8px">
                <button class="btn" type="submit" style="background:var(--primary);color:#fff">Entrar</button>
                <button type="button" id="btnFillDemo" class="btn" style="background:#eef4ff">Demo</button>
              </div>
              <p class="small" style="margin-top:8px">usu√°rio padr√£o: admin | senha: admin123</p>
            </form>
          </div>
        </div>

        <hr style="margin:14px 0">

        <div id="formArea" class="hide">
          <h3 id="formTitle">‚ûï Adicionar item</h3>
          <div id="photoCounter" class="small" style="margin-bottom:8px">0/10 fotos</div>
          <form id="patrimonioForm">
            <div class="form-row">
              <div>
                <label for="numeroPatrimonio">N√∫mero de Patrim√¥nio</label>
                <input id="numeroPatrimonio" type="text" required>
              </div>
              <div>
                <label for="equipamento">Equipamento</label>
                <input id="equipamento" type="text" required>
              </div>
            </div>

            <div class="form-row" style="margin-top:10px">
              <div>
                <label for="setor">Setor</label>
                <input id="setor" type="text" required>
              </div>
              <div>
                <label for="modelo">Modelo</label>
                <input id="modelo" type="text">
              </div>
            </div>

            <div style="margin-top:10px">
              <label for="configuracao">Configura√ß√£o</label>
              <input id="configuracao" type="text">
            </div>

            <div style="margin-top:12px">
              <label>Fotos (m√°x. 10 por item)</label>
              <div class="file-row">
                <input id="fileInput" type="file" accept="image/*" multiple>
                <button type="button" id="btnOpenCamera" class="btn" style="background:#17a2b8;color:#fff">C√¢mera</button>
                <div id="uploadStatus" class="small muted">Nenhuma foto</div>
              </div>
              <div id="photoPreview" class="photo-preview"></div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn" type="submit" style="background:var(--primary);color:#fff" id="btnSave">Salvar</button>
              <button class="btn" type="button" id="btnCancel" style="background:#f3f3f3">Cancelar</button>
              <button class="btn" type="button" id="btnNew" style="background:#eef4ff">Novo item</button>
            </div>
          </form>
        </div>

        <!-- camera modal inline -->
        <div id="cameraModal" class="hide" style="margin-top:12px">
          <h4>C√¢mera</h4>
          <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnCapture" class="btn" style="background:#28a745;color:#fff">Capturar</button>
            <button id="btnCloseCamera" class="btn" style="background:#dc3545;color:#fff">Fechar</button>
          </div>
        </div>
      </section>

      <!-- direita: tabela e visualiza√ß√µes -->
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>üìã Itens cadastrados</h3>
            <div class="small muted">Total: <span id="totalCount">0</span> | <span id="totalFotos">0 fotos</span></div>
          </div>

          <div id="tableWrap" style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th>N¬∫ Patrim√¥nio</th>
                  <th>Equipamento</th>
                  <th>Setor</th>
                  <th>Fotos</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="patrimonioTable">
                <tr><td colspan="5" class="small muted">Nenhum item cadastrado</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>üì¶ Visualizar</h3>
          <div id="viewBox" class="small muted">Selecione um item para ver detalhes</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: edit history -->
  <div id="modalHistory" class="modal hide">
    <div class="content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>üìú Hist√≥rico</h3>
        <button id="closeHistory" class="btn">Fechar</button>
      </div>
      <div id="historyContent" style="margin-top:12px"></div>

      <div style="margin-top:12px">
        <h4>Adicionar manuten√ß√£o</h4>
        <form id="maintenanceForm">
          <label>Data</label>
          <input type="date" id="maintenanceDate" required>
          <label style="margin-top:8px">Descri√ß√£o</label>
          <textarea id="maintenanceDescription" required></textarea>
          <div style="margin-top:8px">
            <button class="btn" type="submit" style="background:var(--primary);color:#fff">Adicionar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Sincroniza√ß√£o -->
  <div id="modalSync" class="modal hide">
    <div class="content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>üîÑ Sincroniza√ß√£o</h3>
        <button id="closeSync" class="btn">Fechar</button>
      </div>
      <div id="syncContent" style="margin-top:12px">
        <div id="syncInfo" class="small"></div>
        <div id="syncProgress" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <script>
    /* ================= CONFIGURA√á√ïES ================= */
    // Cloudinary - SEU CONFIG
    const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dwanrvvob/image/upload';
    const UPLOAD_PRESET = 'EETI_fotos';
    
    // Configura√ß√µes de otimiza√ß√£o
    const MAX_PHOTOS_PER_ITEM = 10;
    const BACKUP_JSON_NAME = 'patrimonio_backup';
    const BACKUP_FOLDER = 'EETI_backups'; // Pasta no Cloudinary para backups
    
    // Usu√°rios simples
    const users = { admin: 'admin123' };

    /* ================= STORAGE (wrapper sobre localStorage) ================= */
    window.storage = {
      list(prefix = '') {
        const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
        return { keys };
      },
      get(key) { return { value: localStorage.getItem(key) }; },
      set(key, value) { localStorage.setItem(key, value); },
      delete(key) { localStorage.removeItem(key); }
    };

    /* ================= ESTADO ================= */
    let currentUser = null;
    let tempPhotos = [];
    let editingId = null;
    let cameraStream = null;
    let lastBackupUrl = null; // URL do √∫ltimo backup na nuvem

    /* ================= ELEMENTOS ================= */
    const app = document.getElementById('app');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const btnOpenLogin = document.getElementById('btnOpenLogin');
    const btnLogout = document.getElementById('btnLogout');
    const currentUserBox = document.getElementById('currentUserBox');
    const currentUserSpan = document.getElementById('currentUser');
    const syncStatus = document.getElementById('syncStatus');

    const formArea = document.getElementById('formArea');
    const patrimonioForm = document.getElementById('patrimonioForm');
    const btnSave = document.getElementById('btnSave');
    const btnCancel = document.getElementById('btnCancel');
    const btnNew = document.getElementById('btnNew');
    const photoCounter = document.getElementById('photoCounter');

    const numeroPatrimonio = document.getElementById('numeroPatrimonio');
    const equipamento = document.getElementById('equipamento');
    const setor = document.getElementById('setor');
    const modelo = document.getElementById('modelo');
    const configuracao = document.getElementById('configuracao');

    const patrimonioTable = document.getElementById('patrimonioTable');
    const totalCount = document.getElementById('totalCount');
    const totalFotos = document.getElementById('totalFotos');
    const viewBox = document.getElementById('viewBox');

    const fileInput = document.getElementById('fileInput');
    const photoPreview = document.getElementById('photoPreview');
    const uploadStatus = document.getElementById('uploadStatus');

    const btnOpenCamera = document.getElementById('btnOpenCamera');
    const cameraModal = document.getElementById('cameraModal');
    const cameraVideo = document.getElementById('cameraVideo');
    const btnCapture = document.getElementById('btnCapture');
    const btnCloseCamera = document.getElementById('btnCloseCamera');

    // history modal
    const modalHistory = document.getElementById('modalHistory');
    const historyContent = document.getElementById('historyContent');
    const maintenanceForm = document.getElementById('maintenanceForm');
    const maintenanceDate = document.getElementById('maintenanceDate');
    const maintenanceDescription = document.getElementById('maintenanceDescription');
    const closeHistory = document.getElementById('closeHistory');

    // sync modal
    const modalSync = document.getElementById('modalSync');
    const syncContent = document.getElementById('syncContent');
    const syncInfo = document.getElementById('syncInfo');
    const syncProgress = document.getElementById('syncProgress');
    const closeSync = document.getElementById('closeSync');
    const btnSyncUp = document.getElementById('btnSyncUp');
    const btnSyncDown = document.getElementById('btnSyncDown');

    /* ================= FUN√á√ÉO DE UPLOAD SUPER OTIMIZADA ================= */
    async function uploadToCloudinaryOtimizado(fileOrBlob, fileName = null, isBackup = false) {
      const form = new FormData();
      form.append('file', fileOrBlob);
      form.append('upload_preset', UPLOAD_PRESET);
      
      if (isBackup) {
        // Para backups JSON, manter original
        form.append('resource_type', 'raw');
        if (BACKUP_FOLDER) {
          form.append('folder', BACKUP_FOLDER);
        }
        if (fileName) {
          form.append('public_id', fileName);
        }
      } else {
        // Para FOTOS - OTIMIZA√á√ÉO M√ÅXIMA (‚âà100KB)
        form.append('quality', '60');           // 60% qualidade (√≥timo para produtos)
        form.append('fetch_format', 'auto');    // WebP quando poss√≠vel
        form.append('width', '1024');           // Largura m√°xima
        form.append('height', '768');           // Altura m√°xima
        form.append('crop', 'limit');           // N√£o distorcer
        form.append('flags', 'progressive');    // JPEG progressivo
        form.append('background', 'auto');      // Auto fundo para PNG
      }
      
      if (!isBackup) {
        uploadStatus.textContent = 'Otimizando e enviando...';
      }
      
      try {
        const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: form });
        const data = await res.json();
        
        if (data.secure_url) {
          if (!isBackup) {
            // Para fotos, criar URL ainda mais otimizada
            const urlOtimizada = data.secure_url.replace(
              '/upload/', 
              '/upload/q_auto:good,f_auto,w_800,c_scale/'
            );
            
            const tamanhoKB = Math.round(data.bytes / 1024);
            console.log(`‚úÖ Foto otimizada: ${tamanhoKB}KB | URL: ${urlOtimizada.substring(0, 80)}...`);
            uploadStatus.textContent = `Enviado (${tamanhoKB}KB)`;
            setTimeout(() => uploadStatus.textContent = '', 2000);
            return urlOtimizada;
          } else {
            // Para backup, URL normal
            console.log(`‚úÖ Backup salvo: ${data.secure_url}`);
            return data.secure_url;
          }
        } else {
          throw new Error('Upload falhou: ' + JSON.stringify(data));
        }
      } catch (err) {
        if (!isBackup) {
          uploadStatus.textContent = 'Erro no upload';
        }
        console.error('‚ùå Erro upload:', err);
        throw err;
      }
    }

    /* ================= BACKUP NA NUVEM ================= */
    async function salvarBackupNaNuvem() {
      if (!currentUser) {
        alert('Fa√ßa login primeiro');
        return;
      }
      
      syncStatus.classList.remove('hide');
      syncStatus.textContent = 'üîÑ Criando backup...';
      
      try {
        // Coletar todos os itens
        const result = window.storage.list('patrimonio:');
        const keys = result.keys || [];
        const allItems = [];
        
        for (const key of keys) {
          const res = window.storage.get(key);
          if (res && res.value) {
            const item = JSON.parse(res.value);
            allItems.push(item);
          }
        }
        
        if (allItems.length === 0) {
          syncStatus.textContent = '‚ö† Nenhum item para backup';
          setTimeout(() => syncStatus.classList.add('hide'), 3000);
          return;
        }
        
        // Adicionar metadados
        const backupData = {
          timestamp: new Date().toISOString(),
          user: currentUser,
          totalItems: allItems.length,
          totalPhotos: allItems.reduce((sum, item) => sum + (item.photos?.length || 0), 0),
          items: allItems
        };
        
        // Criar arquivo JSON
        const jsonStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        
        // Nome do arquivo com timestamp
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const fileName = `${BACKUP_JSON_NAME}_${timestamp}`;
        
        // Upload para Cloudinary
        syncStatus.textContent = 'üîÑ Enviando para nuvem...';
        lastBackupUrl = await uploadToCloudinaryOtimizado(blob, fileName, true);
        
        // Salvar URL localmente para refer√™ncia futura
        localStorage.setItem('last_backup_url', lastBackupUrl);
        localStorage.setItem('last_backup_time', new Date().toISOString());
        
        // Calcular estat√≠sticas
        const stats = calcularEstatisticas();
        
        syncStatus.textContent = `‚úÖ Backup criado! ${allItems.length} itens, ${stats.totalFotos} fotos`;
        setTimeout(() => syncStatus.classList.add('hide'), 5000);
        
        mostrarModalSync(`
          <div style="color: #28a745;">
            <h4>‚úÖ Backup conclu√≠do com sucesso!</h4>
            <p><strong>${allItems.length}</strong> itens salvos na nuvem</p>
            <p><strong>${stats.totalFotos}</strong> fotos otimizadas</p>
            <p><strong>${new Date().toLocaleString('pt-BR')}</strong></p>
            <p class="small">Espa√ßo estimado: ${stats.estimativaMB.toFixed(1)}MB</p>
            <p class="small">URL: <a href="${lastBackupUrl}" target="_blank">Ver backup</a></p>
          </div>
        `);
        
        return lastBackupUrl;
        
      } catch (error) {
        syncStatus.textContent = '‚ùå Erro no backup';
        console.error('Erro ao salvar backup:', error);
        mostrarModalSync(`
          <div style="color: #dc3545;">
            <h4>‚ùå Erro no backup</h4>
            <p>${error.message}</p>
            <p class="small">Verifique sua conex√£o e tente novamente.</p>
          </div>
        `);
        setTimeout(() => syncStatus.classList.add('hide'), 5000);
      }
    }

    async function carregarBackupDaNuvem() {
      if (!currentUser) {
        alert('Fa√ßa login primeiro');
        return;
      }
      
      syncStatus.classList.remove('hide');
      syncStatus.textContent = 'üîÑ Buscando backup...';
      
      try {
        // Tentar usar URL salva localmente
        let backupUrl = localStorage.getItem('last_backup_url');
        
        if (!backupUrl) {
          // Se n√£o tiver URL salva, pedir ao usu√°rio
          backupUrl = prompt('Cole a URL do backup (ou deixe em branco para usar o √∫ltimo conhecido):');
          if (!backupUrl) {
            syncStatus.textContent = '‚ùå URL n√£o fornecida';
            setTimeout(() => syncStatus.classList.add('hide'), 3000);
            return;
          }
        }
        
        syncStatus.textContent = 'üîÑ Baixando backup...';
        const response = await fetch(backupUrl);
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const backupData = await response.json();
        
        // Verificar estrutura
        if (!backupData.items || !Array.isArray(backupData.items)) {
          throw new Error('Formato de backup inv√°lido');
        }
        
        // Confirmar com usu√°rio
        const confirmar = confirm(
          `Restaurar backup de ${backupData.timestamp}?\n` +
          `${backupData.items.length} itens encontrados.\n` +
          `Isso substituir√° todos os dados atuais.`
        );
        
        if (!confirmar) {
          syncStatus.textContent = '‚ùå Restaura√ß√£o cancelada';
          setTimeout(() => syncStatus.classList.add('hide'), 3000);
          return;
        }
        
        // Limpar localStorage atual
        const result = window.storage.list('patrimonio:');
        result.keys.forEach(key => window.storage.delete(key));
        
        // Salvar novos itens
        let itensRestaurados = 0;
        let fotosRestauradas = 0;
        
        for (const item of backupData.items) {
          window.storage.set('patrimonio:' + item.id, JSON.stringify(item));
          itensRestaurados++;
          fotosRestauradas += (item.photos?.length || 0);
        }
        
        // Atualizar UI
        loadData();
        
        syncStatus.textContent = `‚úÖ Restaurado! ${itensRestaurados} itens`;
        setTimeout(() => syncStatus.classList.add('hide'), 5000);
        
        mostrarModalSync(`
          <div style="color: #28a745;">
            <h4>‚úÖ Restaura√ß√£o conclu√≠da!</h4>
            <p><strong>${itensRestaurados}</strong> itens restaurados</p>
            <p><strong>${fotosRestauradas}</strong> fotos recuperadas</p>
            <p><strong>${backupData.timestamp ? new Date(backupData.timestamp).toLocaleString('pt-BR') : 'Data desconhecida'}</strong></p>
            <p class="small">Usu√°rio original: ${backupData.user || 'Desconhecido'}</p>
          </div>
        `);
        
        return itensRestaurados;
        
      } catch (error) {
        syncStatus.textContent = '‚ùå Erro na restaura√ß√£o';
        console.error('Erro ao carregar backup:', error);
        mostrarModalSync(`
          <div style="color: #dc3545;">
            <h4>‚ùå Erro na restaura√ß√£o</h4>
            <p>${error.message}</p>
            <p class="small">Verifique a URL e sua conex√£o.</p>
          </div>
        `);
        setTimeout(() => syncStatus.classList.add('hide'), 5000);
        return 0;
      }
    }

    function calcularEstatisticas() {
      const result = window.storage.list('patrimonio:');
      const keys = result.keys || [];
      let totalFotosCount = 0;
      let totalItens = 0;
      
      for (const key of keys) {
        const res = window.storage.get(key);
        if (res && res.value) {
          const item = JSON.parse(res.value);
          totalItens++;
          if (item.photos) {
            totalFotosCount += item.photos.length;
          }
        }
      }
      
      // Estimativa de armazenamento (100KB por foto otimizada)
      const estimativaMB = (totalFotosCount * 100) / 1024;
      const estimativaGB = estimativaMB / 1024;
      
      return {
        totalItens,
        totalFotos: totalFotosCount,
        estimativaMB,
        estimativaGB
      };
    }

    function atualizarEstatisticasUI() {
      const stats = calcularEstatisticas();
      totalFotos.textContent = `${stats.totalFotos} fotos`;
      
      // Atualizar tamb√©m no contador do header
      const lastBackupTime = localStorage.getItem('last_backup_time');
      if (lastBackupTime) {
        const timeStr = new Date(lastBackupTime).toLocaleString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        syncStatus.innerHTML = `üìä ${stats.totalItens} itens | üì∑ ${stats.totalFotos} fotos | üîÑ ${timeStr}`;
      }
    }

    function mostrarModalSync(content) {
      syncInfo.innerHTML = content;
      modalSync.classList.remove('hide');
    }

    /* ================= GEST√ÉO DE FOTOS ================= */
    function addTempPhotoUrl(url) {
      if (tempPhotos.length >= MAX_PHOTOS_PER_ITEM) {
        alert(`‚ö† Limite de ${MAX_PHOTOS_PER_ITEM} fotos por item atingido!`);
        return false;
      }
      tempPhotos.push(url);
      renderPhotoPreview();
      return true;
    }

    function renderPhotoPreview() {
      photoPreview.innerHTML = '';
      photoCounter.textContent = `${tempPhotos.length}/${MAX_PHOTOS_PER_ITEM} fotos`;
      
      if (tempPhotos.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'small muted';
        emptyMsg.textContent = 'Nenhuma foto adicionada';
        emptyMsg.style.width = '100%';
        photoPreview.appendChild(emptyMsg);
        return;
      }
      
      tempPhotos.forEach((url, idx) => {
        const div = document.createElement('div');
        div.className = 'item';
        
        const img = document.createElement('img');
        img.src = url;
        img.loading = 'lazy';
        
        const btn = document.createElement('button');
        btn.className = 'photo-remove';
        btn.innerText = '√ó';
        btn.title = 'Remover';
        btn.addEventListener('click', ()=> {
          tempPhotos.splice(idx, 1);
          renderPhotoPreview();
        });
        
        div.appendChild(img);
        div.appendChild(btn);
        photoPreview.appendChild(div);
      });
    }

    /* ================= AUTENTICA√á√ÉO ================= */
    function showLogin() {
      document.getElementById('loginBox').classList.remove('hide');
      formArea.classList.add('hide');
    }
    
    function showAppUI() {
      document.getElementById('loginBox').classList.add('hide');
      formArea.classList.remove('hide');
      document.getElementById('currentUser').textContent = currentUser;
      currentUserBox.classList.remove('hide');
      btnLogout.classList.remove('hide');
      btnOpenLogin.classList.add('hide');
      
      // Mostrar estat√≠sticas iniciais
      atualizarEstatisticasUI();
    }

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      if (users[user] && users[user] === pass) {
        currentUser = user;
        showAppUI();
        loadData();
      } else {
        loginError.textContent = 'Usu√°rio ou senha incorretos';
        loginError.classList.remove('hide');
        setTimeout(()=>loginError.classList.add('hide'),3000);
      }
    });

    document.getElementById('btnFillDemo').addEventListener('click', () => {
      document.getElementById('username').value = 'admin';
      document.getElementById('password').value = 'admin123';
    });

    btnLogout.addEventListener('click', () => {
      currentUser = null;
      currentUserBox.classList.add('hide');
      btnLogout.classList.add('hide');
      btnOpenLogin.classList.remove('hide');
      showLogin();
    });

    /* ================= UPLOAD DE FOTOS ================= */
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      let uploaded = 0;
      
      for (const f of files) {
        if (tempPhotos.length >= MAX_PHOTOS_PER_ITEM) {
          alert(`Limite de ${MAX_PHOTOS_PER_ITEM} fotos atingido!`);
          break;
        }
        
        try {
          const url = await uploadToCloudinaryOtimizado(f);
          if (addTempPhotoUrl(url)) {
            uploaded++;
          }
        } catch (err) { 
          console.error('upload error', err);
          alert(`Erro ao enviar foto: ${f.name}`);
        }
      }
      
      fileInput.value = '';
      
      if (uploaded > 0) {
        uploadStatus.textContent = `+${uploaded} foto(s)`;
        setTimeout(() => uploadStatus.textContent = '', 2000);
      }
    });

    /* ================= C√ÇMERA ================= */
    btnOpenCamera.addEventListener('click', async () => {
      if (cameraStream) return;
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' }, 
          audio: false 
        });
        cameraVideo.srcObject = cameraStream;
        cameraModal.classList.remove('hide');
        cameraVideo.play();
        btnCapture.focus();
      } catch (err) {
        alert('Erro ao acessar c√¢mera: ' + (err.message || err));
      }
    });

    btnCloseCamera.addEventListener('click', stopCamera);
    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraStream = null;
      }
      cameraVideo.pause();
      cameraVideo.srcObject = null;
      cameraModal.classList.add('hide');
    }

    btnCapture.addEventListener('click', async () => {
      if (!cameraStream) return;
      if (tempPhotos.length >= MAX_PHOTOS_PER_ITEM) {
        alert(`Limite de ${MAX_PHOTOS_PER_ITEM} fotos atingido!`);
        return;
      }
      
      const track = cameraStream.getVideoTracks()[0];
      const imageCapture = new ImageCapture(track);
      
      try {
        const blob = await imageCapture.takePhoto();
        const url = await uploadToCloudinaryOtimizado(blob);
        addTempPhotoUrl(url);
      } catch (err) {
        // fallback via canvas
        try {
          const canvas = document.createElement('canvas');
          canvas.width = cameraVideo.videoWidth;
          canvas.height = cameraVideo.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
          const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.85));
          const url = await uploadToCloudinaryOtimizado(blob);
          addTempPhotoUrl(url);
        } catch(e) {
          console.error(e);
          alert('Erro ao capturar foto');
        }
      }
    });

    /* ================= CRUD ITEMS ================= */
    patrimonioForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) { 
        alert('Fa√ßa login para continuar'); 
        return; 
      }

      const item = {
        id: editingId || Date.now().toString(),
        numeroPatrimonio: numeroPatrimonio.value.trim(),
        equipamento: equipamento.value.trim(),
        setor: setor.value.trim(),
        modelo: modelo.value.trim(),
        configuracao: configuracao.value.trim(),
        photos: [...tempPhotos],
        history: [],
        createdBy: currentUser,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      // Preservar hist√≥rico se edi√ß√£o
      const existing = window.storage.get('patrimonio:' + item.id);
      if (existing && existing.value) {
        try {
          const parsed = JSON.parse(existing.value);
          item.history = parsed.history || [];
          item.createdBy = parsed.createdBy || currentUser;
          item.createdAt = parsed.createdAt || new Date().toISOString();
        } catch(e){}
      }

      window.storage.set('patrimonio:' + item.id, JSON.stringify(item));
      
      // Reset form
      editingId = null;
      patrimonioForm.reset();
      tempPhotos = [];
      renderPhotoPreview();
      renderFormDefault();
      
      // Carregar dados e mostrar
      loadData();
      viewItem(item.id);
      
      // Mostrar confirma√ß√£o
      uploadStatus.textContent = '‚úÖ Item salvo!';
      setTimeout(() => uploadStatus.textContent = '', 2000);
    });

    btnCancel.addEventListener('click', ()=> {
      patrimonioForm.reset();
      editingId = null;
      tempPhotos = [];
      renderPhotoPreview();
      renderFormDefault();
    });

    btnNew.addEventListener('click', ()=> {
      patrimonioForm.reset();
      editingId = null;
      tempPhotos = [];
      renderPhotoPreview();
      renderFormDefault();
      numeroPatrimonio.focus();
    });

    async function loadData() {
      const result = window.storage.list('patrimonio:');
      const keys = result.keys || [];
      patrimonioTable.innerHTML = '';
      totalCount.textContent = keys.length;
      
      if (keys.length === 0) {
        patrimonioTable.innerHTML = '<tr><td colspan="5" class="small muted">Nenhum item cadastrado</td></tr>';
        atualizarEstatisticasUI();
        return;
      }
      
      // Ordenar por n√∫mero de patrim√¥nio
      const items = [];
      for (const key of keys) {
        try {
          const res = window.storage.get(key);
          if (!res || !res.value) continue;
          const item = JSON.parse(res.value);
          items.push(item);
        } catch (err) {
          console.error('erro item', err);
        }
      }
      
      // Ordenar alfabeticamente por n√∫mero de patrim√¥nio
      items.sort((a, b) => {
        const numA = a.numeroPatrimonio || '';
        const numB = b.numeroPatrimonio || '';
        return numA.localeCompare(numB, undefined, {numeric: true, sensitivity: 'base'});
      });
      
      // Renderizar tabela
      items.forEach(item => {
        const tr = document.createElement('tr');

        const tdNum = document.createElement('td'); 
        tdNum.textContent = item.numeroPatrimonio || '-';
        
        const tdEquip = document.createElement('td'); 
        tdEquip.textContent = item.equipamento || '-';
        
        const tdSetor = document.createElement('td'); 
        tdSetor.textContent = item.setor || '-';
        
        const tdPhotos = document.createElement('td'); 
        tdPhotos.textContent = (item.photos && item.photos.length) ? 
          `${item.photos.length} üì∑` : '0';
        
        const tdActions = document.createElement('td');
        tdActions.className = 'actions';

        const btnView = document.createElement('button'); 
        btnView.className = 'btn btn-view'; 
        btnView.textContent = 'üëÅÔ∏è Ver';
        btnView.addEventListener('click', ()=> viewItem(item.id));
        
        const btnEdit = document.createElement('button'); 
        btnEdit.className = 'btn btn-edit'; 
        btnEdit.textContent = '‚úèÔ∏è Editar';
        btnEdit.addEventListener('click', ()=> editItem(item.id));
        
        const btnHistory = document.createElement('button'); 
        btnHistory.className = 'btn'; 
        btnHistory.textContent = 'üìú Hist';
        btnHistory.addEventListener('click', ()=> openHistory(item.id));
        
        const btnDel = document.createElement('button'); 
        btnDel.className = 'btn btn-del'; 
        btnDel.textContent = 'üóëÔ∏è Excluir';
        btnDel.addEventListener('click', ()=> {
          if (confirm(`Excluir "${item.equipamento}" (${item.numeroPatrimonio})?`)) {
            window.storage.delete('patrimonio:' + item.id);
            loadData();
            viewBox.innerHTML = '<div class="small muted">Item removido</div>';
            atualizarEstatisticasUI();
          }
        });

        tdActions.appendChild(btnView);
        tdActions.appendChild(btnEdit);
        tdActions.appendChild(btnHistory);
        tdActions.appendChild(btnDel);

        tr.appendChild(tdNum);
        tr.appendChild(tdEquip);
        tr.appendChild(tdSetor);
        tr.appendChild(tdPhotos);
        tr.appendChild(tdActions);

        patrimonioTable.appendChild(tr);
      });
      
      atualizarEstatisticasUI();
    }

    function viewItem(id) {
      try {
        const res = window.storage.get('patrimonio:' + id);
        if (!res || !res.value) { 
          viewBox.innerHTML = '<div class="small muted">Item n√£o encontrado</div>'; 
          return; 
        }
        
        const item = JSON.parse(res.value);
        let html = `<div style="display:flex;gap:14px;align-items:flex-start">
                      <div style="flex:1">
                        <p><strong>N¬∫ Patrim√¥nio:</strong> ${escapeHtml(item.numeroPatrimonio)}</p>
                        <p><strong>Equipamento:</strong> ${escapeHtml(item.equipamento)}</p>
                        <p><strong>Setor:</strong> ${escapeHtml(item.setor)}</p>
                        <p><strong>Modelo:</strong> ${escapeHtml(item.modelo || '-')}</p>
                        <p><strong>Configura√ß√£o:</strong> ${escapeHtml(item.configuracao || '-')}</p>
                        <p class="small muted">Cadastrado por: ${escapeHtml(item.createdBy || 'admin')} em ${formatDate(item.createdAt)}</p>
                      </div>
                      <div style="width:260px">
                        <strong>Fotos (${item.photos?.length || 0})</strong>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">`;
        
        if (item.photos && item.photos.length) {
          item.photos.forEach((url, index) => {
            html += `
              <div style="position:relative">
                <a href="${url}" target="_blank" style="display:block;width:80px;height:60px;border-radius:6px;overflow:hidden">
                  <img src="${url}" style="width:100%;height:100%;object-fit:cover" loading="lazy">
                </a>
                <div class="small" style="text-align:center">${index + 1}</div>
              </div>`;
          });
        } else {
          html += `<div class="small muted">Sem fotos</div>`;
        }
        
        html += `</div></div></div>`;
        
        // Hist√≥rico resumido
        html += `<div style="margin-top:12px"><strong>√öltimas manuten√ß√µes</strong>`;
        if (item.history && item.history.length) {
          html += `<ul style="margin-top:8px">`;
          item.history.slice(0, 5).forEach(h => {
            html += `<li class="small">${escapeHtml(formatDate(h.date))} - ${escapeHtml(h.description)}</li>`;
          });
          html += `</ul>`;
        } else {
          html += `<div class="small muted" style="margin-top:8px">Nenhuma manuten√ß√£o registrada</div>`;
        }
        html += `</div>`;
        
        viewBox.innerHTML = html;
      } catch (err) {
        console.error(err);
        viewBox.innerHTML = '<div class="small muted">Erro ao abrir item</div>';
      }
    }

    function editItem(id) {
      const res = window.storage.get('patrimonio:' + id);
      if (!res || !res.value) return alert('Item n√£o encontrado');
      const item = JSON.parse(res.value);
      editingId = id;
      numeroPatrimonio.value = item.numeroPatrimonio || '';
      equipamento.value = item.equipamento || '';
      setor.value = item.setor || '';
      modelo.value = item.modelo || '';
      configuracao.value = item.configuracao || '';
      tempPhotos = (item.photos && item.photos.slice()) || [];
      renderPhotoPreview();
      document.getElementById('formTitle').textContent = '‚úèÔ∏è Editar item';
      formArea.classList.remove('hide');
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function renderFormDefault(){
      document.getElementById('formTitle').textContent = '‚ûï Adicionar item';
    }

    /* ================= HIST√ìRICO ================= */
    let historyEditingId = null;
    
    function openHistory(id) {
      const res = window.storage.get('patrimonio:' + id);
      if (!res || !res.value) return alert('Item n√£o encontrado');
      const item = JSON.parse(res.value);
      historyEditingId = id;
      
      // Preencher hist√≥rico
      historyContent.innerHTML = '';
      if (item.history && item.history.length) {
        item.history.forEach(h => {
          const div = document.createElement('div');
          div.style.borderLeft = '4px solid var(--primary)';
          div.style.padding = '8px';
          div.style.marginBottom = '8px';
          div.innerHTML = `<strong>${escapeHtml(formatDate(h.date))}</strong><div class="small">${escapeHtml(h.description)}</div>`;
          historyContent.appendChild(div);
        });
      } else {
        historyContent.innerHTML = '<div class="small muted">Nenhuma manuten√ß√£o registrada</div>';
      }
      
      modalHistory.classList.remove('hide');
      maintenanceDate.value = new Date().toISOString().split('T')[0];
      maintenanceDescription.focus();
    }

    closeHistory.addEventListener('click', ()=> {
      modalHistory.classList.add('hide');
      historyEditingId = null;
      maintenanceForm.reset();
    });

    maintenanceForm.addEventListener('submit', async (e)=> {
      e.preventDefault();
      if (!historyEditingId) return;
      const date = maintenanceDate.value;
      const desc = maintenanceDescription.value.trim();
      if (!date || !desc) return alert('Preencha data e descri√ß√£o');
      const res = window.storage.get('patrimonio:' + historyEditingId);
      const item = JSON.parse(res.value);
      item.history = item.history || [];
      item.history.unshift({ 
        date, 
        description: desc, 
        timestamp: Date.now(),
        addedBy: currentUser 
      });
      window.storage.set('patrimonio:' + historyEditingId, JSON.stringify(item));
      maintenanceForm.reset();
      openHistory(historyEditingId);
      loadData();
    });

    /* ================= SINCRONIZA√á√ÉO ================= */
    btnSyncUp.addEventListener('click', salvarBackupNaNuvem);
    btnSyncDown.addEventListener('click', carregarBackupDaNuvem);
    closeSync.addEventListener('click', () => modalSync.classList.add('hide'));

    // Backup autom√°tico a cada 10 minutos se houver mudan√ßas
    let lastItemCount = 0;
    setInterval(() => {
      if (!currentUser) return;
      
      const stats = calcularEstatisticas();
      if (stats.totalItens > 0 && stats.totalItens !== lastItemCount) {
        lastItemCount = stats.totalItens;
        // Backup silencioso (n√£o mostrar UI)
        salvarBackupNaNuvem().catch(() => {
          // Silenciar erro no backup autom√°tico
        });
      }
    }, 10 * 60 * 1000); // 10 minutos

    /* ================= UTILIDADES ================= */
    function formatDate(dateString){
      try {
        const d = new Date(dateString);
        return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR').substring(0, 5);
      } catch { 
        return dateString; 
      }
    }

    function escapeHtml(str){
      if (!str && str !== 0) return '';
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    /* ================= INICIALIZA√á√ÉO ================= */
    window.addEventListener('DOMContentLoaded', () => {
      // For√ßar fechamento de modais
      if (!modalHistory.classList.contains('hide')) {
        modalHistory.classList.add('hide');
      }
      if (!modalSync.classList.contains('hide')) {
        modalSync.classList.add('hide');
      }
      
      // Mostrar √∫ltima sincroniza√ß√£o se existir
      const lastBackupTime = localStorage.getItem('last_backup_time');
      if (lastBackupTime) {
        const timeStr = new Date(lastBackupTime).toLocaleString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        syncStatus.textContent = `√öltimo backup: ${timeStr}`;
        syncStatus.classList.remove('hide');
      }
      
      // Inicializar UI
      showLogin();
      renderFormDefault();
      loadData();
    });

    /* ================= PWA ================= */
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install', event => { 
          self.skipWaiting(); 
          console.log('Service Worker instalado');
        });
        self.addEventListener('activate', event => { 
          event.waitUntil(self.clients.claim()); 
          console.log('Service Worker ativado');
        });
        self.addEventListener('fetch', event => {
          // Cache estrat√©gico para assets est√°ticos
          if (event.request.url.includes('cloudinary.com')) {
            event.respondWith(
              caches.match(event.request).then(response => {
                return response || fetch(event.request);
              })
            );
          }
        });
      `;
      try {
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl)
          .then(reg => console.log('SW registrado:', reg))
          .catch(err => console.log('SW erro:', err));
      } catch(e){
        console.log('SW falhou:', e);
      }
    }

    /* ================= FIM ================= */
    console.log('‚úÖ Sistema Patrim√¥nio carregado com otimiza√ß√µes Cloudinary!');
  </script>
</body>
</html>
